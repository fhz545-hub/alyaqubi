# تطبيق رصد (بدون إنترنت) – ثانوية اليعقوبي الثانوية

هذا المشروع PWA يعمل على الجوال والكمبيوتر، ويخزن البيانات محليًا (IndexedDB) ويتيح:
- بحث الطالب بالاسم أو رقم الهوية (لا تظهر الأسماء إلا بعد البحث)
- تسجيل **تأخر / غياب / سلوك**
- طباعة **كشوف A4** للصف/الشعبة + **باركود رقم الهوية**
- طباعة **بطاقات** (A4) + **كرت طالب صغير**
- إرسال **واتساب** (فتح محادثة جاهزة)
- إرسال **SMS** عبر Proxy وسيط (Cloudflare Worker) لحماية توكن مزود الرسائل
- تصدير/استيراد **نسخة احتياطية** كاملة

---

## 1) التشغيل السريع (على الكمبيوتر)

1) فك ضغط المشروع.
2) افتح Terminal داخل مجلد المشروع ثم:
```bash
python3 -m http.server 8080
```
3) افتح:
- http://localhost:8080

> ملاحظة: Service Worker يعمل على `localhost` أو HTTPS فقط.

---

## 2) النشر والتثبيت على الجوال (PWA)

### خيار موصى به: GitHub Pages
1) ارفع ملفات المشروع إلى مستودع GitHub.
2) فعّل GitHub Pages من إعدادات المستودع.
3) افتح الرابط على الجوال.

### التثبيت على iPhone
- افتح الرابط في Safari
- Share → Add to Home Screen

### التثبيت على Android
- افتح الرابط في Chrome
- Install app / Add to Home screen

---

## 3) البيانات والخصوصية
- بيانات الطلاب الأساسية يتم استيرادها من `assets/students_seed.json` عند أول تشغيل.
- السجلات (مواظبة/سلوك) تحفظ **محليًا** على الجهاز.
- للنسخ الاحتياطي: الإعدادات → **تصدير نسخة احتياطية**.
- للنقل بين الأجهزة: صدّر من جهاز ثم استورد في جهاز آخر.

---

## 4) الطباعة
من تبويب **طباعة**:
- اختر الصف والشعبة
- اختر الفصل الدراسي + العام الهجري
- اطبع:
  - كشف تأخر (A4)
  - كشف غياب (A4)
  - بطاقات مواظبة (A4)
  - بطاقات سلوك (A4)

> الكشوف تتضمن أيام: الأحد → الخميس + باركود الهوية لكل طالب.

---

## 5) إعداد SMS بشكل آمن (Cloudflare Worker Proxy)

### الفكرة
لا تضع توكن مزود الرسائل داخل التطبيق.
بدلاً من ذلك:
- التطبيق يرسل إلى Worker: `to + message + sender + appKey`
- Worker يرسل للمزود باستخدام التوكن المخزن كـ Secret

### ملف الـ Worker
الملف: `cloudflare_worker_sms_proxy.js`

### إعدادات Cloudflare
1) Workers & Pages → Create Worker
2) الصق محتوى الملف `cloudflare_worker_sms_proxy.js` ثم Deploy
3) من Settings → Variables:
   - **Secrets**
     - `MOBILE_TOKEN` = توكن مزود الرسائل
     - `APP_KEY` = مفتاح داخلي تختاره (مثال: YAQUBI-2026-SEC)
   - **Variables**
     - `SMS_SEND_URL` = رابط الإرسال لدى المزود (الـ endpoint الكامل)
       - مثال شائع: `https://app.mobile.net.sa/api/v1/messages` (قد يختلف حسب حسابك)
     - `ALLOWED_ORIGINS` (اختياري) = نطاقات مسموحة مفصولة بفواصل
       - مثال: `https://<username>.github.io,https://<custom-domain>`

4) اختبار سريع:
- افتح: `https://YOUR-WORKER.workers.dev/health`  
يجب أن يرجع `{ ok: true }`

### ربطه داخل التطبيق
في **الإعدادات** داخل التطبيق:
- Proxy URL = `https://YOUR-WORKER.workers.dev`
- App Key = نفس `APP_KEY` الذي وضعته في Cloudflare
- Sender (اختياري) = اسم المرسل حسب المزود

> إن كان مزودك يحتاج صيغة مختلفة للطلب، عدّل دالة `forwardToProvider()` داخل Worker فقط.

---

## 6) استيراد طلاب من CSV (اختياري)
من الإعدادات → **استيراد طلاب من CSV**.

أسماء الأعمدة المقبولة (يكفي وجود الاسم + الهوية):
- `اسم الطالب`
- `رقم الهوية` أو `رقم الطالب`
- `الجوال`
- `رقم الصف`
- `الفصل` (أو الشعبة)

> ملاحظة: الباركود التلقائي مرفق لملف الطلاب الأساسي (600).  
الطلاب المستوردون من CSV قد لا يظهر لهم باركود إلا إذا وفّرته في المصدر أو اعتمدت إعادة استيراد ملف الطلاب الأساسي.

---

## 7) ملاحظات مهمة
- الأفضل تشغيل التطبيق على جهاز مسؤول واحد داخل المدرسة، مع تصدير نسخة احتياطية بشكل دوري.
- إرسال واتساب بالجملة غير عملي داخل المتصفح؛ التطبيق يفتح محادثة فردية لكل طالب.
- إرسال SMS بالجملة ممكن عبر الـ Worker (تطوير لاحق)، ويُنصح بضبط حدود المعدل حسب المزود.