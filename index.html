<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b7e88"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ - ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„"/>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</title>

  <style>
    :root{
      --moe:#0b7e88;
      --moe2:#18a27e;
      --ink:#0f2e2b;
      --muted:#607a78;
      --bg:#f6fafb;
      --card:#ffffff;
      --line:#e6eeee;
      --danger:#b42318;
      --warn:#b54708;
      --ok:#027a48;
      --shadow: 0 10px 30px rgba(10,40,38,.08);
      --r:18px;
      --tap:44px;
      --maxW:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Arial}
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}
    .app{max-width:var(--maxW);margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    .topbar{
      position:sticky;top:0;z-index:50;background:rgba(246,250,251,.92);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:12px 12px 10px;
    }
    .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,var(--moe),#0aa5a5);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);
    }
    .title{display:flex;flex-direction:column;line-height:1.2}
    .title b{font-size:15px}
    .title span{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    .iconbtn{
      width:44px;height:44px;border-radius:16px;border:1px solid var(--line);
      background:var(--card);display:grid;place-items:center;cursor:pointer;
      box-shadow: 0 6px 18px rgba(10,40,38,.06);
    }
    .iconbtn:active{transform:scale(.98)}
    .content{flex:1;padding:12px 12px 84px}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){ .grid.cols2{grid-template-columns:1.25fr .75fr} }

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      box-shadow:var(--shadow);padding:14px;
    }
    .card h3{margin:0 0 10px;font-size:14px}
    .sub{color:var(--muted);font-size:12.5px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.between{justify-content:space-between}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fbfefe;font-size:12.5px;color:var(--muted)
    }
    .pill b{color:var(--ink)}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (min-width:520px){ .kpis{grid-template-columns:repeat(4,1fr)} }
    .kpi{
      border:1px solid var(--line);border-radius:16px;padding:10px;background:#fbfefe;
    }
    .kpi .n{font-size:18px;font-weight:800}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi.ok{border-color:rgba(2,122,72,.25)}
    .kpi.warn{border-color:rgba(181,71,8,.25)}
    .kpi.danger{border-color:rgba(180,35,24,.25)}

    .btn{
      height:var(--tap);border-radius:16px;border:1px solid var(--line);
      background:var(--card);padding:0 14px;cursor:pointer;font-weight:700;
      display:inline-flex;align-items:center;gap:10px;
    }
    .btn.primary{background:linear-gradient(135deg,var(--moe),#0aa5a5);border-color:transparent;color:#fff}
    .btn.ghost{background:transparent}
    .btn:active{transform:scale(.99)}
    .btn.small{height:38px;border-radius:14px;font-size:13px}
    .btn.danger{background:#fff;border-color:rgba(180,35,24,.35);color:var(--danger)}
    .btn.ok{background:#fff;border-color:rgba(2,122,72,.35);color:var(--ok)}

    .field{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      height:44px;border-radius:14px;border:1px solid var(--line);padding:0 12px;
      background:#fff;outline:none;
    }
    textarea{height:auto;min-height:88px;padding:10px 12px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(11,126,136,.45);box-shadow:0 0 0 4px rgba(11,126,136,.08)}
    .hint{font-size:12px;color:var(--muted)}

    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .item{
      border:1px solid var(--line);border-radius:16px;background:#fff;padding:10px 12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .item .meta{display:flex;flex-direction:column;gap:2px}
    .item .meta b{font-size:13.5px}
    .item .meta span{font-size:12px;color:var(--muted)}
    .tag{
      font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--line);background:#fbfefe;color:var(--muted)
    }
    .tag.ok{border-color:rgba(2,122,72,.25);color:var(--ok)}
    .tag.warn{border-color:rgba(181,71,8,.25);color:var(--warn)}
    .tag.danger{border-color:rgba(180,35,24,.25);color:var(--danger)}

    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:16px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:700px;background:#fff}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:12.8px;white-space:nowrap;text-align:right}
    th{position:sticky;top:0;background:#fbfefe;z-index:1;color:var(--muted);font-weight:800}
    tr:hover td{background:#fcffff}

    .nav{
      position:fixed;left:0;right:0;bottom:0;z-index:60;
      background:rgba(255,255,255,.92);backdrop-filter:blur(12px);
      border-top:1px solid var(--line);
      padding:8px max(10px, env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
    }
    .navbar{max-width:var(--maxW);margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .tab{
      height:56px;border-radius:18px;border:1px solid transparent;background:transparent;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
      cursor:pointer;color:var(--muted);
    }
    .tab b{font-size:11px}
    .tab.active{background:#f0fbfb;border-color:rgba(11,126,136,.22);color:var(--moe)}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--moe);opacity:0}
    .tab.active .dot{opacity:1}
    .ico{font-size:18px;line-height:1}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(10,20,20,.45);display:none;align-items:flex-end;justify-content:center;z-index:100}
    .modalBack.show{display:flex}
    .modal{
      width:min(980px, 100%);background:#fff;border-radius:22px 22px 0 0;
      border:1px solid var(--line);box-shadow: 0 -20px 60px rgba(0,0,0,.18);
      padding:14px 12px 12px;
      max-height:88vh;overflow:auto;
    }
    @media (min-width:900px){
      .modalBack{align-items:center}
      .modal{border-radius:22px;max-height:86vh}
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .modalHead b{font-size:14px}
    .close{width:44px;height:44px;border-radius:16px;border:1px solid var(--line);background:#fff;cursor:pointer}

    .split{display:grid;gap:10px}
    @media (min-width:900px){ .split{grid-template-columns:1fr 1fr} }

    .notice{
      border:1px dashed rgba(11,126,136,.35);
      background:#f3fffe;border-radius:16px;padding:10px 12px;color:var(--muted);font-size:12.5px
    }
    .hr{height:1px;background:var(--line);margin:10px 0}

    .empty{padding:16px;border:1px dashed var(--line);border-radius:16px;background:#fbfefe;color:var(--muted);font-size:13px}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="toprow">
        <div class="brand">
          <div class="logo">Ù…</div>
          <div class="title">
            <b id="schoolName">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</b>
            <span id="todayLine">â€”</span>
          </div>
        </div>
        <div class="actions">
          <button class="iconbtn" id="btnQuickAdd" title="ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹">ï¼‹</button>
          <button class="iconbtn" id="btnBackup" title="Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ">â­³</button>
          <button class="iconbtn" id="btnHelp" title="Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">ØŸ</button>
        </div>
      </div>
    </div>

    <div class="content">

      <!-- Dashboard -->
      <section id="view-dashboard" class="grid cols2">
        <div class="card">
          <div class="row between">
            <div>
              <h3>Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h3>
              <div class="sub">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ Ø¨Ø³Ø±Ø¹Ø©ØŒ Ù…Ø¹ Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø©.</div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnAddAttendance">ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ§Ø¸Ø¨Ø©</button>
              <button class="btn" id="btnAddBehavior">ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙˆÙƒ</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpis" id="kpis"></div>

          <div class="hr"></div>
          <div class="row">
            <div class="pill"><span>ğŸ“Œ</span><b>ØªÙ†Ø¨ÙŠÙ‡ ØªØ±Ø¨ÙˆÙŠ:</b> <span>Ø§Ø³ØªØ®Ø¯Ù… â€œÙ…Ù„Ø§Ø­Ø¸Ø©â€ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§ØªØµØ§Ù„/Ø§Ø³ØªØ¯Ø¹Ø§Ø¡/ØªØ¹Ù‡Ø¯) Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</span></div>
          </div>
        </div>

        <div class="card">
          <h3>Ø·Ù„Ø§Ø¨ Ø¨Ø­Ø§Ø¬Ø© Ù…ØªØ§Ø¨Ø¹Ø©</h3>
          <div class="sub">Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ù‹Ø§ ÙÙŠ (Ø§Ù„ØºÙŠØ§Ø¨/Ø§Ù„ØªØ£Ø®Ø±/Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª) Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§.</div>
          <div class="list" id="needFollow"></div>
          <div id="needFollowEmpty" class="empty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø±ØªÙØ¹Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>
        </div>
      </section>

      <!-- Attendance -->
      <section id="view-attendance" style="display:none" class="grid">
        <div class="card">
          <div class="row between">
            <div>
              <h3>Ù…ÙˆØ§Ø¸Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
              <div class="sub">ØºÙŠØ§Ø¨ / ØªØ£Ø®Ø± / Ø§Ø³ØªØ¦Ø°Ø§Ù† / ØºÙŠØ§Ø¨ Ø­ØµØ© â€” Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ.</div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnAddAttendance2">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
              <button class="btn" id="btnExportAttendance">ØªØµØ¯ÙŠØ± CSV</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field" style="max-width:220px">
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="attFrom">
            </div>
            <div class="field" style="max-width:220px">
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="attTo">
            </div>
            <div class="field">
              <label>ØªØµÙÙŠØ©</label>
              <input id="attSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„...">
            </div>
            <button class="btn small ok" id="btnApplyAtt">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn small" id="btnResetAtt">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>

          <div class="hr"></div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø­ØµØ©</th>
                  <th>Ø§Ù„Ø³Ø¨Ø¨/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody id="attTable"></tbody>
            </table>
          </div>
          <div id="attEmpty" class="empty" style="display:none;margin-top:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
        </div>
      </section>

      <!-- Behavior -->
      <section id="view-behavior" style="display:none" class="grid">
        <div class="card">
          <div class="row between">
            <div>
              <h3>Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
              <div class="sub">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©/Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù…Ø¹ Ù…Ø³ØªÙˆÙ‰ ÙˆØªØ¯Ø±Ø¬ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnAddBehavior2">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
              <button class="btn" id="btnExportBehavior">ØªØµØ¯ÙŠØ± CSV</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field" style="max-width:220px">
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="behFrom">
            </div>
            <div class="field" style="max-width:220px">
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="behTo">
            </div>
            <div class="field">
              <label>ØªØµÙÙŠØ©</label>
              <input id="behSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡...">
            </div>
            <button class="btn small ok" id="btnApplyBeh">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn small" id="btnResetBeh">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>

          <div class="hr"></div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</th>
                  <th>Ø§Ù„ÙØ¦Ø©</th>
                  <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                </tr>
              </thead>
              <tbody id="behTable"></tbody>
            </table>
          </div>
          <div id="behEmpty" class="empty" style="display:none;margin-top:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
        </div>
      </section>

      <!-- Students -->
      <section id="view-students" style="display:none" class="grid">
        <div class="card">
          <div class="row between">
            <div>
              <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
              <div class="sub">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ + Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ + Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV.</div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnAddStudent">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
              <button class="btn" id="btnImportStudents">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
              <button class="btn danger" id="btnClearAll">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Ø¨Ø­Ø«</label>
              <input id="stuSearch" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ / Ø±Ù‚Ù… / Ø§Ù„ØµÙ / Ø§Ù„ÙØµÙ„...">
            </div>
            <button class="btn small ok" id="btnApplyStu">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn small" id="btnResetStu">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>

          <div class="list" id="stuList"></div>
          <div id="stuEmpty" class="empty" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø·Ø§Ù„Ø¨Ù‹Ø§ Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù CSV.</div>

          <div class="hr"></div>
          <div class="notice">
            <b>ØµÙŠØºØ© CSV Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</b>
            <div class="hint" style="margin-top:6px;direction:ltr;text-align:left">
              student_id,name,grade,class,section,guardian,phone
            </div>
            <div class="hint">Ù…Ø«Ø§Ù„: 1148961236,Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯,Ø§Ù„Ø«Ø§Ù„Ø«,3,Ø£,ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±,05xxxxxxxx</div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section id="view-settings" style="display:none" class="grid">
        <div class="card">
          <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
          <div class="sub">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© â€“ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„ÙˆÙƒ â€“ ÙØªØ±Ø§Øª Ø§Ù„Ø­ØµØµ â€“ Ø­ÙØ¸/Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>

          <div class="hr"></div>

          <div class="split">
            <div class="card" style="box-shadow:none">
              <h3 style="margin-top:0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
              <div class="row">
                <div class="field">
                  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                  <input id="setSchoolName" placeholder="Ù…Ø«Ø§Ù„: Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ">
                </div>
                <div class="field" style="max-width:240px">
                  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                  <select id="setPeriods">
                    <option>6</option><option>7</option><option>8</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="btnSaveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
              </div>
            </div>

            <div class="card" style="box-shadow:none">
              <h3 style="margin-top:0">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
              <div class="row">
                <button class="btn" id="btnDownloadBackup">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© (JSON)</button>
                <button class="btn" id="btnRestoreBackup">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
              </div>
              <div class="hr"></div>
              <div class="notice">
                <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØªØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="card" style="box-shadow:none">
            <h3 style="margin-top:0">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</h3>
            <div class="sub">ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø­Ø³Ø¨ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</div>
            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>ÙØ¦Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒ (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label>
                <input id="setBehCats" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø®Ø§Ù„ÙØ© Ø§Ù†Ø¶Ø¨Ø§Ø·ÙŠØ©, Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©, Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ">
              </div>
              <div class="field">
                <label>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label>
                <input id="setActions" placeholder="Ù…Ø«Ø§Ù„: ØªÙ†Ø¨ÙŠÙ‡ Ø´ÙÙ‡ÙŠ, Ø¥Ø´Ø¹Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±, Ø§Ø³ØªØ¯Ø¹Ø§Ø¡, ØªØ¹Ù‡Ø¯, Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø±Ø´Ø¯">
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn ok" id="btnSaveLists">Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</button>
            </div>
          </div>

        </div>
      </section>

    </div>

    <!-- Bottom Nav -->
    <div class="nav">
      <div class="navbar">
        <button class="tab active" data-go="dashboard"><div class="ico">ğŸ </div><b>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b><div class="dot"></div></button>
        <button class="tab" data-go="attendance"><div class="ico">ğŸ•˜</div><b>Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©</b><div class="dot"></div></button>
        <button class="tab" data-go="behavior"><div class="ico">âš‘</div><b>Ø§Ù„Ø³Ù„ÙˆÙƒ</b><div class="dot"></div></button>
        <button class="tab" data-go="students"><div class="ico">ğŸ‘¥</div><b>Ø§Ù„Ø·Ù„Ø§Ø¨</b><div class="dot"></div></button>
        <button class="tab" data-go="settings"><div class="ico">âš™ï¸</div><b>Ø§Ù„Ø¶Ø¨Ø·</b><div class="dot"></div></button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <b id="modalTitle">â€”</b>
        <button class="close" id="modalClose">âœ•</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
/* ===================== State ===================== */
const LS_KEY = "attendance_behavior_pwa_v1";
const nowISO = () => new Date().toISOString();
const todayISODate = () => new Date().toISOString().slice(0,10);

function defaultState(){
  return {
    school: { name: "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ" },
    settings: {
      periods: 7,
      behaviorCategories: ["Ù…Ø®Ø§Ù„ÙØ© Ø§Ù†Ø¶Ø¨Ø§Ø·ÙŠØ©","Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©","Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ"],
      actions: ["ØªÙ†Ø¨ÙŠÙ‡ Ø´ÙÙ‡ÙŠ","Ø¥Ø´Ø¹Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±","Ø§Ø³ØªØ¯Ø¹Ø§Ø¡","ØªØ¹Ù‡Ø¯","Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø±Ø´Ø¯/Ø§Ù„Ù„Ø¬Ù†Ø©"]
    },
    students: [],
    attendance: [],
    behavior: []
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return {...defaultState(), ...s, school:{...defaultState().school, ...(s.school||{})}, settings:{...defaultState().settings, ...(s.settings||{})}};
  }catch(e){ return defaultState(); }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
let state = loadState();

/* ===================== Helpers ===================== */
function uid(prefix="id"){
  return prefix+"_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
}
function fmtHijri(d=new Date()){
  try{
    const f = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura",{weekday:"long",year:"numeric",month:"2-digit",day:"2-digit"});
    return f.format(d);
  }catch(e){
    return d.toLocaleDateString("ar-SA");
  }
}
function fmtGreg(d=new Date()){
  return d.toLocaleDateString("ar-SA",{year:"numeric",month:"2-digit",day:"2-digit"});
}
function byId(id){ return document.getElementById(id); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function download(filename, content, type="application/json"){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}
function toCSV(rows){
  const escCSV = (v) => {
    const s = (v??"").toString();
    if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  return rows.map(r => r.map(escCSV).join(",")).join("\n");
}
function parseCSV(text){
  // CSV Ø¨Ø³ÙŠØ· (ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬)
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if(inQ){
      if(c === '"' && n === '"'){ cur += '"'; i++; }
      else if(c === '"'){ inQ = false; }
      else cur += c;
    } else {
      if(c === '"'){ inQ = true; }
      else if(c === ","){ row.push(cur); cur=""; }
      else if(c === "\n"){ row.push(cur); rows.push(row); row=[]; cur=""; }
      else if(c === "\r"){ /* ignore */ }
      else cur += c;
    }
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.some(x => (x??"").trim() !== ""));
}
function withinRange(dateISO, fromISO, toISO){
  if(fromISO && dateISO < fromISO) return false;
  if(toISO && dateISO > toISO) return false;
  return true;
}
function studentLabel(stu){
  const g = stu.grade ? `Ø§Ù„ØµÙ ${stu.grade}` : "â€”";
  const c = stu.class ? `Ù${stu.class}` : "";
  const s = stu.section ? `(${stu.section})` : "";
  return `${g} ${c} ${s}`.replace(/\s+/g," ").trim();
}
function getStudent(id){ return state.students.find(s=>s.id===id); }

/* ===================== Router ===================== */
const views = ["dashboard","attendance","behavior","students","settings"];
function go(view){
  views.forEach(v=>{
    byId(`view-${v}`).style.display = (v===view) ? "" : "none";
  });
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.go === view);
  });
  if(view==="dashboard") renderDashboard();
  if(view==="attendance") renderAttendance();
  if(view==="behavior") renderBehavior();
  if(view==="students") renderStudents();
  if(view==="settings") renderSettings();
}

/* ===================== Modal ===================== */
const modalBack = byId("modalBack");
const modalTitle = byId("modalTitle");
const modalBody = byId("modalBody");
function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalBack.classList.add("show");
}
function closeModal(){
  modalBack.classList.remove("show");
  modalBody.innerHTML = "";
}
byId("modalClose").addEventListener("click", closeModal);
modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

/* ===================== Rendering ===================== */
function setHeader(){
  byId("schoolName").textContent = state.school.name || "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ";
  byId("todayLine").textContent = `${fmtHijri(new Date())} â€” ${fmtGreg(new Date())}`;
}
function renderDashboard(){
  setHeader();

  const today = todayISODate();
  const attToday = state.attendance.filter(a=>a.date===today);
  const behToday = state.behavior.filter(b=>b.date===today);

  const absent = attToday.filter(a=>a.type==="ØºÙŠØ§Ø¨").length;
  const late = attToday.filter(a=>a.type==="ØªØ£Ø®Ø±").length;
  const excuse = attToday.filter(a=>a.type==="Ø§Ø³ØªØ¦Ø°Ø§Ù†").length;
  const periodAbs = attToday.filter(a=>a.type==="ØºÙŠØ§Ø¨ Ø­ØµØ©").length;

  const negBeh = behToday.filter(b=>b.category!=="Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ").length;
  const posBeh = behToday.filter(b=>b.category==="Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ").length;

  byId("kpis").innerHTML = `
    <div class="kpi danger"><div class="n">${absent}</div><div class="t">ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div></div>
    <div class="kpi warn"><div class="n">${late}</div><div class="t">ØªØ£Ø®Ø±</div></div>
    <div class="kpi warn"><div class="n">${excuse}</div><div class="t">Ø§Ø³ØªØ¦Ø°Ø§Ù†</div></div>
    <div class="kpi"><div class="n">${periodAbs}</div><div class="t">ØºÙŠØ§Ø¨ Ø­ØµØ©</div></div>
    <div class="kpi danger"><div class="n">${negBeh}</div><div class="t">Ù…Ø®Ø§Ù„ÙØ§Øª</div></div>
    <div class="kpi ok"><div class="n">${posBeh}</div><div class="t">Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</div></div>
    <div class="kpi"><div class="n">${state.students.length}</div><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
    <div class="kpi ok"><div class="n">${calcFollowUpCount()}</div><div class="t">Ø¨Ø­Ø§Ø¬Ø© Ù…ØªØ§Ø¨Ø¹Ø©</div></div>
  `;

  // follow-up list (last 30 days)
  const list = getFollowUpList(30).slice(0,6);
  const wrap = byId("needFollow");
  const empty = byId("needFollowEmpty");
  if(list.length===0){
    wrap.innerHTML = "";
    empty.style.display = "";
  } else {
    empty.style.display = "none";
    wrap.innerHTML = list.map(x=>{
      const s = getStudent(x.studentId);
      if(!s) return "";
      const badge = x.score>=6 ? "danger" : (x.score>=4 ? "warn" : "");
      return `
        <div class="item">
          <div class="meta">
            <b>${esc(s.name)}</b>
            <span>${esc(studentLabel(s))}</span>
            <span class="sub">Ù…Ø¤Ø´Ø±: ${x.score} â€” ØºÙŠØ§Ø¨:${x.abs} ØªØ£Ø®Ø±:${x.late} Ù…Ø®Ø§Ù„ÙØ§Øª:${x.beh}</span>
          </div>
          <div class="tag ${badge}">Ù…ØªØ§Ø¨Ø¹Ø©</div>
        </div>
      `;
    }).join("");
  }
}
function calcFollowUpCount(){
  return getFollowUpList(30).length;
}
function getFollowUpList(days=30){
  const to = todayISODate();
  const from = new Date(Date.now() - days*24*3600*1000).toISOString().slice(0,10);
  const map = new Map();
  for(const a of state.attendance){
    if(!withinRange(a.date, from, to)) continue;
    if(!map.has(a.studentId)) map.set(a.studentId, {studentId:a.studentId, abs:0, late:0, beh:0});
    const m = map.get(a.studentId);
    if(a.type==="ØºÙŠØ§Ø¨") m.abs++;
    if(a.type==="ØªØ£Ø®Ø±") m.late++;
  }
  for(const b of state.behavior){
    if(!withinRange(b.date, from, to)) continue;
    if(b.category==="Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ") continue;
    if(!map.has(b.studentId)) map.set(b.studentId, {studentId:b.studentId, abs:0, late:0, beh:0});
    map.get(b.studentId).beh++;
  }
  const arr = Array.from(map.values()).map(x=>({ ...x, score: x.abs*2 + x.late + x.beh*2 }));
  // Ø­Ø¯Ù‘ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø¤Ø´Ø± (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡)
  return arr.filter(x=>x.score>=4).sort((a,b)=>b.score-a.score);
}

function renderStudents(){
  setHeader();
  const q = (byId("stuSearch").value||"").trim().toLowerCase();
  const list = state.students
    .filter(s=>{
      if(!q) return true;
      return [
        s.student_id, s.name, s.grade, s.class, s.section, s.guardian, s.phone
      ].some(v => (v??"").toString().toLowerCase().includes(q));
    })
    .sort((a,b)=> (a.name||"").localeCompare(b.name||"","ar"));

  const wrap = byId("stuList");
  const empty = byId("stuEmpty");
  if(list.length===0){
    wrap.innerHTML = "";
    empty.style.display = "";
  } else {
    empty.style.display = "none";
    wrap.innerHTML = list.map(s=>{
      return `
        <div class="item">
          <div class="meta">
            <b>${esc(s.name)}</b>
            <span>${esc(studentLabel(s))} â€¢ Ø±Ù‚Ù…: ${esc(s.student_id||"â€”")}</span>
            <span>${esc(s.guardian||"ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±")} â€¢ ${esc(s.phone||"")}</span>
          </div>
          <div class="row" style="gap:6px">
            <button class="btn small" onclick="editStudent('${s.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" onclick="deleteStudent('${s.id}')">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
    }).join("");
  }
}
function renderAttendance(){
  setHeader();
  const from = byId("attFrom").value;
  const to = byId("attTo").value;
  const q = (byId("attSearch").value||"").trim().toLowerCase();

  const rows = state.attendance
    .filter(r=>withinRange(r.date, from, to))
    .map(r=>{
      const s = getStudent(r.studentId);
      return {...r, student: s};
    })
    .filter(r=>{
      if(!q) return true;
      const hay = [
        r.date, r.type, r.period, r.note, r.reason, r.action,
        r.student?.name, r.student?.grade, r.student?.class, r.student?.section
      ].map(v=>(v??"").toString().toLowerCase()).join(" | ");
      return hay.includes(q);
    })
    .sort((a,b)=> (b.date+a.createdAt).localeCompare(a.date+b.createdAt));

  const tb = byId("attTable");
  const empty = byId("attEmpty");
  if(rows.length===0){
    tb.innerHTML = "";
    empty.style.display = "";
  }else{
    empty.style.display = "none";
    tb.innerHTML = rows.map(r=>{
      const s = r.student;
      const badge = (r.type==="ØºÙŠØ§Ø¨") ? "danger" : (r.type==="ØªØ£Ø®Ø±" || r.type==="Ø§Ø³ØªØ¦Ø°Ø§Ù†") ? "warn" : "";
      return `
        <tr>
          <td>${esc(r.date)}</td>
          <td>${esc(s?.name||"â€”")}</td>
          <td>${esc(studentLabel(s||{}))}</td>
          <td><span class="tag ${badge}">${esc(r.type)}</span></td>
          <td>${esc(r.period||"â€”")}</td>
          <td>${esc((r.reason||"") + (r.note?(" â€” "+r.note):""))}</td>
          <td>
            <button class="btn small" onclick="editAttendance('${r.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" onclick="deleteAttendance('${r.id}')">Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    }).join("");
  }
}
function renderBehavior(){
  setHeader();
  const from = byId("behFrom").value;
  const to = byId("behTo").value;
  const q = (byId("behSearch").value||"").trim().toLowerCase();

  const rows = state.behavior
    .filter(r=>withinRange(r.date, from, to))
    .map(r=>{
      const s = getStudent(r.studentId);
      return {...r, student:s};
    })
    .filter(r=>{
      if(!q) return true;
      const hay = [
        r.date, r.category, r.level, r.action, r.note,
        r.student?.name, r.student?.grade, r.student?.class, r.student?.section
      ].map(v=>(v??"").toString().toLowerCase()).join(" | ");
      return hay.includes(q);
    })
    .sort((a,b)=> (b.date+a.createdAt).localeCompare(a.date+b.createdAt));

  const tb = byId("behTable");
  const empty = byId("behEmpty");
  if(rows.length===0){
    tb.innerHTML = "";
    empty.style.display = "";
  }else{
    empty.style.display = "none";
    tb.innerHTML = rows.map(r=>{
      const s = r.student;
      const isPos = r.category==="Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ";
      const badge = isPos ? "ok" : (r.level>=3 ? "danger" : (r.level==2 ? "warn" : ""));
      return `
        <tr>
          <td>${esc(r.date)}</td>
          <td>${esc(s?.name||"â€”")}</td>
          <td>${esc(studentLabel(s||{}))}</td>
          <td><span class="tag ${badge}">${esc(r.category)}</span></td>
          <td>${esc(r.level||"â€”")}</td>
          <td>${esc(r.action||"â€”")}</td>
          <td>${esc(r.note||"")}</td>
        </tr>
      `;
    }).join("");
  }
}
function renderSettings(){
  setHeader();
  byId("setSchoolName").value = state.school.name || "";
  byId("setPeriods").value = String(state.settings.periods || 7);
  byId("setBehCats").value = (state.settings.behaviorCategories||[]).join(", ");
  byId("setActions").value = (state.settings.actions||[]).join(", ");
}

/* ===================== CRUD: Students ===================== */
function addStudent(){
  openModal("Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨", studentFormHTML());
  byId("fStuName").focus();
  byId("formStudent").addEventListener("submit",(e)=>{
    e.preventDefault();
    const s = readStudentForm();
    s.id = uid("stu");
    state.students.push(s);
    saveState();
    closeModal();
    renderStudents();
    renderDashboard();
  });
}
function editStudent(id){
  const s = state.students.find(x=>x.id===id);
  if(!s) return;
  openModal("ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨", studentFormHTML(s));
  byId("fStuName").focus();
  byId("formStudent").addEventListener("submit",(e)=>{
    e.preventDefault();
    const upd = readStudentForm();
    Object.assign(s, upd);
    saveState();
    closeModal();
    renderStudents();
    renderDashboard();
  });
}
function deleteStudent(id){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„Ø§ØªÙ‡ Ø£ÙŠØ¶Ù‹Ø§.")) return;
  state.students = state.students.filter(s=>s.id!==id);
  state.attendance = state.attendance.filter(a=>a.studentId!==id);
  state.behavior = state.behavior.filter(b=>b.studentId!==id);
  saveState();
  renderStudents(); renderAttendance(); renderBehavior(); renderDashboard();
}
function studentFormHTML(s={}){
  return `
    <form id="formStudent" class="grid">
      <div class="split">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="fStuName" required value="${esc(s.name||"")}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯">
        </div>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø³Ø¬Ù„</label>
          <input id="fStuId" value="${esc(s.student_id||"")}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
      </div>

      <div class="split">
        <div class="field">
          <label>Ø§Ù„ØµÙ</label>
          <input id="fStuGrade" value="${esc(s.grade||"")}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø«Ø§Ù†ÙŠ/Ø§Ù„Ø«Ø§Ù„Ø«">
        </div>
        <div class="field">
          <label>Ø§Ù„ÙØµÙ„</label>
          <input id="fStuClass" value="${esc(s.class||"")}" placeholder="Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 3">
        </div>
      </div>

      <div class="split">
        <div class="field">
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
          <input id="fStuSec" value="${esc(s.section||"")}" placeholder="Ù…Ø«Ø§Ù„: Ø£ / Ø¨">
        </div>
        <div class="field">
          <label>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
          <input id="fStuGuardian" value="${esc(s.guardian||"")}" placeholder="Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±">
        </div>
      </div>

      <div class="field">
        <label>Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
        <input id="fStuPhone" value="${esc(s.phone||"")}" placeholder="05xxxxxxxx">
      </div>

      <div class="row">
        <button class="btn primary" type="submit">Ø­ÙØ¸</button>
        <button class="btn" type="button" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  `;
}
function readStudentForm(){
  return {
    name: byId("fStuName").value.trim(),
    student_id: byId("fStuId").value.trim(),
    grade: byId("fStuGrade").value.trim(),
    class: byId("fStuClass").value.trim(),
    section: byId("fStuSec").value.trim(),
    guardian: byId("fStuGuardian").value.trim(),
    phone: byId("fStuPhone").value.trim(),
  };
}

/* ===================== Attendance ===================== */
function addAttendance(existing=null){
  if(state.students.length===0){
    alert("Ø£Ø¶Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø§Ù„Ø·Ù„Ø§Ø¨).");
    go("students");
    return;
  }
  const periods = Number(state.settings.periods||7);
  const types = ["ØºÙŠØ§Ø¨","ØªØ£Ø®Ø±","Ø§Ø³ØªØ¦Ø°Ø§Ù†","ØºÙŠØ§Ø¨ Ø­ØµØ©"];
  const actions = (state.settings.actions||[]);
  openModal(existing ? "ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ§Ø¸Ø¨Ø©" : "ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ§Ø¸Ø¨Ø©",
    attendanceFormHTML(existing, types, periods, actions)
  );
  byId("aDate").value = existing?.date || todayISODate();

  byId("formAttendance").addEventListener("submit",(e)=>{
    e.preventDefault();
    const r = readAttendanceForm();
    if(existing){
      Object.assign(existing, r);
    }else{
      state.attendance.push({ id: uid("att"), ...r, createdAt: nowISO() });
    }
    saveState();
    closeModal();
    renderAttendance();
    renderDashboard();
  });

  // quick selector
  byId("btnPickStudents").addEventListener("click", ()=>{
    openStudentPicker(existing?.studentIds || (existing?.studentId ? [existing.studentId] : []), (ids)=>{
      byId("aStudentIds").value = ids.join(",");
      byId("aStudentCount").textContent = ids.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${ids.length}` : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨";
    });
  });
}
function attendanceFormHTML(existing, types, periods, actions){
  const defaultAction = existing?.action || (actions[0]||"");
  const periodOpts = [`<option value="">â€”</option>`].concat(
    Array.from({length:periods},(_,i)=>`<option value="${i+1}">${i+1}</option>`)
  ).join("");
  const typeOpts = types.map(t=>`<option ${existing?.type===t?"selected":""}>${t}</option>`).join("");
  const actionOpts = [`<option value="">â€”</option>`].concat(actions.map(a=>`<option ${defaultAction===a?"selected":""}>${a}</option>`)).join("");

  const selectedCountText = existing ? "Ù‚Ø¯ÙŠÙ…Ø©" : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨";
  const studentIds = existing?.studentIds || (existing?.studentId ? [existing.studentId] : []);
  return `
    <form id="formAttendance" class="grid">
      <div class="split">
        <div class="field">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="aDate" required>
        </div>
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©</label>
          <select id="aType" required>${typeOpts}</select>
        </div>
      </div>

      <div class="split">
        <div class="field">
          <label>Ø§Ù„Ø­ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="aPeriod">${periodOpts}</select>
          <div class="hint">Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ© ÙÙ‚Ø· Ø¹Ù†Ø¯ â€œØºÙŠØ§Ø¨ Ø­ØµØ©â€.</div>
        </div>
        <div class="field">
          <label>Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="aAction">${actionOpts}</select>
          <div class="hint">ÙŠÙÙŠØ¯ ÙÙŠ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</div>
        </div>
      </div>

      <div class="field">
        <label>Ø§Ù„Ø³Ø¨Ø¨/Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø®ØªØµØ±Ø©</label>
        <input id="aReason" value="${esc(existing?.reason||"")}" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø± / Ø¹Ø°Ø± Ø·Ø¨ÙŠ / ØªØ£Ø®Ø± Ø­Ø§ÙÙ„Ø©">
      </div>

      <div class="field">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙØµÙŠÙ„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="aNote" placeholder="ØªÙˆØ«ÙŠÙ‚ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±/Ø§Ø³ØªØ¯Ø¹Ø§Ø¡...">${esc(existing?.note||"")}</textarea>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row between">
          <div>
            <b>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</b>
            <div class="sub" id="aStudentCount">${studentIds.length?`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${studentIds.length}`:selectedCountText}</div>
          </div>
          <button class="btn" type="button" id="btnPickStudents">Ø§Ø®ØªÙŠØ§Ø±</button>
        </div>
        <input type="hidden" id="aStudentIds" value="${esc(studentIds.join(","))}">
        <div class="hint" style="margin-top:8px">ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø§Ù„Ø¨ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.</div>
      </div>

      <div class="row">
        <button class="btn primary" type="submit">Ø­ÙØ¸</button>
        <button class="btn" type="button" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  `;
}
function readAttendanceForm(){
  const ids = (byId("aStudentIds").value||"").split(",").map(x=>x.trim()).filter(Boolean);
  if(ids.length===0) throw alert("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."), new Error("no students");

  const base = {
    date: byId("aDate").value,
    type: byId("aType").value,
    period: byId("aPeriod").value ? Number(byId("aPeriod").value) : "",
    action: byId("aAction").value || "",
    reason: byId("aReason").value.trim(),
    note: byId("aNote").value.trim()
  };

  // Ø¥Ø°Ø§ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ: Ø³Ù†Ø­ÙØ¸ ÙƒØ³Ø¬Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
  if(ids.length>1){
    // Ù†Ù†Ø´Ø¦ Ø¯ÙØ¹Ø© ÙˆÙ†Ø¹ÙŠØ¯ Ø£ÙˆÙ„ Ø¹Ù†ØµØ± ÙÙ‚Ø· Ù‡Ù†Ø§ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ ÙÙŠ addAttendance
  }
  return {...base, studentIds: ids, studentId: ids[0]};
}
function editAttendance(id){
  const r = state.attendance.find(x=>x.id===id);
  if(!r) return;
  // Ø¯Ø¹Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (single) + Ø§Ù„Ø¬Ø¯ÙŠØ¯ (multi)
  const existing = {...r, studentIds: r.studentIds || [r.studentId].filter(Boolean)};
  openModal("ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ§Ø¸Ø¨Ø©", attendanceFormHTML(existing, ["ØºÙŠØ§Ø¨","ØªØ£Ø®Ø±","Ø§Ø³ØªØ¦Ø°Ø§Ù†","ØºÙŠØ§Ø¨ Ø­ØµØ©"], Number(state.settings.periods||7), (state.settings.actions||[])));
  byId("aDate").value = existing.date;
  byId("aType").value = existing.type;
  byId("aPeriod").value = existing.period || "";
  byId("aAction").value = existing.action || "";
  byId("aReason").value = existing.reason || "";
  byId("aNote").value = existing.note || "";

  byId("formAttendance").addEventListener("submit",(e)=>{
    e.preventDefault();
    const upd = readAttendanceForm();
    // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø·Ø§Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø«Ø¨Øª Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·
    r.date = upd.date;
    r.type = upd.type;
    r.period = upd.period;
    r.action = upd.action;
    r.reason = upd.reason;
    r.note = upd.note;
    r.studentId = upd.studentId;
    delete r.studentIds;
    saveState();
    closeModal();
    renderAttendance(); renderDashboard();
  });

  byId("btnPickStudents").addEventListener("click", ()=>{
    openStudentPicker(existing.studentIds, (ids)=>{
      byId("aStudentIds").value = ids.join(",");
      byId("aStudentCount").textContent = ids.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${ids.length}` : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨";
    });
  });
}
function deleteAttendance(id){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
  state.attendance = state.attendance.filter(x=>x.id!==id);
  saveState();
  renderAttendance(); renderDashboard();
}

/* ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
function addAttendanceBulk(){
  // ØªØ³ØªØ®Ø¯Ù… addAttendance Ù…Ø¹ existing=null Ø«Ù… ØªØ­ÙØ¸ Ù…ØªØ¹Ø¯Ø¯
}

/* ===================== Behavior ===================== */
function addBehavior(existing=null){
  if(state.students.length===0){
    alert("Ø£Ø¶Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø§Ù„Ø·Ù„Ø§Ø¨).");
    go("students");
    return;
  }
  const cats = (state.settings.behaviorCategories||["Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©","Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ"]);
  const actions = (state.settings.actions||[]);
  openModal(existing ? "ØªØ¹Ø¯ÙŠÙ„ Ø³Ù„ÙˆÙƒ" : "ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙˆÙƒ", behaviorFormHTML(existing, cats, actions));
  byId("bDate").value = existing?.date || todayISODate();

  byId("formBehavior").addEventListener("submit",(e)=>{
    e.preventDefault();
    const r = readBehaviorForm();
    if(existing){
      Object.assign(existing, r);
    }else{
      state.behavior.push({ id: uid("beh"), ...r, createdAt: nowISO() });
    }
    saveState();
    closeModal();
    renderBehavior();
    renderDashboard();
  });

  byId("btnPickOneStudent").addEventListener("click", ()=>{
    openStudentPicker(existing?.studentId ? [existing.studentId] : [], (ids)=>{
      const id = ids[0] || "";
      byId("bStudentId").value = id;
      const s = getStudent(id);
      byId("bStudentLabel").textContent = s ? `${s.name} â€” ${studentLabel(s)}` : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨";
    }, true);
  });
}
function behaviorFormHTML(existing, cats, actions){
  const catOpts = cats.map(c=>`<option ${existing?.category===c?"selected":""}>${c}</option>`).join("");
  const actionOpts = [`<option value="">â€”</option>`].concat(actions.map(a=>`<option ${existing?.action===a?"selected":""}>${a}</option>`)).join("");
  const levels = `
    <option value="1" ${existing?.level==1?"selected":""}>1 (Ø¨Ø³ÙŠØ·)</option>
    <option value="2" ${existing?.level==2?"selected":""}>2 (Ù…ØªÙˆØ³Ø·)</option>
    <option value="3" ${existing?.level==3?"selected":""}>3 (Ù…Ø±ØªÙØ¹)</option>
  `;
  const s = existing?.studentId ? getStudent(existing.studentId) : null;
  return `
    <form id="formBehavior" class="grid">
      <div class="split">
        <div class="field">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="bDate" required>
        </div>
        <div class="field">
          <label>ÙØ¦Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ</label>
          <select id="bCat" required>${catOpts}</select>
        </div>
      </div>

      <div class="split">
        <div class="field">
          <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
          <select id="bLevel">${levels}</select>
          <div class="hint">Ø§Ø®ØªØ± (1) Ù„Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©.</div>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="bAction">${actionOpts}</select>
        </div>
      </div>

      <div class="card" style="box-shadow:none">
        <div class="row between">
          <div>
            <b>Ø§Ù„Ø·Ø§Ù„Ø¨</b>
            <div class="sub" id="bStudentLabel">${s?`${esc(s.name)} â€” ${esc(studentLabel(s))}`:"Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨"}</div>
          </div>
          <button class="btn" type="button" id="btnPickOneStudent">Ø§Ø®ØªÙŠØ§Ø±</button>
        </div>
        <input type="hidden" id="bStudentId" value="${esc(existing?.studentId||"")}">
      </div>

      <div class="field">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <textarea id="bNote" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± + Ù…Ø§ ØªÙ… (ØªÙ†Ø¨ÙŠÙ‡/Ø§ØªØµØ§Ù„/Ø§Ø³ØªØ¯Ø¹Ø§Ø¡)...">${esc(existing?.note||"")}</textarea>
      </div>

      <div class="row">
        <button class="btn primary" type="submit">Ø­ÙØ¸</button>
        <button class="btn" type="button" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  `;
}
function readBehaviorForm(){
  const studentId = byId("bStudentId").value.trim();
  if(!studentId) throw alert("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ù‹Ø§."), new Error("no student");
  return {
    date: byId("bDate").value,
    category: byId("bCat").value,
    level: Number(byId("bLevel").value||1),
    action: byId("bAction").value || "",
    studentId,
    note: byId("bNote").value.trim()
  };
}

/* ===================== Student Picker ===================== */
function openStudentPicker(selectedIds=[], onDone, single=false){
  const qid = uid("q");
  const lid = uid("l");
  const did = uid("d");
  const selected = new Set(selectedIds||[]);
  const render = (q="")=>{
    const list = state.students
      .filter(s=>{
        if(!q) return true;
        const hay = [s.student_id,s.name,s.grade,s.class,s.section].map(v=>(v??"").toString().toLowerCase()).join(" | ");
        return hay.includes(q.toLowerCase());
      })
      .sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));
    const wrap = document.getElementById(lid);
    wrap.innerHTML = list.map(s=>{
      const checked = selected.has(s.id);
      return `
        <div class="item" style="align-items:center">
          <div class="meta">
            <b>${esc(s.name)}</b>
            <span>${esc(studentLabel(s))}</span>
          </div>
          <input type="${single?'radio':'checkbox'}" name="pick" ${checked?'checked':''}
            onchange="(function(){
              const id='${s.id}';
              if(${single}){
                window.__pickSelected = new Set([id]);
                document.querySelectorAll('input[name=pick]').forEach(x=>{ if(x!==event.target) x.checked=false; });
              }else{
                if(event.target.checked) window.__pickSelected.add(id);
                else window.__pickSelected.delete(id);
              }
            })()"
          />
        </div>
      `;
    }).join("") || `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;
  };
  window.__pickSelected = new Set(selected);

  openModal("Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨", `
    <div class="row">
      <div class="field">
        <label>Ø¨Ø­Ø«</label>
        <input id="${qid}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØµÙ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…...">
      </div>
      <button class="btn ok" id="${did}">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
      <button class="btn" type="button" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div class="hr"></div>
    <div id="${lid}" class="list"></div>
  `);
  render("");
  document.getElementById(qid).addEventListener("input",(e)=>render(e.target.value));
  document.getElementById(did).addEventListener("click",()=>{
    const ids = Array.from(window.__pickSelected);
    onDone(single ? ids.slice(0,1) : ids);
    closeModal();
  });
}

/* ===================== Bulk save attendance when multiple selected ===================== */
(function patchAttendanceSubmit(){
  // Ù†ÙØ­ÙˆÙ‘Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¥Ù„Ù‰ Ø­ÙØ¸ Ù…ØªØ¹Ø¯Ø¯ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
  const originalAddAttendance = addAttendance;
  window.addAttendance = function(existing=null){
    if(existing) return originalAddAttendance(existing);

    if(state.students.length===0){
      alert("Ø£Ø¶Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø§Ù„Ø·Ù„Ø§Ø¨).");
      go("students");
      return;
    }
    const periods = Number(state.settings.periods||7);
    const types = ["ØºÙŠØ§Ø¨","ØªØ£Ø®Ø±","Ø§Ø³ØªØ¦Ø°Ø§Ù†","ØºÙŠØ§Ø¨ Ø­ØµØ©"];
    const actions = (state.settings.actions||[]);
    openModal("ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ§Ø¸Ø¨Ø©", attendanceFormHTML(null, types, periods, actions));
    byId("aDate").value = todayISODate();

    byId("formAttendance").addEventListener("submit",(e)=>{
      e.preventDefault();
      const base = {
        date: byId("aDate").value,
        type: byId("aType").value,
        period: byId("aPeriod").value ? Number(byId("aPeriod").value) : "",
        action: byId("aAction").value || "",
        reason: byId("aReason").value.trim(),
        note: byId("aNote").value.trim()
      };
      const ids = (byId("aStudentIds").value||"").split(",").map(x=>x.trim()).filter(Boolean);
      if(ids.length===0){ alert("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
      ids.forEach(stuId=>{
        state.attendance.push({ id: uid("att"), studentId: stuId, ...base, createdAt: nowISO() });
      });
      saveState();
      closeModal();
      renderAttendance(); renderDashboard();
    });

    byId("btnPickStudents").addEventListener("click", ()=>{
      openStudentPicker([], (ids)=>{
        byId("aStudentIds").value = ids.join(",");
        byId("aStudentCount").textContent = ids.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${ids.length}` : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨";
      });
    });
  };
})();

/* ===================== Export ===================== */
function exportAttendanceCSV(){
  const rows = [["date","student_name","grade","class","section","type","period","action","reason","note"]];
  for(const a of state.attendance){
    const s = getStudent(a.studentId)||{};
    rows.push([
      a.date, s.name||"", s.grade||"", s.class||"", s.section||"",
      a.type||"", a.period||"", a.action||"", a.reason||"", a.note||""
    ]);
  }
  download(`attendance_${todayISODate()}.csv`, toCSV(rows), "text/csv;charset=utf-8");
}
function exportBehaviorCSV(){
  const rows = [["date","student_name","grade","class","section","category","level","action","note"]];
  for(const b of state.behavior){
    const s = getStudent(b.studentId)||{};
    rows.push([
      b.date, s.name||"", s.grade||"", s.class||"", s.section||"",
      b.category||"", b.level||"", b.action||"", b.note||""
    ]);
  }
  download(`behavior_${todayISODate()}.csv`, toCSV(rows), "text/csv;charset=utf-8");
}

/* ===================== Import Students ===================== */
function importStudentsCSV(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".csv,text/csv";
  inp.onchange = async ()=>{
    const file = inp.files?.[0];
    if(!file) return;
    const text = await file.text();
    const rows = parseCSV(text);
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const idx = (name)=> header.indexOf(name);
    const required = ["name","grade","class","section"];
    // name Ø¥Ù„Ø²Ø§Ù…ÙŠ ÙÙ‚Ø·
    const start = 1;
    let added = 0;
    for(let i=start;i<rows.length;i++){
      const r = rows[i];
      const name = r[idx("name")]?.trim();
      if(!name) continue;
      const s = {
        id: uid("stu"),
        student_id: r[idx("student_id")]?.trim() || "",
        name,
        grade: r[idx("grade")]?.trim() || "",
        class: r[idx("class")]?.trim() || "",
        section: r[idx("section")]?.trim() || "",
        guardian: r[idx("guardian")]?.trim() || "",
        phone: r[idx("phone")]?.trim() || ""
      };
      state.students.push(s);
      added++;
    }
    saveState();
    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ø·Ø§Ù„Ø¨.`);
    renderStudents(); renderDashboard();
  };
  inp.click();
}

/* ===================== Backup/Restore ===================== */
function downloadBackup(){
  download(`backup_${todayISODate()}.json`, JSON.stringify(state,null,2), "application/json");
}
function restoreBackup(){
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json,.json";
  inp.onchange = async ()=>{
    const file = inp.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const s = JSON.parse(text);
      if(!s || typeof s!=="object") throw new Error("bad");
      state = {...defaultState(), ...s};
      saveState();
      alert("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.");
      go("dashboard");
    }catch(e){
      alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
    }
  };
  inp.click();
}

/* ===================== UI Events ===================== */
document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=> go(t.dataset.go)));

byId("btnAddStudent").addEventListener("click", addStudent);
byId("btnImportStudents").addEventListener("click", importStudentsCSV);
byId("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
  state = defaultState(); saveState();
  renderStudents(); renderAttendance(); renderBehavior(); renderDashboard();
});

byId("btnAddAttendance").addEventListener("click", ()=> addAttendance(null));
byId("btnAddAttendance2").addEventListener("click", ()=> addAttendance(null));
byId("btnAddBehavior").addEventListener("click", ()=> addBehavior(null));
byId("btnAddBehavior2").addEventListener("click", ()=> addBehavior(null));

byId("btnExportAttendance").addEventListener("click", exportAttendanceCSV);
byId("btnExportBehavior").addEventListener("click", exportBehaviorCSV);

byId("btnApplyAtt").addEventListener("click", renderAttendance);
byId("btnResetAtt").addEventListener("click", ()=>{
  byId("attFrom").value = ""; byId("attTo").value=""; byId("attSearch").value="";
  renderAttendance();
});
byId("btnApplyBeh").addEventListener("click", renderBehavior);
byId("btnResetBeh").addEventListener("click", ()=>{
  byId("behFrom").value = ""; byId("behTo").value=""; byId("behSearch").value="";
  renderBehavior();
});
byId("btnApplyStu").addEventListener("click", renderStudents);
byId("btnResetStu").addEventListener("click", ()=>{ byId("stuSearch").value=""; renderStudents(); });

byId("btnSaveSettings").addEventListener("click", ()=>{
  state.school.name = byId("setSchoolName").value.trim() || "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ";
  state.settings.periods = Number(byId("setPeriods").value||7);
  saveState();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
  renderSettings(); renderDashboard();
});
byId("btnSaveLists").addEventListener("click", ()=>{
  const cats = byId("setBehCats").value.split(",").map(x=>x.trim()).filter(Boolean);
  const acts = byId("setActions").value.split(",").map(x=>x.trim()).filter(Boolean);
  if(cats.length) state.settings.behaviorCategories = cats;
  if(acts.length) state.settings.actions = acts;
  saveState();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù….");
  renderSettings();
});

byId("btnDownloadBackup").addEventListener("click", downloadBackup);
byId("btnRestoreBackup").addEventListener("click", restoreBackup);

byId("btnBackup").addEventListener("click", downloadBackup);
byId("btnDownloadBackup").addEventListener("click", downloadBackup);

byId("btnQuickAdd").addEventListener("click", ()=>{
  openModal("ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹", `
    <div class="row">
      <button class="btn primary" onclick="closeModal(); addAttendance(null)">Ù…ÙˆØ§Ø¸Ø¨Ø©</button>
      <button class="btn" onclick="closeModal(); addBehavior(null)">Ø³Ù„ÙˆÙƒ</button>
      <button class="btn ghost" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="hr"></div>
    <div class="notice">
      <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© Ø¹Ø¨Ø± â€œØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨â€.
    </div>
  `);
});

byId("btnHelp").addEventListener("click", ()=>{
  openModal("Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ù…Ø®ØªØµØ±)", `
    <div class="notice">
      <b>Ø¥Ø±Ø´Ø§Ø¯ ØªØ±Ø¨ÙˆÙŠ:</b>
      <div style="margin-top:6px;line-height:1.9">
        â€¢ ÙˆØ«Ù‘Ù‚ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© (ØºÙŠØ§Ø¨/ØªØ£Ø®Ø±/Ù…Ø®Ø§Ù„ÙØ©) Ù…Ø¹ Ø³Ø¨Ø¨ Ù…Ø®ØªØµØ±.<br>
        â€¢ Ø¹Ù†Ø¯ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø©: Ø³Ø¬Ù‘Ù„ â€œØ¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©â€ (Ø§ØªØµØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±/Ø§Ø³ØªØ¯Ø¹Ø§Ø¡/ØªØ¹Ù‡Ø¯/Ø¥Ø­Ø§Ù„Ø©).<br>
        â€¢ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ÙˆØ¶ÙˆØ¹ÙŠØ©ØŒ ÙˆØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©ØŒ ÙˆØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„ÙˆÙƒ/Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡.<br>
      </div>
    </div>
    <div class="hr"></div>
    <div class="sub">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… (ÙØ¦Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒ/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª) Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¶Ø¨Ø·.</div>
  `);
});

/* ===================== Init ===================== */
(function init(){
  setHeader();

  // defaults for filters
  byId("attFrom").value = "";
  byId("attTo").value = "";
  byId("behFrom").value = "";
  byId("behTo").value = "";

  // render initial
  renderDashboard();

  // PWA SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
