<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>المواظبة والسلوك</title>
<meta name="theme-color" content="#1e8a79"/>
<link rel="manifest" href="./manifest.webmanifest"/>
<link rel="icon" href="./icons/icon-192.png"/>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --moe:#1e8a79; --moe-d:#0c594e; --accent:#0fb3b0;
  --bg:#f6fbfa; --card:#fff; --ink:#0b2f2b; --muted:#5a6c68;
  --line:#e6f1ee; --shadow:0 12px 28px rgba(0,0,0,.08); --r:18px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow-x:hidden;overscroll-behavior-x:none;touch-action:pan-y}
button,input,select,textarea{font-family:inherit}
#app{min-height:100%;width:100%;display:flex;flex-direction:column}

.topbar{
  position:sticky;top:0;z-index:70;
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;
  background:rgba(246,251,250,.94);
  backdrop-filter:saturate(160%) blur(10px);
  border-bottom:1px solid rgba(230,241,238,.7);
}
.brand{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.logo{width:40px;height:40px;border-radius:14px;background:radial-gradient(circle at 30% 30%, #2bd6c8, #1e8a79 55%, #0c594e);
  box-shadow:0 10px 22px rgba(30,138,121,.20);position:relative;flex:0 0 auto}
.logo:after{content:"";position:absolute;inset:8px;border-radius:10px;border:1px solid rgba(255,255,255,.35)}
.titlewrap{min-width:0}
.title{font-weight:900;font-size:16.5px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.subtitle{margin-top:2px;font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.iconbtn{border:1px solid rgba(30,138,121,.20);background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.04)}
.iconbtn:active{transform:translateY(1px)}
.iconbtn svg{width:18px;height:18px;display:block}

.content{width:100%;margin:0 auto;padding:14px 14px 150px}
@media(min-width:1000px){.content{padding-left:22px;padding-right:22px}}

.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.card + .card{margin-top:14px}
.head{padding:12px 12px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
.h{font-weight:900;font-size:14px}
.pill{font-size:12px;color:var(--muted);background:rgba(15,179,176,.10);border:1px solid rgba(15,179,176,.22);padding:6px 10px;border-radius:999px;white-space:nowrap}

.pad{padding:12px}

.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg button{flex:1;min-width:120px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer}
.seg button.active{background:rgba(30,138,121,.12);border-color:rgba(30,138,121,.25);color:var(--moe-d)}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.sel{border:1px solid var(--line);border-radius:16px;background:#fff;padding:10px 12px;font-size:14px;outline:0;min-width:210px;flex:0 0 auto;max-width:100%}

.search{flex:1;min-width:240px;display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:16px;background:#fff;max-width:100%}
.search svg{width:18px;height:18px;color:var(--muted)}
.search input{border:0;outline:0;width:100%;font-size:15px;background:transparent;color:var(--ink)}

.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:0;cursor:pointer;padding:11px 12px;border-radius:16px;font-weight:900;font-size:13.5px;background:rgba(30,138,121,.12);
  color:var(--moe-d);border:1px solid rgba(30,138,121,.22)}
.btn.secondary{background:rgba(15,179,176,.10);border-color:rgba(15,179,176,.22);color:var(--moe-d)}
.btn.ghost{background:#fff;border-color:var(--line);color:var(--ink)}
.btn.danger{background:rgba(180,30,30,.08);border-color:rgba(180,30,30,.18);color:#7b1f1f}
.btn:active{transform:translateY(1px)}

.help{font-size:12.8px;color:var(--muted);line-height:1.8;margin-top:8px}
.kbd{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--ink)}

.listWrap{border-top:1px solid var(--line);display:none}
.listHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:rgba(247,251,250,.7)}
.list{max-height:56vh;overflow:auto}
.item{display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--line)}
.item:last-child{border-bottom:0}
.item:active{background:rgba(30,138,121,.06)}

.ckbtn{width:34px;height:34px;border-radius:12px;border:1px solid rgba(30,138,121,.26);background:#fff;display:flex;align-items:center;justify-content:center;flex:0 0 auto;margin-top:1px;cursor:pointer}
.ckbtn.checked{background:rgba(30,138,121,.14);border-color:rgba(30,138,121,.35)}
.ckbtn svg{width:18px;height:18px;color:var(--moe-d)}

.main{min-width:0;flex:1;cursor:pointer}
.name{font-size:15.5px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{margin-top:2px;font-size:12.8px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
.meta span{border:1px dashed rgba(90,108,104,.22);border-radius:999px;padding:2px 8px;background:rgba(247,251,250,.7)}
.mini{display:flex;gap:8px;align-items:center;flex:0 0 auto}
.mini .btn{padding:8px 10px;border-radius:12px;font-weight:900;font-size:12.5px}

.empty{padding:14px 12px;text-align:center;color:var(--muted);line-height:1.9}

.actionbar{position:fixed;left:0;right:0;bottom:0;z-index:60;background:rgba(246,251,250,.94);backdrop-filter:saturate(160%) blur(10px);
  border-top:1px solid var(--line);padding:10px 12px}
.actionbarInner{width:100%;margin:0 auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.selCard{flex:1;min-width:260px;background:#fff;border:1px solid var(--line);border-radius:16px;padding:10px 12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;box-shadow:0 10px 20px rgba(0,0,0,.05)}
.selCard .n{font-weight:900;font-size:13.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.selCard .s{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.backdrop{position:fixed;inset:0;background:rgba(8,25,22,.35);display:none;align-items:flex-end;justify-content:center;z-index:90}
.backdrop.show{display:flex}
.sheet{width:100%;max-width:860px;background:#fff;border-radius:22px 22px 0 0;border:1px solid var(--line);box-shadow:0 30px 70px rgba(0,0,0,.25);
  padding:12px 14px 18px;max-height:92vh;overflow:auto}
.sheetHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding-bottom:10px;border-bottom:1px solid var(--line)}
.sheetTitle{font-weight:900;font-size:15px}
.close{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer}
.close svg{width:18px;height:18px}

.form{padding-top:12px;display:grid;gap:10px}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:520px){.grid2{grid-template-columns:1fr}}
.field label{display:block;font-weight:800;font-size:12.5px;color:var(--muted);margin:0 2px 6px}
.field input,.field select,.field textarea{width:100%;border:1px solid var(--line);border-radius:16px;padding:12px 12px;outline:0;font-size:15px;background:#fff}
.field textarea{min-height:90px;resize:vertical}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{font-size:12.5px;font-weight:800;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
.chip.active{background:rgba(30,138,121,.12);border-color:rgba(30,138,121,.25);color:var(--moe-d)}

.primary{width:100%;border:0;cursor:pointer;padding:13px 14px;border-radius:16px;font-weight:900;font-size:15px;background:linear-gradient(135deg,var(--moe),#2bd6c8);color:#fff;
  box-shadow:0 14px 30px rgba(30,138,121,.22)}
.secondaryBtn{width:100%;border:1px solid var(--line);cursor:pointer;padding:12px 14px;border-radius:16px;font-weight:900;font-size:14px;background:#fff;color:var(--ink)}
.inlineBtns{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:520px){.inlineBtns{grid-template-columns:1fr}}

.preview{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(247,251,250,.6);font-size:14px;line-height:1.9;white-space:pre-wrap}
.small{font-size:12.7px;color:var(--muted);line-height:1.8}

.toast{position:fixed;left:12px;right:12px;bottom:98px;z-index:120;display:none}
.toast.show{display:block}
.toastInner{width:100%;max-width:640px;margin:0 auto;background:#0b2f2b;color:#fff;border-radius:16px;padding:12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.25);font-size:13.5px}

hr{border:0;border-top:1px solid var(--line);margin:6px 0}

/* ===== Print (A4) ===== */
#printArea{display:none}
@media print{
  body{background:#fff}
  #app{display:none !important}
  #printArea{display:block !important}
  @page { size: A4 landscape; margin: 10mm; }
}
.printWrap{font-family:Tajawal,Arial; color:#000}
.printTitle{font-weight:900;font-size:16px;margin:0 0 6px}
.printMeta{font-size:12px;margin:0 0 8px}
.printTable{width:100%;border-collapse:collapse;table-layout:fixed}
.printTable th,.printTable td{border:1px solid #000;padding:4px 6px;font-size:11.5px;vertical-align:middle}
.printTable th{background:#f3f3f3}
.colNum{width:36px;text-align:center}
.colName{width:210px}
.colSec{width:80px;text-align:center}
.colKind{width:160px}
.colAct{width:auto}
.colBar{width:280px}
.barSvg{width:100%;height:var(--bcH,40px);display:block}
.pageBreak{page-break-after:always}

/* ===== A4 كشف شعبة: ضغط ذكي + منع تقسيم الصفوف ===== */
.sectionSheet .printTitle{font-size:14px}
.sectionSheet .printMeta{font-size:11px}
.sectionSheet .printTable th,.sectionSheet .printTable td{
  font-size:var(--fs,11px);
  padding:var(--pad,3px) var(--padX,4px);
  line-height:1.2;
}
.sectionSheet .colNum{width:28px;text-align:center}
.sectionSheet .colName{width:200px}
.sectionSheet .colBar{width:260px}
.printTable tr{page-break-inside:avoid;break-inside:avoid}

/* ===== تحسين الجوال: أشرطة أزرار في صف واحد بدون تمرير أفقي ===== */
#app, .container {overflow-x:hidden}
@media (max-width: 560px){
  /* نوع الرصد (تأخر/غياب/مخالفة/إذن) في صف واحد */
  .seg{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  #stageSeg.seg{grid-template-columns:repeat(3,minmax(0,1fr))}
  .seg button{width:100%;min-width:0;padding:10px 6px;font-size:13px;line-height:1.2}
  /* أزرار التحكم بالنتائج في صف واحد */
  .actions.toolbar4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .actions.toolbar4 .btn{width:100%;min-width:0;padding:10px 6px;font-size:12.6px}
  /* صف أدوات الشعبة: (اختيار شعبة + كشف A4 + جلسة باركود) */
  .row.tools{display:grid;grid-template-columns:1.35fr 1fr 1fr;gap:8px;align-items:stretch}
  .row.tools .sel{width:100%;min-width:0}
  .row.tools .btn{min-width:0;padding:10px 6px;font-size:12.6px}
}

/* ===== تلوين واضح حسب النوع ===== */
:root{
  --late:#f6c000;      /* أصفر للتأخر */
  --absent:#d92d20;    /* أحمر للغياب */
  --permit:#1a8f5a;    /* أخضر للإذن */
  --behavior:#0b7e88;  /* تركوازي للمخالفة */
}
#quickSeg button{border:1px solid var(--line);background:#fff}
#quickSeg button[data-qk="late"]{background:rgba(246,192,0,.14);border-color:rgba(246,192,0,.35);color:#6b4f00}
#quickSeg button[data-qk="absent"]{background:rgba(217,45,32,.10);border-color:rgba(217,45,32,.28);color:#7a1710}
#quickSeg button[data-qk="behavior"]{background:rgba(11,126,136,.10);border-color:rgba(11,126,136,.28);color:#064a50}
#quickSeg button[data-qk="permit"]{background:rgba(26,143,90,.10);border-color:rgba(26,143,90,.28);color:#0f4b2f}

#quickSeg button.active[data-qk="late"]{background:var(--late);border-color:var(--late);color:#111}
#quickSeg button.active[data-qk="absent"]{background:var(--absent);border-color:var(--absent);color:#fff}
#quickSeg button.active[data-qk="behavior"]{background:var(--behavior);border-color:var(--behavior);color:#fff}
#quickSeg button.active[data-qk="permit"]{background:var(--permit);border-color:var(--permit);color:#fff}



/* ===== تحسينات مطلوبة حسب الطلب ===== */

/* ألوان المراحل (أول/ثاني/ثالث) */
#stageSeg button[data-stage="1314"]{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.08);color:#1e40af}
#stageSeg button[data-stage="1416"]{border-color:rgba(13,148,136,.35);background:rgba(13,148,136,.08);color:#115e59}
#stageSeg button[data-stage="1516"]{border-color:rgba(124,58,237,.35);background:rgba(124,58,237,.08);color:#5b21b6}
#stageSeg button.active[data-stage="1314"]{background:#1e40af;color:#fff;border-color:#1e40af}
#stageSeg button.active[data-stage="1416"]{background:#0f766e;color:#fff;border-color:#0f766e}
#stageSeg button.active[data-stage="1516"]{background:#6d28d9;color:#fff;border-color:#6d28d9}

/* شارة المرحلة داخل الرصد السريع/الأرشيف */
.stagePill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-weight:800;font-size:12px;white-space:nowrap}
.stagePill.stage-1314{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.08);color:#1e40af}
.stagePill.stage-1416{border-color:rgba(13,148,136,.35);background:rgba(13,148,136,.08);color:#115e59}
.stagePill.stage-1516{border-color:rgba(124,58,237,.35);background:rgba(124,58,237,.08);color:#5b21b6}

/* الرصد السريع: بيانات الطالب في صف واحد */
.profileRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.profileRow .cell{padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.profileRow .cell strong{font-weight:900}
.profileRow .muted{opacity:.85}

/* الأرشيف: جدول رسمي للطباعة */
.archiveWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
.archiveWrap .archiveHead{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--line);background:#fbfdfc}
.archiveWrap .archiveHead .title{font-weight:900}
.archiveWrap .archiveHead .meta{opacity:.85;font-size:12px}
.archiveWrap table{width:100%;border-collapse:collapse;font-size:13px}
.archiveWrap th,.archiveWrap td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:top;text-align:right}
.archiveWrap th{background:#f5fbf9;font-weight:900;white-space:nowrap}
</style>
</head>

<body>
<div id="app">
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="titlewrap">
        <div class="title">المواظبة والسلوك</div>
<div class="subtitle" id="appVersion">الإصدار 2026-02-16 • بحث سريع • تقارير A4</div>
      </div>
    </div>
<button class="iconbtn" id="menuBtn" type="button" aria-label="القائمة">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
    <path d="M4 6h16M4 12h16M4 18h16"></path>
  </svg>
</button>
  </header>

  <main class="content">

    <section class="card" id="firstRun" style="display:none">
      <div class="head">
        <div class="h">بدء سريع</div>
        <div class="pill">يعمل دون إنترنت</div>
      </div>
      <div class="pad">
        <div class="help">لا توجد بيانات طلاب على هذا الجهاز. اختر <span class="kbd">تحميل بيانات الطلاب</span> أو استورد CSV/JSON أو استورد نسخة احتياطية.</div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="loadEmbeddedBtn" type="button">تحميل بيانات الطلاب</button>
          <button class="btn secondary" id="importBtn" type="button">استيراد ملف</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head">
        <div class="h">جاهزية الرصد + البحث</div>
        <div class="pill" id="countPill">محدد: 0</div>
      </div>
      <div class="pad">

        <div class="seg" id="quickSeg" aria-label="نوع الرصد"></div>

        <div class="row" style="margin-top:10px">
          <div class="search" role="search">
<span id="searchIcon" aria-hidden="true">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="7"></circle>
    <path d="M20 20l-3.5-3.5"></path>
  </svg>
</span>
            <input id="q" type="search" placeholder="ابحث (اسم/هوية/رقم/جوال)… ولن تظهر الأسماء إلا عند البحث" autocomplete="off" disabled/>
          </div>
        </div>

        <div class="help">
          • اختر النوع أولاً (تأخر/غياب/مخالفة/إذن) ثم ابحث. عند اختيار الطالب تُفتح لك الشاشة جاهزة للحفظ والواتساب.<br/>
          • يمكنك لاحقًا تحديد الطلاب جماعيًا عبر زر <b>تحديد الكل</b> ثم الإرسال المتتابع.
        </div>

        <div class="actions toolbar4" style="margin-top:10px">
          <button class="btn ghost" id="toggleListBtn" type="button" disabled>عرض النتائج</button>
          <button class="btn secondary" id="selectAllBtn" type="button" disabled>تحديد الكل (حسب البحث/الفلتر)</button>
          <button class="btn ghost" id="clearSelBtn" type="button" disabled>إلغاء التحديد</button>
          <button class="btn" id="reportBtn" type="button">تقارير اليوم (A4)</button>
        </div>

      </div>

      <div class="listWrap" id="listWrap">
        <div class="listHead">
          <div class="pill" id="listPill">النتائج</div>
          <button class="btn ghost" id="hideListBtn" type="button">إخفاء</button>
        </div>
        <div class="list" id="list"></div>
      </div>
    </section>

    <section class="card">
      <div class="head">
        <div class="h">تصفية اختيارية</div>
        <div class="pill" id="todayPill">اليوم</div>
      </div>
      <div class="pad">
        <div class="seg" id="stageSeg" aria-label="المراحل"></div>
        <div class="row tools" style="margin-top:10px">
          <select class="sel" id="sectionSelect" disabled>
            <option value="">اختر الشعبة…</option>
          </select>
          <button class="btn" id="sheetA4Btn" type="button" disabled>كشف شعبة A4</button>
          <button class="btn secondary" id="scanBtn" type="button" disabled>جلسة باركود (تأخر/غياب)</button>
        </div>
        <div class="help">
          • هذه التصفية <b>اختيارية</b> لتسهيل (كشف شعبة / جلسة باركود). البحث يعمل حتى بدون اختيار الصف والشعبة.
        </div>
      </div>
    </section>

  </main>

  <div class="actionbar" id="actionbar" style="display:none">
    <div class="actionbarInner">
      <div class="selCard">
        <div style="min-width:0">
          <div class="n" id="selTitle">—</div>
          <div class="s" id="selSub">—</div>
        </div>
        <div class="pill" id="selPill">0</div>
      </div>

      <button class="btn" id="bulkLate" type="button">تأخر</button>
      <button class="btn secondary" id="bulkAbsent" type="button">غياب</button>
      <button class="btn secondary" id="bulkBehavior" type="button">مخالفة</button>
      <button class="btn secondary" id="bulkPermit" type="button">إذن</button>
    </div>
  </div>

  <!-- Sheet -->
  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="sheetTitle" id="sheetTitle">—</div>
<button class="close" id="closeBtn" type="button" aria-label="إغلاق">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
    <path d="M18 6L6 18M6 6l12 12"></path>
  </svg>
</button>
      </div>

      <input type="hidden" id="sheetKind" value="" />
      <input type="hidden" id="sheetMode" value="" />
      <input type="hidden" id="defaultSubtype" value="" />

      <div class="form">

        <div class="field" id="profileBox" style="display:none">
          <label>الطالب</label>
          <div class="preview" id="profileInfo"></div>
        </div>

        <div class="field" id="editStudentBox" style="display:none">
          <label>تعديل بيانات الطالب (محليًا)</label>
          <div class="grid2">
            <div class="field">
              <label for="stPhone">رقم ولي الأمر (واتساب)</label>
              <input id="stPhone" type="tel" inputmode="tel" placeholder="05xxxxxxxx أو 9665xxxxxxx"/>
            </div>
            <div class="field">
              <label for="stId">رقم الهوية/الباركود</label>
              <input id="stId" type="text" placeholder="رقم الهوية/رقم الطالب"/>
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary" id="saveStudentBtn" type="button">حفظ التعديل</button>
          </div>
          <div class="small">التعديل محلي على هذا الجهاز (ضمن النسخة الاحتياطية).</div>
        </div>

        <div class="field" id="recipientsBox" style="display:none">
          <label>الجهة المستهدفة</label>
          <div class="chips" id="recipientChips"></div>
          <div class="small" style="margin-top:6px">في “الإذن”: يمكن إرسال إشعار للمعلم أو لولي الأمر أو لكليهما.</div>
        </div>

        
        <div class="field" id="teacherBox" style="display:none">
          <label>بيانات المعلم (للواتساب)</label>

          <div class="grid2">
            <div class="field">
              <label for="teacherSelect">اختيار المعلم (قائمة منسدلـة)</label>
              <select id="teacherSelect"></select>
              <div class="small" style="margin-top:6px">يمكن التعديل يدويًا عند الحاجة:</div>
              <input id="teacherName" type="text" placeholder="ابحث/اكتب اسم المعلم…"/>
            </div>
            <div class="field">
              <label for="teacherPhone">رقم واتساب المعلم</label>
              <input id="teacherPhone" type="tel" inputmode="tel" placeholder="05xxxxxxxx أو 9665xxxxxxx"/>
            </div>
          </div>

          <div class="actions">
            <button class="btn ghost" id="pickTeacherBtn" type="button">بحث</button>
            <button class="btn secondary" id="saveTeacherBtn" type="button">حفظ/تحديث</button>
          </div>
          <div class="small">يُحفظ دليل المعلمين محليًا داخل التطبيق.</div>
        </div>

        <div class="field" id="scanBox" style="display:none">
          <label>جلسة الباركود (لليوم)</label>
          <div class="chips" id="scanTypeChips"></div>
          <div class="grid2">
            <div class="field">
              <label for="scanInput">امسح الباركود هنا</label>
              <input id="scanInput" type="text" inputmode="numeric" placeholder="مرّر القارئ…"/>
            </div>
            <div class="field">
              <label>آخر عملية</label>
              <div class="preview" id="scanLast" style="min-height:54px"></div>
            </div>
          </div>
          <div class="actions">
            <button class="btn secondary" id="scanFocusBtn" type="button">تركيز الحقل</button>
            <button class="btn danger" id="scanStopBtn" type="button">إنهاء الجلسة</button>
          </div>
          <div class="small">يُسجّل “غياب/تأخر” في أرشيف اليوم تلقائيًا عند كل مسح.</div>
        </div>

        <div class="field" id="chipsBox">
          <label id="chipsLabel">اختيار سريع</label>
          <div class="chips" id="chips"></div>
        </div>

        <div class="field" id="typeBox">
          <label for="typeSelect">التصنيف</label>
          <select id="typeSelect"></select>
        </div>

        
        <div class="field" id="behaviorDetailBox" style="display:none">
          <label>تفاصيل المخالفة</label>
          <div class="grid2">
            <div class="field">
              <label for="behDegree">الدرجة</label>
              <select id="behDegree"></select>
            </div>
            <div class="field">
              <label for="behInfraction">المخالفة (منسدلة حسب الدرجة)</label>
              <select id="behInfraction"></select>
            </div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div class="field" id="behRepeatBox" style="display:none">
              <label class="small" style="display:flex;gap:10px;align-items:center">
                <input id="behRepeat" type="checkbox"/>
                <span>الدرجة الأولى: الحسم <b>عند التكرار</b> فقط</span>
              </label>
            </div>
            <div class="field">
              <label>مقدار الحسم من درجات السلوك</label>
              <div class="preview" id="behDeductHint">—</div>
            </div>
          </div>
        </div>

        <div class="grid2" id="whenRow">
          <div class="field">
            <label for="when">اليوم/التاريخ/الوقت</label>
            <input id="when" type="text"/>
          </div>
          <div class="field" id="phoneBox">
            <label for="phone">رقم واتساب ولي الأمر (اختياري)</label>
            <input id="phone" type="tel" inputmode="tel" placeholder="اتركه فارغًا لاستخدام رقم الطالب المسجّل"/>
          </div>
        </div>

        <div class="field" id="noteBox">
          <label for="note">سبب/تفاصيل مختصرة (اختياري)</label>
          <textarea id="note" placeholder="مثال: تكرر اليوم / تم التنبيه داخل الحصة / يرجى المتابعة…"></textarea>
        </div>

        <button class="primary" id="saveBtn" type="button">حفظ + إنشاء رسائل</button>

        <div id="afterSave" style="display:none">
          <div class="field">
            <label>المعاينة</label>
            <div class="preview" id="preview"></div>
          </div>
          <div class="inlineBtns">
            <button class="secondaryBtn" id="copyBtn" type="button">نسخ</button>
            <button class="primary" id="waBtn" type="button">إرسال واتساب (متتابع)</button>
          </div>
          
          <div class="inlineBtns" id="behaviorPrintBox" style="display:none">
            <button class="secondaryBtn" id="printSlipBtn" type="button">طباعة ورقة طالب (صغير)</button>
            <button class="secondaryBtn" id="printBehaviorA4Btn" type="button">طباعة نموذج رسمي (A4)</button>
          </div>
          <button class="secondaryBtn" id="openArchiveBtn" type="button" style="display:none">فتح أرشيف الطالب</button>
        </div>

        
        <div id="archiveBox" style="display:none">
          <hr/>
          <div class="field">
            <label>أرشيف الطالب</label>
            <div id="archiveList" class="archiveWrap"></div>
          </div>
          <div class="inlineBtns">
            <button class="secondaryBtn" id="printArchiveBtn" type="button">طباعة الأرشيف (A4)</button>
            <button class="secondaryBtn" id="copyArchiveBtn" type="button">نسخ</button>
          </div>
        </div>

        <div id="reportBox" style="display:none">
          <hr/>
          <div class="field">
            <label>تقارير اليوم</label>
            <div class="preview" id="reportText"></div>
          </div>
          <div class="actions">
            <button class="btn ghost" id="printLateBtn" type="button">طباعة المتأخرين (A4)</button>
            <button class="btn ghost" id="printAbsentBtn" type="button">طباعة الغياب (A4)</button>
            <button class="btn ghost" id="printBehaviorBtn" type="button">طباعة المخالفات (A4)</button>
          </div>
          <div class="inlineBtns">
            <button class="secondaryBtn" id="reportCopyBtn" type="button">نسخ</button>
            <button class="primary" id="reportWaBtn" type="button">واتساب لليوم (متتابع)</button>
          </div>
          <div class="small">ملاحظة: “الإجراء المقترح” للاستئناس، ويُرجع للدليل عند الحاجة.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
    <div class="toastInner" id="toastInner">—</div>
  </div>
</div>

<!-- Print Area -->
<div id="printArea"></div>

<script>
"use strict";
// تسجيل Service Worker + إجبار تحديثه عند وجود نسخة جديدة
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });

      // اطلب تحديثه كل مرة تفتح الصفحة
      reg.update();

      // إذا فيه تحديث جاهز → حمّل الصفحة تلقائيًا
      if (reg.waiting) {
        reg.waiting.postMessage({ type: 'ذكرني_بالتحديث' });
      }

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // يضمن ظهور النسخة الجديدة مباشرة
        window.location.reload();
      });

    } catch (e) {
      console.warn('SW register failed:', e);
    }
  });
}
/* ========== بيانات الطلاب (مضمنة) ========== */
const EMBEDDED_STUDENTS = [{"sid": "2305897668", "name": "احمد محمود ثابت احمد", "phone": "966563658017", "gradeCode": "1314", "section": "1"}, {"sid": "2292617145", "name": "اصيل عبود صالح العمودي", "phone": "966553507555", "gradeCode": "1314", "section": "1"}, {"sid": "2307606737", "name": "امين - - العربي", "phone": "966503200914", "gradeCode": "1314", "section": "1"}, {"sid": "05360710", "name": "امين صادق علي الحمادي", "phone": "966504567688", "gradeCode": "1314", "section": "1"}, {"sid": "1150435822", "name": "جهاد بن صادق بن عبدالله آل طه", "phone": "966562158152", "gradeCode": "1314", "section": "1"}, {"sid": "1149831206", "name": "خالد بن عبداللطيف بن خالد الحويل", "phone": "966545171157", "gradeCode": "1314", "section": "1"}, {"sid": "1151210018", "name": "رضا بن محمد بن ابراهيم الصالح", "phone": "966563967601", "gradeCode": "1314", "section": "1"}, {"sid": "4131708002", "name": "ريان حسين علوي حسين", "phone": "966501656407", "gradeCode": "1314", "section": "1"}, {"sid": "2290508973", "name": "ريان علي عوض النهدي", "phone": "966507445053", "gradeCode": "1314", "section": "1"}, {"sid": "1150954897", "name": "سامي عمر احمد المدني", "phone": "966504836294", "gradeCode": "1314", "section": "1"}, {"sid": "2288928746", "name": "سليمان امين علي الحمادي", "phone": "966505525110", "gradeCode": "1314", "section": "1"}, {"sid": "2312377852", "name": "سيف الاسلام محمد عبدالحميد عبدالعزيز", "phone": "966532466060", "gradeCode": "1314", "section": "1"}, {"sid": "2302048810", "name": "عبدالرحمن مصطفى - المحضار", "phone": "966533534908", "gradeCode": "1314", "section": "1"}, {"sid": "2294756453", "name": "عبدالرحمن مقبل علي ثابت", "phone": "966570031629", "gradeCode": "1314", "section": "1"}, {"sid": "0160253180", "name": "عبدالله مبارك عمر بن نقح", "phone": "966548415596", "gradeCode": "1314", "section": "1"}, {"sid": "2299096517", "name": "عزالدين عبده عباس علي", "phone": "966503116256", "gradeCode": "1314", "section": "1"}, {"sid": "2303423657", "name": "عزام عمر سالم سعيد", "phone": "966581870777", "gradeCode": "1314", "section": "1"}, {"sid": "1151240247", "name": "علي بن فيروز بن علي المولد", "phone": "966569347377", "gradeCode": "1314", "section": "1"}, {"sid": "3913455394", "name": "عمار ياسر عبدالقوي محسن", "phone": "966554030599", "gradeCode": "1314", "section": "1"}, {"sid": "1150220430", "name": "فراس بن محمد بن حبيب المهناء", "phone": "966532727101", "gradeCode": "1314", "section": "1"}, {"sid": "2304521947", "name": "ليث حسام عبدالرحيم حمد", "phone": "966582899702", "gradeCode": "1314", "section": "1"}, {"sid": "2306667060", "name": "ماجد نبيل يحي عثمان", "phone": "966503826765", "gradeCode": "1314", "section": "1"}, {"sid": "4194784643", "name": "مجد الدين حسام الدين محمد الصفدي", "phone": "966531662769", "gradeCode": "1314", "section": "1"}, {"sid": "2298097581", "name": "محمد الفاضل محمد عبدالمطلب", "phone": "966505864303", "gradeCode": "1314", "section": "1"}, {"sid": "1152426829", "name": "محمد زكريا محمد العوفي", "phone": "966557001829", "gradeCode": "1314", "section": "1"}, {"sid": "3618693364", "name": "محمد غازي حسام الدين الاسطه", "phone": "966582711155", "gradeCode": "1314", "section": "1"}, {"sid": "2295597872", "name": "محمد وسيم محمد الحموي", "phone": "966503843857", "gradeCode": "1314", "section": "1"}, {"sid": "2411649953", "name": "مشعل محسن علي منيباري", "phone": "966506891987", "gradeCode": "1314", "section": "1"}, {"sid": "2351147026", "name": "معتز ايمن عبدالحميد حسن", "phone": "966502414177", "gradeCode": "1314", "section": "1"}, {"sid": "2289658169", "name": "يوسف عبدالناصر محمد اليافعي", "phone": "966555555555", "gradeCode": "1314", "section": "1"}, {"sid": "2316847462", "name": "تيم حسام الراعي -", "phone": "966546269391", "gradeCode": "1314", "section": "2"}, {"sid": "2312121623", "name": "خالد علي سالم بلقحوم", "phone": "966569788666", "gradeCode": "1314", "section": "2"}, {"sid": "3891109955", "name": "ريان سليمان علي محمد سعيد", "phone": "966504922544", "gradeCode": "1314", "section": "2"}, {"sid": "2329290783", "name": "سلمان سامي سالم الحداد", "phone": "966501864290", "gradeCode": "1314", "section": "2"}, {"sid": "2346244318", "name": "عبدالرحمن طاهر عبدالله غرامه", "phone": "966547231980", "gradeCode": "1314", "section": "2"}, {"sid": "2283969596", "name": "عبدالرحمن محمد - الاحمد", "phone": "966505861290", "gradeCode": "1314", "section": "2"}, {"sid": "2283696801", "name": "عبدالعزيز حسين علي الاسودي", "phone": "966504911854", "gradeCode": "1314", "section": "2"}, {"sid": "2282044482", "name": "عبدالله محمد سالم باقديم", "phone": "966555057720", "gradeCode": "1314", "section": "2"}, {"sid": "2412200384", "name": "عبدالله محمد سعيد منيباري", "phone": "966580090901", "gradeCode": "1314", "section": "2"}, {"sid": "1152246771", "name": "عبدالمحسن بن عبدالله بن عبدالعزيز الصانع", "phone": "966509998445", "gradeCode": "1314", "section": "2"}, {"sid": "2300101520", "name": "علي محمد علي باوقاد", "phone": "966503983778", "gradeCode": "1314", "section": "2"}, {"sid": "2321040632", "name": "فارس محمد خليل العدم", "phone": "966540510569", "gradeCode": "1314", "section": "2"}, {"sid": "2304405216", "name": "مازن محمود زغلول فهمي", "phone": "966555709459", "gradeCode": "1314", "section": "2"}, {"sid": "1152056477", "name": "محمد بن عادل بن محمد الزهوان الغامدي", "phone": "966564244609", "gradeCode": "1314", "section": "2"}, {"sid": "2313316560", "name": "محمد جعفر محمد الحاج", "phone": "966540974476", "gradeCode": "1314", "section": "2"}, {"sid": "2303137075", "name": "محمد زكي صالح جابر", "phone": "966552125644", "gradeCode": "1314", "section": "2"}, {"sid": "2309506257", "name": "محمد صلاح خلف الله الحوار مسمار", "phone": "966569220758", "gradeCode": "1314", "section": "2"}, {"sid": "2327615270", "name": "محمد عبدالله مبارك نصير", "phone": "966533356147", "gradeCode": "1314", "section": "2"}, {"sid": "2287543199", "name": "محمد عمر عبدالله شملان", "phone": "966500108698", "gradeCode": "1314", "section": "2"}, {"sid": "0190803128", "name": "محمد كرم الله عوض صديق", "phone": "966509690641", "gradeCode": "1314", "section": "2"}, {"sid": "0190805352", "name": "محمد كمال العشاري أحمد", "phone": "966564120452", "gradeCode": "1314", "section": "2"}, {"sid": "0190804049", "name": "محمد محمود - المصري", "phone": "966554577769", "gradeCode": "1314", "section": "2"}, {"sid": "2335188047", "name": "محمد وائل محمد همام", "phone": "966501655219", "gradeCode": "1314", "section": "2"}, {"sid": "2080969934", "name": "محمد ورد وضاح - مشمشان", "phone": "966551260185", "gradeCode": "1314", "section": "2"}, {"sid": "2411879501", "name": "محمد ولاءالدين عمر حسن", "phone": "966537602402", "gradeCode": "1314", "section": "2"}, {"sid": "2290356662", "name": "محمود طارق ابراهيم الاسدي", "phone": "966508501994", "gradeCode": "1314", "section": "2"}, {"sid": "2316655022", "name": "مشاري هيثم - العلاوي", "phone": "966581764036", "gradeCode": "1314", "section": "2"}, {"sid": "2295654087", "name": "هتان مختار عبدالرحمن مختار", "phone": "966501261505", "gradeCode": "1314", "section": "2"}, {"sid": "1151948039", "name": "وائل بن سامي بن خليل سودقر الشماع", "phone": "966555522529", "gradeCode": "1314", "section": "2"}, {"sid": "2281879615", "name": "اسماعيل خالد علي حزام", "phone": "966540899918", "gradeCode": "1314", "section": "3"}, {"sid": "2307784781", "name": "أكرم محمد المصطفى حمد", "phone": "966556942437", "gradeCode": "1314", "section": "3"}, {"sid": "2299122776", "name": "الياس عبدالملك غالب عبدالكريم", "phone": "966503872944", "gradeCode": "1314", "section": "3"}, {"sid": "2297637668", "name": "ايمن علي مسعد الجملي", "phone": "966507998829", "gradeCode": "1314", "section": "3"}, {"sid": "1149912907", "name": "تميم عبداللطيف عبدالرزاق الشيخ", "phone": "966565588322", "gradeCode": "1314", "section": "3"}, {"sid": "2310029224", "name": "خالد عبدالرحمن عبدالله سلطان", "phone": "966598589000", "gradeCode": "1314", "section": "3"}, {"sid": "0160796518", "name": "خالد وليد عبدالمغني عبدالسلام", "phone": "966559101658", "gradeCode": "1314", "section": "3"}, {"sid": "2414499836", "name": "ريان صادق علي الخولاني", "phone": "966509862786", "gradeCode": "1314", "section": "3"}, {"sid": "2388783785", "name": "زياد محمد عبد الرازق عبد الرازق", "phone": "966546735980", "gradeCode": "1314", "section": "3"}, {"sid": "2316743182", "name": "سعود علي حسن باحجاو", "phone": "966502448166", "gradeCode": "1314", "section": "3"}, {"sid": "2293803850", "name": "سعيد محمد سعيد باناعمه", "phone": "966504840281", "gradeCode": "1314", "section": "3"}, {"sid": "1151010350", "name": "عبدالاله بن غسان بن عبدالخير محفوظ", "phone": "966507177792", "gradeCode": "1314", "section": "3"}, {"sid": "2557792971", "name": "عبدالرحمن احمد سعدى أبو العوف", "phone": "966557086993", "gradeCode": "1314", "section": "3"}, {"sid": "1152400451", "name": "عبدالعزيز بن فيصل بن عبدالله السويلم", "phone": "966551066268", "gradeCode": "1314", "section": "3"}, {"sid": "6115806652", "name": "عبدالعزيز راشد يحيى عبدالله", "phone": "966558889613", "gradeCode": "1314", "section": "3"}, {"sid": "0160258384", "name": "عبدالله وجدان ردمان الشيباني", "phone": "966536220447", "gradeCode": "1314", "section": "3"}, {"sid": "2081239559", "name": "علي رفاعي - الرفاعي", "phone": "966534508269", "gradeCode": "1314", "section": "3"}, {"sid": "1152250831", "name": "علي موسى بن حسن البراهيم", "phone": "966568622112", "gradeCode": "1314", "section": "3"}, {"sid": "2300735202", "name": "عمر حسن علي باصريح", "phone": "966554997791", "gradeCode": "1314", "section": "3"}, {"sid": "0160515834", "name": "عمران عادل محمد عبدالرحمن", "phone": "966576479311", "gradeCode": "1314", "section": "3"}, {"sid": "0150260885", "name": "عيسى علي محمد اليافعي", "phone": "966505789025", "gradeCode": "1314", "section": "3"}, {"sid": "0120786448", "name": "فهد محمد عبدالحي محمد", "phone": "966555234213", "gradeCode": "1314", "section": "3"}, {"sid": "1153637721", "name": "فيصل بن احمد بن محمد المرشد", "phone": "966545010375", "gradeCode": "1314", "section": "3"}, {"sid": "0160258667", "name": "لؤي عبدالله سالم باجبير", "phone": "966509475297", "gradeCode": "1314", "section": "3"}, {"sid": "2356550075", "name": "محمد أحمد حافظ محمد", "phone": "966546176818", "gradeCode": "1314", "section": "3"}, {"sid": "0160252838", "name": "محمد حسن أحمد البريكي", "phone": "966503514111", "gradeCode": "1314", "section": "3"}, {"sid": "0160509938", "name": "محمد هاني محمد القحازي", "phone": "966530635096", "gradeCode": "1314", "section": "3"}, {"sid": "2295456517", "name": "مؤمن صلاح صبرى محمد", "phone": "966580464789", "gradeCode": "1314", "section": "3"}, {"sid": "1154077935", "name": "نواف بن عباس بن عبدالرحمن صابر", "phone": "966547990727", "gradeCode": "1314", "section": "3"}, {"sid": "0160260774", "name": "نواف كمال علي عبدالقوي بن عبادل", "phone": "966569451565", "gradeCode": "1314", "section": "3"}, {"sid": "0160505933", "name": "همام علي ناجي زيد", "phone": "966555425046", "gradeCode": "1314", "section": "3"}, {"sid": "2288858562", "name": "ابراهيم مبخوت خميس الهميمي", "phone": "966508107776", "gradeCode": "1314", "section": "4"}, {"sid": "2299371381", "name": "احمد عدنان عبدالله بانواس", "phone": "966550551379", "gradeCode": "1314", "section": "4"}, {"sid": "2289934917", "name": "اسامه حافظ محمد المحمد", "phone": "966554359463", "gradeCode": "1314", "section": "4"}, {"sid": "2283960934", "name": "اسامه عمر - زنطح", "phone": "966537142439", "gradeCode": "1314", "section": "4"}, {"sid": "2298118775", "name": "اسامه محمد همام عجاج", "phone": "966569205248", "gradeCode": "1314", "section": "4"}, {"sid": "2287018721", "name": "باسم هانى رجب ابراهيم", "phone": "966536876628", "gradeCode": "1314", "section": "4"}, {"sid": "1149926246", "name": "بدر احمد بن علي بوخليف", "phone": "966505706225", "gradeCode": "1314", "section": "4"}, {"sid": "2297995090", "name": "جود رامي - التلا", "phone": "966548102802", "gradeCode": "1314", "section": "4"}, {"sid": "2290303458", "name": "حسان شوقي محمد حسان", "phone": "966508141398", "gradeCode": "1314", "section": "4"}, {"sid": "4198833024", "name": "خالد فهمي هزاع نصر", "phone": "966568180598", "gradeCode": "1314", "section": "4"}, {"sid": "3950061758", "name": "خالد محمود - الابراهيم العبدالله", "phone": "966562261972", "gradeCode": "1314", "section": "4"}, {"sid": "1148669698", "name": "رواف بن هاني بن صالح ألبوأدوم الدوسري", "phone": "966504905399", "gradeCode": "1314", "section": "4"}, {"sid": "2293958654", "name": "ريان طارق جمعان بادعام", "phone": "966506860741", "gradeCode": "1314", "section": "4"}, {"sid": "2312574870", "name": "سلطان رواد احمد الكثيري", "phone": "966545007126", "gradeCode": "1314", "section": "4"}, {"sid": "2309314884", "name": "عبدالرحمن اكرم عبده جحيش", "phone": "966535676555", "gradeCode": "1314", "section": "4"}, {"sid": "1149835090", "name": "عبدالعزيز عدنان بن عبدالله البراهيم", "phone": "966551476584", "gradeCode": "1314", "section": "4"}, {"sid": "1154204653", "name": "عبدالله بن يونس بن مشبب آل جميل العمري", "phone": "966552901111", "gradeCode": "1314", "section": "4"}, {"sid": "1154249765", "name": "عبدالمحسن محمد عبدالمحسن الحاجي", "phone": "966565173631", "gradeCode": "1314", "section": "4"}, {"sid": "2297868248", "name": "علي مروان علي عبدالرب", "phone": "966555167467", "gradeCode": "1314", "section": "4"}, {"sid": "2282734595", "name": "عمار مازن احمد بابكري", "phone": "966502849093", "gradeCode": "1314", "section": "4"}, {"sid": "2291017909", "name": "عمر محمد فتحى عوض", "phone": "966552318709", "gradeCode": "1314", "section": "4"}, {"sid": "2285205148", "name": "عمر محمد نضال - موسى", "phone": "966569300962", "gradeCode": "1314", "section": "4"}, {"sid": "2300767379", "name": "فهد محمد أحمد النهدي", "phone": "966500771135", "gradeCode": "1314", "section": "4"}, {"sid": "1146297526", "name": "فيصل بن ثويني بن مسفر الزهيري", "phone": "966543536992", "gradeCode": "1314", "section": "4"}, {"sid": "2298201118", "name": "قصي انس محمد الساعاتي", "phone": "966509883585", "gradeCode": "1314", "section": "4"}, {"sid": "2307023487", "name": "ليث باسل - الحموي", "phone": "966501492797", "gradeCode": "1314", "section": "4"}, {"sid": "3718716768", "name": "محمد سلطان حسين العولقي", "phone": "966506236948", "gradeCode": "1314", "section": "4"}, {"sid": "2281618922", "name": "مصطفى محمد مصطفى موسى", "phone": "966509770191", "gradeCode": "1314", "section": "4"}, {"sid": "2279747600", "name": "مصعب محمد - علي", "phone": "966501837713", "gradeCode": "1314", "section": "4"}, {"sid": "2300563448", "name": "مهند ليث جودت المرداوي", "phone": "966593377432", "gradeCode": "1314", "section": "4"}, {"sid": "1153184401", "name": "يزن بن علي بن احمد الحنيش", "phone": "966503733429", "gradeCode": "1314", "section": "4"}, {"sid": "0160257218", "name": "اكرم صادق علي قاسم", "phone": "966508881238", "gradeCode": "1314", "section": "5"}, {"sid": "0160252685", "name": "البراء شوقي نصر الجماعي", "phone": "966507800117", "gradeCode": "1314", "section": "5"}, {"sid": "0160516624", "name": "أيمن محمد فرحان المرشد", "phone": "966552933431", "gradeCode": "1314", "section": "5"}, {"sid": "2074433524", "name": "ايهم فراس فاروق حمزة", "phone": "966581722455", "gradeCode": "1314", "section": "5"}, {"sid": "2283949051", "name": "حسن عمر - لبابيدي", "phone": "966558830322", "gradeCode": "1314", "section": "5"}, {"sid": "0160257211", "name": "حسين عبدالرحمن حسين السقاف", "phone": "966500505699", "gradeCode": "1314", "section": "5"}, {"sid": "2289975225", "name": "حمزه علي مصطفى الحمصي", "phone": "966582891810", "gradeCode": "1314", "section": "5"}, {"sid": "05899778", "name": "خالد عمار أحمد الفراصي", "phone": "966534072942", "gradeCode": "1314", "section": "5"}, {"sid": "1148961236", "name": "راشد خضران بن صالح الزهراني", "phone": "966504843678", "gradeCode": "1314", "section": "5"}, {"sid": "2287640870", "name": "راشد محمد ابو بكر حسين", "phone": "966506411598", "gradeCode": "1314", "section": "5"}, {"sid": "0070785680", "name": "زياد محمد عيد الجيوشي", "phone": "966542770755", "gradeCode": "1314", "section": "5"}, {"sid": "2289150506", "name": "زيد بلال احمد ابوسليم", "phone": "966509182692", "gradeCode": "1314", "section": "5"}, {"sid": "0160517973", "name": "سعيد وليد محمد باشعيب", "phone": "966552021565", "gradeCode": "1314", "section": "5"}, {"sid": "2285357782", "name": "سمير احمد - خيرالله", "phone": "966502429221", "gradeCode": "1314", "section": "5"}, {"sid": "1150611026", "name": "عبدالاله بن منصور بن عبدالرحمن المنصور", "phone": "966562410000", "gradeCode": "1314", "section": "5"}, {"sid": "2274791462", "name": "عبدالجليل هشام - عبدالرحمن", "phone": "966508110117", "gradeCode": "1314", "section": "5"}, {"sid": "0160803071", "name": "عبدالله مبارك أحمد علي", "phone": "966569233899", "gradeCode": "1314", "section": "5"}, {"sid": "05082254", "name": "عدنان فهد راجح المنتصر", "phone": "966553375286", "gradeCode": "1314", "section": "5"}, {"sid": "0160509937", "name": "عمر مختار ابوبكر شائف", "phone": "966552133020", "gradeCode": "1314", "section": "5"}, {"sid": "1151828744", "name": "فهد بن حسن بن عامر ال محجوبه الشهري", "phone": "966598893731", "gradeCode": "1314", "section": "5"}, {"sid": "2289760452", "name": "كريم عامر احمد العياصره", "phone": "966532881270", "gradeCode": "1314", "section": "5"}, {"sid": "1151246194", "name": "محمد بن محسن بن محمد الجويد", "phone": "966555578408", "gradeCode": "1314", "section": "5"}, {"sid": "0160804068", "name": "محمد عوض محمد بلعويله", "phone": "966556227021", "gradeCode": "1314", "section": "5"}, {"sid": "2293715625", "name": "محمد ياسر عبدالقيوم محمد خير", "phone": "966535302853", "gradeCode": "1314", "section": "5"}, {"sid": "0150786015", "name": "مصطفى عبدالرحيم  صالح", "phone": "966509884040", "gradeCode": "1314", "section": "5"}, {"sid": "2291247100", "name": "منيب عبدالله محمد علي", "phone": "966502113149", "gradeCode": "1314", "section": "5"}, {"sid": "2285458762", "name": "موسى محمد فرج حمو", "phone": "966501010328", "gradeCode": "1314", "section": "5"}, {"sid": "2292443161", "name": "يوسف سالم محمد الجنيدي", "phone": "966534361690", "gradeCode": "1314", "section": "5"}, {"sid": "2275230205", "name": "يونس سعد الدين محمد حمزه", "phone": "966563568883", "gradeCode": "1314", "section": "5"}, {"sid": "2300556897", "name": "اسامه نادر حسن عيد", "phone": "966503848153", "gradeCode": "1314", "section": "6"}, {"sid": "2301171985", "name": "اسيد شادي محمود خاروف", "phone": "966531455912", "gradeCode": "1314", "section": "6"}, {"sid": "2385607623", "name": "ايمن عادل علي عبدالجليل عبدالوهاب", "phone": "966533286472", "gradeCode": "1314", "section": "6"}, {"sid": "2302918905", "name": "ايهم انس فؤاد شاهين", "phone": "966566371120", "gradeCode": "1314", "section": "6"}, {"sid": "2298611761", "name": "تيم محمد علي عبدالإله بغدادي", "phone": "966503967608", "gradeCode": "1314", "section": "6"}, {"sid": "2301845182", "name": "جهاد وليد حسن سلامه", "phone": "966553559295", "gradeCode": "1314", "section": "6"}, {"sid": "1150045787", "name": "حسن بن قاسم بن حسن البحيري", "phone": "966547501109", "gradeCode": "1314", "section": "6"}, {"sid": "1148848227", "name": "حمد بن خالد بن شافي القاسم", "phone": "966507569756", "gradeCode": "1314", "section": "6"}, {"sid": "2299869525", "name": "حمزه وائل محمد طافش", "phone": "966537830092", "gradeCode": "1314", "section": "6"}, {"sid": "2321135572", "name": "ريان عماد مطاوع كريزم", "phone": "966567131113", "gradeCode": "1314", "section": "6"}, {"sid": "2308408794", "name": "عبدالرحمن محمد مهيوب عبدالله", "phone": "966559952535", "gradeCode": "1314", "section": "6"}, {"sid": "2314530102", "name": "عبدالرحمن محمداياد احمد الزنبركجي", "phone": "966508556000", "gradeCode": "1314", "section": "6"}, {"sid": "1150974697", "name": "عبدالله بن حمد بن طاهر مجربي", "phone": "966566008777", "gradeCode": "1314", "section": "6"}, {"sid": "1150382610", "name": "عبدالله بن سمير بن عبدالله الودعاني الدوسري", "phone": "966598675174", "gradeCode": "1314", "section": "6"}, {"sid": "2300850977", "name": "عدي رامي هشام ملاح", "phone": "966542988922", "gradeCode": "1314", "section": "6"}, {"sid": "2316505060", "name": "علي حسن علي مراد", "phone": "966506806712", "gradeCode": "1314", "section": "6"}, {"sid": "2297238210", "name": "علي محمد علي عبدالرب", "phone": "966555339879", "gradeCode": "1314", "section": "6"}, {"sid": "2323531638", "name": "عمار مختار محسن علي", "phone": "966535363057", "gradeCode": "1314", "section": "6"}, {"sid": "2299886156", "name": "عمار ياسر محمود ابوالعز", "phone": "966508473568", "gradeCode": "1314", "section": "6"}, {"sid": "2299886164", "name": "عمرو ياسر محمود ابوالعز", "phone": "966508473568", "gradeCode": "1314", "section": "6"}, {"sid": "1150148524", "name": "فيصل جابر بن ناصر عداوي", "phone": "966504993524", "gradeCode": "1314", "section": "6"}, {"sid": "2300525504", "name": "فيصل عبدالسلام رهيش الجربي", "phone": "966570702736", "gradeCode": "1314", "section": "6"}, {"sid": "2302918913", "name": "مالك انس فؤاد شاهين", "phone": "966566371120", "gradeCode": "1314", "section": "6"}, {"sid": "2296222488", "name": "محمد احمد هزاع عبدالرب", "phone": "966537077208", "gradeCode": "1314", "section": "6"}, {"sid": "2304321868", "name": "محمد خالد محمد حمد", "phone": "966558109141", "gradeCode": "1314", "section": "6"}, {"sid": "2299988465", "name": "محمد مبين رزان محمد مبين كلسلي", "phone": "966547670006", "gradeCode": "1314", "section": "6"}, {"sid": "2317561294", "name": "مشعل سمير مبارك نصير", "phone": "966508784989", "gradeCode": "1314", "section": "6"}, {"sid": "2313604759", "name": "ملهم حلمي يوسف ابوحمد", "phone": "966533172039", "gradeCode": "1314", "section": "6"}, {"sid": "2302570599", "name": "وليد فضل عبدالله بن سبعه", "phone": "966503884021", "gradeCode": "1314", "section": "6"}, {"sid": "2295020917", "name": "يحيى مصطفى - ورده", "phone": "966508458792", "gradeCode": "1314", "section": "6"}, {"sid": "2312090331", "name": "يوسف - - براملي", "phone": "966568709600", "gradeCode": "1314", "section": "6"}, {"sid": "1152067177", "name": "أحمد شاكر محمد الرهيش", "phone": "966504989675", "gradeCode": "1314", "section": "7"}, {"sid": "2349301875", "name": "احمد محمد محمود العبيد", "phone": "966564983411", "gradeCode": "1314", "section": "7"}, {"sid": "2500889296", "name": "احمد مصطفى عبدالمتعال السيد", "phone": "966530688971", "gradeCode": "1314", "section": "7"}, {"sid": "A18198997", "name": "اسر محمد عبدالفتاح محمد عبدالنبى", "phone": "966542966530", "gradeCode": "1314", "section": "7"}, {"sid": "2425493091", "name": "خالد عادل رجب محمود", "phone": "966566557703", "gradeCode": "1314", "section": "7"}, {"sid": "4004302842", "name": "خالد عبدالله عمر قروان", "phone": "966508699669", "gradeCode": "1314", "section": "7"}, {"sid": "2302200551", "name": "خالد محمد أحمد جابر", "phone": "966504911668", "gradeCode": "1314", "section": "7"}, {"sid": "2303103812", "name": "راشد محمد علي حزام", "phone": "966500060946", "gradeCode": "1314", "section": "7"}, {"sid": "2358195036", "name": "سهيل محمد احمد الجوهي", "phone": "966563333808", "gradeCode": "1314", "section": "7"}, {"sid": "2297870400", "name": "عبدالرحمن محمد عبدالله نقح", "phone": "966504998043", "gradeCode": "1314", "section": "7"}, {"sid": "2293304289", "name": "عبدالرحمن يعقوب عبدالرحمن يعقوب", "phone": "966506027802", "gradeCode": "1314", "section": "7"}, {"sid": "4135449231", "name": "عبدالرحيم نصر عبادي ثابت", "phone": "966508588009", "gradeCode": "1314", "section": "7"}, {"sid": "1149783571", "name": "عبدالله بن يوسف بن عيسى العيد", "phone": "966592038351", "gradeCode": "1314", "section": "7"}, {"sid": "1150964367", "name": "عبدالله سعيد مبارك الدوسري", "phone": "966567146381", "gradeCode": "1314", "section": "7"}, {"sid": "2300684723", "name": "عبدالله فهمي عبدالله الكثيري", "phone": "966500061014", "gradeCode": "1314", "section": "7"}, {"sid": "2375823503", "name": "عبدالله محمد الحسيني بيدة", "phone": "966541020927", "gradeCode": "1314", "section": "7"}, {"sid": "2581903131", "name": "على ظافر احمد شاهين", "phone": "966590759558", "gradeCode": "1314", "section": "7"}, {"sid": "2408672083", "name": "علي محمد جعفر بن عقيل", "phone": "966507834745", "gradeCode": "1314", "section": "7"}, {"sid": "2413676905", "name": "عمار ياسر محمد عوض", "phone": "966569400999", "gradeCode": "1314", "section": "7"}, {"sid": "2425493083", "name": "عمر عادل رجب محمود", "phone": "966566557703", "gradeCode": "1314", "section": "7"}, {"sid": "2308877097", "name": "عمر محمد عمر الهميمي", "phone": "966507166139", "gradeCode": "1314", "section": "7"}, {"sid": "2397515616", "name": "غيث سامر محمد الغيلاني", "phone": "966535667150", "gradeCode": "1314", "section": "7"}, {"sid": "3512157557", "name": "غيث محمد سامر - سعد", "phone": "966563426252", "gradeCode": "1314", "section": "7"}, {"sid": "2574518987", "name": "محمد امير محمد حسن", "phone": "966531329559", "gradeCode": "1314", "section": "7"}, {"sid": "1150967378", "name": "محمد بن حسن بن يوسف الخليفه", "phone": "966506907431", "gradeCode": "1314", "section": "7"}, {"sid": "2551045475", "name": "محمد رائد عاطف ابو موجه", "phone": "966530490305", "gradeCode": "1314", "section": "7"}, {"sid": "2473559991", "name": "مزمل محمد مسعد السرور", "phone": "966531659030", "gradeCode": "1314", "section": "7"}, {"sid": "2398803060", "name": "مسعد امين مسعد عبده المنتصر", "phone": "966535183509", "gradeCode": "1314", "section": "7"}, {"sid": "1151952106", "name": "منذر بن خالد بن سالم بن صويلح", "phone": "966541043335", "gradeCode": "1314", "section": "7"}, {"sid": "2405535424", "name": "يوسف سعيد سالم مديحج", "phone": "966551192588", "gradeCode": "1314", "section": "7"}, {"sid": "2408665871", "name": "يوسف منير حسن الكبسي", "phone": "966536247140", "gradeCode": "1314", "section": "7"}, {"sid": "1104396880", "name": "حسن موسى بن احمد الحميد", "phone": "966576878304", "gradeCode": "1314", "section": "8"}, {"sid": "1035430469", "name": "علي احمد عبدالله الجامع", "phone": "966501247636", "gradeCode": "1314", "section": "8"}, {"sid": "1106809252", "name": "محمد بن عبدالله بن احمد حسن", "phone": "966565516967", "gradeCode": "1314", "section": "8"}, {"sid": "1078218854", "name": "محمد منصور حميدي الداودي", "phone": "", "gradeCode": "1314", "section": "8"}, {"sid": "4688447897", "name": "احمد محمد احمد هبه سعيد", "phone": "966583532158", "gradeCode": "1416", "section": "1"}, {"sid": "0050809867", "name": "احمد نصر الدين محمد عثمان", "phone": "966557537650", "gradeCode": "1416", "section": "1"}, {"sid": "0160509925", "name": "اسيد زكي حميد البدري", "phone": "966501352895", "gradeCode": "1416", "section": "1"}, {"sid": "2283194575", "name": "أواب اسامة محمد عثمان", "phone": "966570462866", "gradeCode": "1416", "section": "1"}, {"sid": "1147451882", "name": "بدر بن عبدالله بن صالح الزهراني", "phone": "966556883342", "gradeCode": "1416", "section": "1"}, {"sid": "1146498926", "name": "بدر بن عماد بن محمد الثنيان", "phone": "966552226456", "gradeCode": "1416", "section": "1"}, {"sid": "1147840266", "name": "بسام بن خالد بن مسفر ال دليم القحطاني", "phone": "966504814561", "gradeCode": "1416", "section": "1"}, {"sid": "0160257213", "name": "بشير احمد احمد محمد العمري", "phone": "966500330783", "gradeCode": "1416", "section": "1"}, {"sid": "1146654866", "name": "تميم وليد بن خليل العلي", "phone": "966507427297", "gradeCode": "1416", "section": "1"}, {"sid": "1145945281", "name": "جابر بن حمد بن عبدالرحمن ال عايض الفهادي", "phone": "966558235445", "gradeCode": "1416", "section": "1"}, {"sid": "1145449433", "name": "حسن بن علي بن حسن العوفي", "phone": "966509677556", "gradeCode": "1416", "section": "1"}, {"sid": "2282302310", "name": "حسين عزالدين علي الشبيبي", "phone": "966551939202", "gradeCode": "1416", "section": "1"}, {"sid": "0160509940", "name": "راكان علي مهيوب الحيدري", "phone": "966598988932", "gradeCode": "1416", "section": "1"}, {"sid": "0160252690", "name": "رامز أنور سعيد الهلالي", "phone": "966508591622", "gradeCode": "1416", "section": "1"}, {"sid": "2421452125", "name": "رامي خالد احمد صالح", "phone": "966500042970", "gradeCode": "1416", "section": "1"}, {"sid": "05864792", "name": "زيد عبدالله عمر قروان", "phone": "966508699669", "gradeCode": "1416", "section": "1"}, {"sid": "1148031840", "name": "عبد الرحمن بن محمد بن عبد الله القحطاني", "phone": "966505747394", "gradeCode": "1416", "section": "1"}, {"sid": "2474668999", "name": "عبد المعز عماد امين فلاحه", "phone": "966536350638", "gradeCode": "1416", "section": "1"}, {"sid": "3141044413", "name": "عبدالرحمن فهمان ثابت العبادي", "phone": "966564710135", "gradeCode": "1416", "section": "1"}, {"sid": "1147216699", "name": "عبدالله بن عوض بن محمد الجعاوله الغامدي", "phone": "966532262091", "gradeCode": "1416", "section": "1"}, {"sid": "1146092307", "name": "علي بن عمار بن محمد العايش", "phone": "966535828555", "gradeCode": "1416", "section": "1"}, {"sid": "1148224551", "name": "فهد بن أحمد بن عيسى حدادي", "phone": "966506837407", "gradeCode": "1416", "section": "1"}, {"sid": "1147296386", "name": "فياض بن فارس بن محمد المرشد", "phone": "966568976339", "gradeCode": "1416", "section": "1"}, {"sid": "1147929291", "name": "فيصل بن أحمد بن حبيب المهناء", "phone": "966533178834", "gradeCode": "1416", "section": "1"}, {"sid": "1145973390", "name": "فيصل بن محمد بن موسى عسيري", "phone": "966567354777", "gradeCode": "1416", "section": "1"}, {"sid": "0160509944", "name": "فيصل خالد أحمد الضبياني", "phone": "966501177488", "gradeCode": "1416", "section": "1"}, {"sid": "004131726", "name": "ليث كمال - الابرش", "phone": "966554279151", "gradeCode": "1416", "section": "1"}, {"sid": "1147296428", "name": "محمد بن عبدالله بن محمد المرشد", "phone": "966567967935", "gradeCode": "1416", "section": "1"}, {"sid": "0160260455", "name": "محمد توفيق محمد الفتيحي", "phone": "966505430045", "gradeCode": "1416", "section": "1"}, {"sid": "0160257212", "name": "محمد صلاح محمد العمري", "phone": "966537730073", "gradeCode": "1416", "section": "1"}, {"sid": "0160509924", "name": "محمد وهيب امين سيف", "phone": "966582086333", "gradeCode": "1416", "section": "1"}, {"sid": "2306526365", "name": "محمود وليد عبدالله باطرفي", "phone": "966548585222", "gradeCode": "1416", "section": "1"}, {"sid": "0160257009", "name": "ناصر أكرم ناصر جعران", "phone": "966502211002", "gradeCode": "1416", "section": "1"}, {"sid": "1143850509", "name": "ناصر بن فهد بن ابراهيم الناصر", "phone": "966546913719", "gradeCode": "1416", "section": "1"}, {"sid": "0160258129", "name": "نذير منذر سعيد عبدالله", "phone": "966540252741", "gradeCode": "1416", "section": "1"}, {"sid": "0160509941", "name": "نقيب عادل سيف العبادي", "phone": "966504551072", "gradeCode": "1416", "section": "1"}, {"sid": "1147933814", "name": "نوح بن عبدالعزيز بن محمد العوفي", "phone": "966509939299", "gradeCode": "1416", "section": "1"}, {"sid": "2274454822", "name": "احمد عبدالله احمد باسليمان", "phone": "966535764605", "gradeCode": "1416", "section": "2"}, {"sid": "4753766115", "name": "الياس مجدي نصر محمد", "phone": "966501431115", "gradeCode": "1416", "section": "2"}, {"sid": "2273660098", "name": "امير - - عبدالعظيم", "phone": "966559328996", "gradeCode": "1416", "section": "2"}, {"sid": "2269291403", "name": "بدر يوسف ناصر الجبري", "phone": "966507193043", "gradeCode": "1416", "section": "2"}, {"sid": "N008711332", "name": "بلال نور الدين محمد رضا المصري", "phone": "966538864829", "gradeCode": "1416", "section": "2"}, {"sid": "1147050288", "name": "ثنيان بن مسلم بن عبود البرازي المطيري", "phone": "966530380338", "gradeCode": "1416", "section": "2"}, {"sid": "2272820149", "name": "حارثه مثنى عبدالساتر طليمات", "phone": "966550681683", "gradeCode": "1416", "section": "2"}, {"sid": "2276504236", "name": "حازم يحيى طايع عبدالباسط", "phone": "966531406930", "gradeCode": "1416", "section": "2"}, {"sid": "1150471397", "name": "حسين بن يحي بن علي العوفي", "phone": "966538190306", "gradeCode": "1416", "section": "2"}, {"sid": "2277185704", "name": "راكان نمران - باعاصم", "phone": "966506831273", "gradeCode": "1416", "section": "2"}, {"sid": "2276535651", "name": "سعد خالد خميس السويبق", "phone": "966556648006", "gradeCode": "1416", "section": "2"}, {"sid": "2274341730", "name": "سليمان فرج - باضاوي", "phone": "966558890695", "gradeCode": "1416", "section": "2"}, {"sid": "1140764810", "name": "طارق بن عبد الناصر بن سعد الزهراني", "phone": "966563007002", "gradeCode": "1416", "section": "2"}, {"sid": "2275933857", "name": "عبد الرحمن ياسر عبد الرحمن محمد", "phone": "966569251165", "gradeCode": "1416", "section": "2"}, {"sid": "2274375076", "name": "عبدالرحمن معاذ - ابوسل", "phone": "966591975263", "gradeCode": "1416", "section": "2"}, {"sid": "2270597616", "name": "عبدالعزيز ابراهيم فرحان العوادت", "phone": "966509430872", "gradeCode": "1416", "section": "2"}, {"sid": "1147725004", "name": "عبدالعزيز علي حسن القحطاني", "phone": "966508966664", "gradeCode": "1416", "section": "2"}, {"sid": "2274034418", "name": "عبدالله عبدالعزيز منهل دندشي", "phone": "966508778857", "gradeCode": "1416", "section": "2"}, {"sid": "2267247241", "name": "عبدالله فهد عبدالله سفيان", "phone": "966562229228", "gradeCode": "1416", "section": "2"}, {"sid": "2064035761", "name": "عبدالله محمود - المحمد", "phone": "966562452260", "gradeCode": "1416", "section": "2"}, {"sid": "2268680655", "name": "علي ابراهيم علي علوان", "phone": "966595952962", "gradeCode": "1416", "section": "2"}, {"sid": "1149504209", "name": "علي بن ناجي بن عبدالله الخلف", "phone": "966592211415", "gradeCode": "1416", "section": "2"}, {"sid": "2271894301", "name": "عمار ياسر عبدالقيوم محمدخير", "phone": "966535302853", "gradeCode": "1416", "section": "2"}, {"sid": "2270046580", "name": "عمر باسل جمال الشافعي", "phone": "966504908359", "gradeCode": "1416", "section": "2"}, {"sid": "2261677872", "name": "عمر علي - الحمصي", "phone": "966582891810", "gradeCode": "1416", "section": "2"}, {"sid": "2276182892", "name": "عمر محمد - ابراهيم", "phone": "966509284776", "gradeCode": "1416", "section": "2"}, {"sid": "1156176016", "name": "فارس بن عباس بن عبدالله الجمعه", "phone": "966509733554", "gradeCode": "1416", "section": "2"}, {"sid": "2274217765", "name": "فيصل ازهر موسى ابوصفيه", "phone": "966502947847", "gradeCode": "1416", "section": "2"}, {"sid": "2274121470", "name": "مالك انس عباس التوم", "phone": "966541700767", "gradeCode": "1416", "section": "2"}, {"sid": "2080995780", "name": "مجد معاذ محمد ربيعة", "phone": "966570308671", "gradeCode": "1416", "section": "2"}, {"sid": "2273276432", "name": "محمد حافظ محمد المحمد", "phone": "966554359463", "gradeCode": "1416", "section": "2"}, {"sid": "2272911757", "name": "محمد مصطفي - لصوي", "phone": "966506836645", "gradeCode": "1416", "section": "2"}, {"sid": "2271162402", "name": "محمد نجيب عبدالله العواضي", "phone": "966505681206", "gradeCode": "1416", "section": "2"}, {"sid": "2258401989", "name": "محمود هيثم محمود محمد", "phone": "966556183602", "gradeCode": "1416", "section": "2"}, {"sid": "0160253177", "name": "مكرم أمين محمد علي", "phone": "966577067494", "gradeCode": "1416", "section": "2"}, {"sid": "2273411880", "name": "مؤيد عصام الدين قاسم دياب", "phone": "966507553774", "gradeCode": "1416", "section": "2"}, {"sid": "2271240612", "name": "يحي صهيب عطية الغول", "phone": "966557662585", "gradeCode": "1416", "section": "2"}, {"sid": "2074110540", "name": "يزن اسامه عبدالله الجاحد", "phone": "966560602426", "gradeCode": "1416", "section": "2"}, {"sid": "2283771661", "name": "احمد امجد احمد جبران", "phone": "966505268997", "gradeCode": "1416", "section": "3"}, {"sid": "2283342554", "name": "احمد عبد السلام - القادري", "phone": "966561114148", "gradeCode": "1416", "section": "3"}, {"sid": "2283885370", "name": "احمد محمد - قاسم", "phone": "966559101265", "gradeCode": "1416", "section": "3"}, {"sid": "2277563298", "name": "تيم خالد - الطباع", "phone": "966558080672", "gradeCode": "1416", "section": "3"}, {"sid": "2526488602", "name": "حسن عماد مصطفى ابراهيم", "phone": "966542158877", "gradeCode": "1416", "section": "3"}, {"sid": "2281824942", "name": "حسن مـحمد - علي", "phone": "966555786268", "gradeCode": "1416", "section": "3"}, {"sid": "2283142038", "name": "حسين سامر حسين احمد", "phone": "966504879521", "gradeCode": "1416", "section": "3"}, {"sid": "2279599928", "name": "خالد دهري طة محمد", "phone": "966507073581", "gradeCode": "1416", "section": "3"}, {"sid": "2278189705", "name": "رمزي مهند رمزي قاسم", "phone": "966501673918", "gradeCode": "1416", "section": "3"}, {"sid": "2283947220", "name": "زياد عمر محمد طويلان", "phone": "966531060609", "gradeCode": "1416", "section": "3"}, {"sid": "2280313814", "name": "زياد مختار مهيوب سعيد", "phone": "966507944208", "gradeCode": "1416", "section": "3"}, {"sid": "2282778923", "name": "سعد وسيم كنعان الزيبق", "phone": "966503895476", "gradeCode": "1416", "section": "3"}, {"sid": "2282495387", "name": "سلطان عماد - عبدالرحمن", "phone": "966503449360", "gradeCode": "1416", "section": "3"}, {"sid": "2279245886", "name": "عبدالرحمن وائل - النجار", "phone": "966541321267", "gradeCode": "1416", "section": "3"}, {"sid": "2278051798", "name": "عبدالعزيز علاء الدين - بصله", "phone": "966530796435", "gradeCode": "1416", "section": "3"}, {"sid": "2280641818", "name": "عبدالعزيز محمد - ابراهيم", "phone": "966503822382", "gradeCode": "1416", "section": "3"}, {"sid": "1146297534", "name": "عبدالله بن ثويني بن مسفر الزهيري", "phone": "966543536992", "gradeCode": "1416", "section": "3"}, {"sid": "2283347819", "name": "عبدالله ياسر مصطفى العوض", "phone": "966598817156", "gradeCode": "1416", "section": "3"}, {"sid": "2279260281", "name": "عبدالملك مروان - صالح", "phone": "966552727007", "gradeCode": "1416", "section": "3"}, {"sid": "2282792171", "name": "علاء فؤاد - القباني", "phone": "966503891220", "gradeCode": "1416", "section": "3"}, {"sid": "2284124654", "name": "علي حسين حيدر عبدالولي", "phone": "966535794573", "gradeCode": "1416", "section": "3"}, {"sid": "2281992103", "name": "علي محمد خالد محمد احمد", "phone": "966508441207", "gradeCode": "1416", "section": "3"}, {"sid": "1148600982", "name": "عمار بن عبدالعزيز بن عبدالرحيم الغامدي", "phone": "966500020166", "gradeCode": "1416", "section": "3"}, {"sid": "2282904131", "name": "فارس احمد - الطه", "phone": "966555931001", "gradeCode": "1416", "section": "3"}, {"sid": "2281338299", "name": "فراس فرسان - عبدالغني", "phone": "966560776623", "gradeCode": "1416", "section": "3"}, {"sid": "2386233437", "name": "فهد راجح فضل العمري", "phone": "966533128891", "gradeCode": "1416", "section": "3"}, {"sid": "1146977945", "name": "فيصل بن عبدالرحمن بن يحيى حدادي", "phone": "966555883617", "gradeCode": "1416", "section": "3"}, {"sid": "2278988338", "name": "مجد فادي - السليمان", "phone": "966555424633", "gradeCode": "1416", "section": "3"}, {"sid": "2280969128", "name": "محمد أنس عبدالله بن عجاج", "phone": "966569999962", "gradeCode": "1416", "section": "3"}, {"sid": "2280778958", "name": "محمد خالد محمد عبدالرب", "phone": "966544508000", "gradeCode": "1416", "section": "3"}, {"sid": "2281535175", "name": "محمد صالح فهد - قيسر", "phone": "966559241411", "gradeCode": "1416", "section": "3"}, {"sid": "2280308756", "name": "محمد وسيم محمد الصباغ", "phone": "966561831836", "gradeCode": "1416", "section": "3"}, {"sid": "2283609556", "name": "منصور شداد حسن الوجيه", "phone": "966509992926", "gradeCode": "1416", "section": "3"}, {"sid": "2281138277", "name": "ياسر عساف عبدالحافظ غالب", "phone": "966557134562", "gradeCode": "1416", "section": "3"}, {"sid": "2279848168", "name": "ياسر محمد سالمين مخاشن", "phone": "966502211700", "gradeCode": "1416", "section": "3"}, {"sid": "2279880260", "name": "يوسف محمدرضوان - ريحاني", "phone": "966552226520", "gradeCode": "1416", "section": "3"}, {"sid": "2279000653", "name": "يونس حسين صالح حسين", "phone": "966504915457", "gradeCode": "1416", "section": "3"}, {"sid": "3788652638", "name": "ابراهيم نهاد عبدالوهاب النايف", "phone": "966509156040", "gradeCode": "1416", "section": "4"}, {"sid": "2289052868", "name": "أحمد عصام أحمد أبوزيد", "phone": "966509883030", "gradeCode": "1416", "section": "4"}, {"sid": "2279075416", "name": "أحمد فائز - علاو", "phone": "966533999415", "gradeCode": "1416", "section": "4"}, {"sid": "2291397517", "name": "احمد محبوب احمد المخلافي", "phone": "966508267251", "gradeCode": "1416", "section": "4"}, {"sid": "2286526856", "name": "احمد ياسين سيف نعمان", "phone": "966550590950", "gradeCode": "1416", "section": "4"}, {"sid": "2289195667", "name": "اسامه ماهر علي صالح", "phone": "966509198923", "gradeCode": "1416", "section": "4"}, {"sid": "2292133531", "name": "امير احمد جميل ابوسل", "phone": "966505972401", "gradeCode": "1416", "section": "4"}, {"sid": "2285142853", "name": "انس وليد احمد عبدالعزيز محمود", "phone": "966503462272", "gradeCode": "1416", "section": "4"}, {"sid": "2285171621", "name": "أيمن محمد صالح الجيلاني", "phone": "966540849363", "gradeCode": "1416", "section": "4"}, {"sid": "2293552911", "name": "تركي عبدالله علي الشبيبي", "phone": "966503958047", "gradeCode": "1416", "section": "4"}, {"sid": "2292429905", "name": "حسام سمير صبحي البابا", "phone": "966543494623", "gradeCode": "1416", "section": "4"}, {"sid": "1148992348", "name": "سعد بن بندر بن جبار المطيري", "phone": "966566532227", "gradeCode": "1416", "section": "4"}, {"sid": "2293933251", "name": "سلمان سليمان ابراهيم ابو عزة", "phone": "966502207776", "gradeCode": "1416", "section": "4"}, {"sid": "2291617328", "name": "سلمان عبدالله أحمد باصره", "phone": "966507617060", "gradeCode": "1416", "section": "4"}, {"sid": "2284251093", "name": "سليم فطين سليم محمد مسعود", "phone": "966565009420", "gradeCode": "1416", "section": "4"}, {"sid": "2289002525", "name": "طارق محمد ابراهيم عبدون", "phone": "966502293966", "gradeCode": "1416", "section": "4"}, {"sid": "2285968794", "name": "عادل عماد حسن الشيوري", "phone": "966502060114", "gradeCode": "1416", "section": "4"}, {"sid": "2354639235", "name": "عايض محمد عبدالله الكثيري", "phone": "966505934468", "gradeCode": "1416", "section": "4"}, {"sid": "2289830115", "name": "عبدالرحمن مجدي حامد الخراشي", "phone": "966583195727", "gradeCode": "1416", "section": "4"}, {"sid": "2291142814", "name": "عبدالعزيز ايمن علي الموسي", "phone": "966505726620", "gradeCode": "1416", "section": "4"}, {"sid": "1148400193", "name": "عبدالعزيز بن يوسف بن محمد الصليبيخ", "phone": "966505927596", "gradeCode": "1416", "section": "4"}, {"sid": "2285956351", "name": "عبدالعزيز سمير سالم بن صويلح", "phone": "966503812936", "gradeCode": "1416", "section": "4"}, {"sid": "2297477511", "name": "عبدالله علي حسين عبده العمري", "phone": "966553658060", "gradeCode": "1416", "section": "4"}, {"sid": "2286994930", "name": "عثمان عبد القيوم الامين العوض", "phone": "966501559399", "gradeCode": "1416", "section": "4"}, {"sid": "2288430032", "name": "عقيل نبيل عقيل يوسف", "phone": "966567400054", "gradeCode": "1416", "section": "4"}, {"sid": "2290869060", "name": "علي فهمي مبارك سهيل", "phone": "966501084578", "gradeCode": "1416", "section": "4"}, {"sid": "2296061100", "name": "عمر محمد عمر العمودي", "phone": "966532634803", "gradeCode": "1416", "section": "4"}, {"sid": "2285531170", "name": "فاروق سمير - سقباني", "phone": "966500011058", "gradeCode": "1416", "section": "4"}, {"sid": "2284837420", "name": "مبارك خالد محمد حمد", "phone": "966558109141", "gradeCode": "1416", "section": "4"}, {"sid": "2286086984", "name": "مبارك عبدالله - نصير", "phone": "966562166601", "gradeCode": "1416", "section": "4"}, {"sid": "2289390896", "name": "محمد خالد محمد عبدالله", "phone": "966552412523", "gradeCode": "1416", "section": "4"}, {"sid": "2284509805", "name": "محمد رفاعي عطاالامين زبير", "phone": "966542625045", "gradeCode": "1416", "section": "4"}, {"sid": "1133000420", "name": "مهند خالد فرنيص اليامي", "phone": "966502264250", "gradeCode": "1416", "section": "4"}, {"sid": "2286299512", "name": "ناصر جمال احمد عبدالله", "phone": "966567674903", "gradeCode": "1416", "section": "4"}, {"sid": "2334080732", "name": "همام عبدالله عبده مندع", "phone": "966508181834", "gradeCode": "1416", "section": "4"}, {"sid": "2292795578", "name": "ورد عبدالسلام عدنان القده", "phone": "966553644071", "gradeCode": "1416", "section": "4"}, {"sid": "1147954950", "name": "أبوبكر بن محمد بن ابوبكر بالحارث", "phone": "966559595174", "gradeCode": "1416", "section": "5"}, {"sid": "N006307345", "name": "احمد ياسر محمد بستاني", "phone": "966559580821", "gradeCode": "1416", "section": "5"}, {"sid": "2290738711", "name": "براء محمد جمال سعيد عبدالعظيم", "phone": "966559178845", "gradeCode": "1416", "section": "5"}, {"sid": "2305892628", "name": "تركي فائز سالم بن حيدره", "phone": "966563765157", "gradeCode": "1416", "section": "5"}, {"sid": "2281232674", "name": "تميم عبدالرحمن عبدالقادر المنصوري", "phone": "966504987961", "gradeCode": "1416", "section": "5"}, {"sid": "2354910040", "name": "حسام خالد محمد احمد", "phone": "966507950700", "gradeCode": "1416", "section": "5"}, {"sid": "2388783793", "name": "حمزه محمد عبد الرازق عبد الرازق", "phone": "966546735980", "gradeCode": "1416", "section": "5"}, {"sid": "2475562233", "name": "خالد محمد - حبلي", "phone": "966533645144", "gradeCode": "1416", "section": "5"}, {"sid": "2392826851", "name": "خالد ناصر احمد سعدالدين", "phone": "966504836506", "gradeCode": "1416", "section": "5"}, {"sid": "2500636085", "name": "خطاب بهاء الدين طايل حمد", "phone": "966537122480", "gradeCode": "1416", "section": "5"}, {"sid": "2343612301", "name": "سالم وليد سالم بافقيه", "phone": "966535752186", "gradeCode": "1416", "section": "5"}, {"sid": "2299888665", "name": "سامر رمزي ناجي المنصوب", "phone": "966535132117", "gradeCode": "1416", "section": "5"}, {"sid": "2255325249", "name": "سعود خالد - نهيد", "phone": "966565239411", "gradeCode": "1416", "section": "5"}, {"sid": "2234095707", "name": "سعيد صلاح محمد العماري", "phone": "966503821798", "gradeCode": "1416", "section": "5"}, {"sid": "3937885469", "name": "سلطان غسان عبدالله علوان", "phone": "966502476196", "gradeCode": "1416", "section": "5"}, {"sid": "2313281780", "name": "سلطان فوزي ناصر صالح العامري", "phone": "966566609055", "gradeCode": "1416", "section": "5"}, {"sid": "2344016973", "name": "سيد هاني سيد احمد", "phone": "966535818661", "gradeCode": "1416", "section": "5"}, {"sid": "2388469054", "name": "صابر محمد صابر امين محمد", "phone": "966545818225", "gradeCode": "1416", "section": "5"}, {"sid": "2314430352", "name": "طلال صالح احمد ابوزيد", "phone": "966559555551", "gradeCode": "1416", "section": "5"}, {"sid": "2358938096", "name": "عاصم صبري علي علي", "phone": "966507145143", "gradeCode": "1416", "section": "5"}, {"sid": "2431870399", "name": "عبدالحميد بابكر نورالدين عبدالمولى", "phone": "966502125788", "gradeCode": "1416", "section": "5"}, {"sid": "2306233616", "name": "عبدالرحمن ابراهيم - ايت ناصر", "phone": "966537117551", "gradeCode": "1416", "section": "5"}, {"sid": "2074456702", "name": "عبدالرحمن محمد خليل شنيره", "phone": "966557130664", "gradeCode": "1416", "section": "5"}, {"sid": "2500889288", "name": "عبدالمتعال مصطفى عبدالمتعال السيد", "phone": "966541345986", "gradeCode": "1416", "section": "5"}, {"sid": "N008186123", "name": "عبدالمجيد مازن عبدالمجيد الحافظ", "phone": "966506841897", "gradeCode": "1416", "section": "5"}, {"sid": "2356103834", "name": "عثمان عبدالله احمد علي", "phone": "966546684363", "gradeCode": "1416", "section": "5"}, {"sid": "2306569928", "name": "عمار ياسر علي بن عقيل", "phone": "966508340055", "gradeCode": "1416", "section": "5"}, {"sid": "2341197768", "name": "عمر ايهاب عايد محمود ابو علي", "phone": "966536959357", "gradeCode": "1416", "section": "5"}, {"sid": "2377181058", "name": "عمر علي محمد قدورة", "phone": "966552424394", "gradeCode": "1416", "section": "5"}, {"sid": "2530537808", "name": "عمرو مكاوي علي الامين", "phone": "966558289542", "gradeCode": "1416", "section": "5"}, {"sid": "2359515885", "name": "فيصل احمد - حوري", "phone": "966508263499", "gradeCode": "1416", "section": "5"}, {"sid": "2351811837", "name": "قصي عبدالسلام اسماعيل الجابري", "phone": "966570450695", "gradeCode": "1416", "section": "5"}, {"sid": "4151314921", "name": "محمد احمد حبيب عطيه", "phone": "966538478816", "gradeCode": "1416", "section": "5"}, {"sid": "2331058368", "name": "محمد رائد ماجد عبدالله", "phone": "966551501908", "gradeCode": "1416", "section": "5"}, {"sid": "2389933793", "name": "محمد فيصل محمدصالح عبد الله", "phone": "966541355975", "gradeCode": "1416", "section": "5"}, {"sid": "6050819139", "name": "محمد قناف محمد سالم", "phone": "966558338683", "gradeCode": "1416", "section": "5"}, {"sid": "2303827592", "name": "محمد مجدي عبدالحميد عبدالغفار", "phone": "966564016820", "gradeCode": "1416", "section": "5"}, {"sid": "4020386399", "name": "مهند محمد صالح بن سميدع", "phone": "966571630846", "gradeCode": "1416", "section": "5"}, {"sid": "2353559939", "name": "ميسره عكرمه ميسره طعمه", "phone": "966500188125", "gradeCode": "1416", "section": "5"}, {"sid": "1041572379", "name": "يوسف احمد علي المريحل", "phone": "966545050059", "gradeCode": "1416", "section": "6"}, {"sid": "4825410279", "name": "أحمد الباقر عبدالقادر الباقر", "phone": "966500491550", "gradeCode": "1516", "section": "1"}, {"sid": "1138639339", "name": "أحمد بن وليد بن أحمد الأصمخ", "phone": "966507277447", "gradeCode": "1516", "section": "1"}, {"sid": "0160258130", "name": "أحمد حسن أحمد البريكي", "phone": "966503514111", "gradeCode": "1516", "section": "1"}, {"sid": "2253891150", "name": "احمد محمد احمد صالح", "phone": "966534454618", "gradeCode": "1516", "section": "1"}, {"sid": "1143012167", "name": "إلياس بن مسير بن عوض المطيري", "phone": "966503437566", "gradeCode": "1516", "section": "1"}, {"sid": "2120363921", "name": "اياد خالد عبدالله بانواس", "phone": "966564664838", "gradeCode": "1516", "section": "1"}, {"sid": "2277899007", "name": "خالد باسل سعود موسى", "phone": "966556530080", "gradeCode": "1516", "section": "1"}, {"sid": "1144621701", "name": "خالد بن فيصل بن عبدالله السويلم", "phone": "966551066268", "gradeCode": "1516", "section": "1"}, {"sid": "1142125960", "name": "راكان بن علي بن عوض الفقيه الشهري", "phone": "966530898088", "gradeCode": "1516", "section": "1"}, {"sid": "0160505940", "name": "ردفان أنور حسين العياشي", "phone": "966559326884", "gradeCode": "1516", "section": "1"}, {"sid": "0160258665", "name": "زيد توفيق حسن البارد", "phone": "966558584385", "gradeCode": "1516", "section": "1"}, {"sid": "1143378725", "name": "سالم بن عبدالعزيز بن سالم آل راكان", "phone": "966555566026", "gradeCode": "1516", "section": "1"}, {"sid": "2243041544", "name": "سالم سعيد - بشرى", "phone": "966578455024", "gradeCode": "1516", "section": "1"}, {"sid": "1144522610", "name": "سعود بن صادق بن جاسم السليم", "phone": "966595492889", "gradeCode": "1516", "section": "1"}, {"sid": "1144783790", "name": "سلطان بن أحمد بن محمد اللحيدان", "phone": "966543302200", "gradeCode": "1516", "section": "1"}, {"sid": "0160512222", "name": "سلطان عادل سيف سيف العبادي", "phone": "966504551072", "gradeCode": "1516", "section": "1"}, {"sid": "1144168729", "name": "عبدالعزيز بن خالد بن سالم باوهال", "phone": "966543003282", "gradeCode": "1516", "section": "1"}, {"sid": "1144207832", "name": "عبدالعزيز بن وليد بن أحمد الأصمخ", "phone": "966507277447", "gradeCode": "1516", "section": "1"}, {"sid": "0160501817", "name": "عبدالعزيز خالد عبدالله سيعد", "phone": "966501139557", "gradeCode": "1516", "section": "1"}, {"sid": "2252745621", "name": "عبداللة محمد - نقح", "phone": "966563770187", "gradeCode": "1516", "section": "1"}, {"sid": "1141810471", "name": "عبدالله بن اسعد بن عبدالمنعم الاحمدي", "phone": "966506636269", "gradeCode": "1516", "section": "1"}, {"sid": "1201142773", "name": "عبدالله بن زكريا بن احمد الحمران الدوسري", "phone": "966542553490", "gradeCode": "1516", "section": "1"}, {"sid": "1141882942", "name": "عبدالله بن مشاري بن مبارك الحزيمي الدوسري", "phone": "966540320324", "gradeCode": "1516", "section": "1"}, {"sid": "0160472493", "name": "عبدالله حسين عمر المطري", "phone": "966531492120", "gradeCode": "1516", "section": "1"}, {"sid": "2120363920", "name": "عبدالله خالد عبدالله بانواس", "phone": "966564664838", "gradeCode": "1516", "section": "1"}, {"sid": "0160472487", "name": "عبدالله صلاح علي علوان", "phone": "966551482228", "gradeCode": "1516", "section": "1"}, {"sid": "0160518165", "name": "عبدالله محمد عبدالله النسي", "phone": "966501364318", "gradeCode": "1516", "section": "1"}, {"sid": "4766954228", "name": "عمار ياسر  باحكم", "phone": "966557930070", "gradeCode": "1516", "section": "1"}, {"sid": "1200336111", "name": "فارس بن عايد بن عبدالله السيحاني العتيبي", "phone": "966540552122", "gradeCode": "1516", "section": "1"}, {"sid": "1143574448", "name": "فارس بن فيصل بن خليفة العرفة", "phone": "966504853090", "gradeCode": "1516", "section": "1"}, {"sid": "2257856969", "name": "فيصل فهد حيدره احمد", "phone": "966551236620", "gradeCode": "1516", "section": "1"}, {"sid": "1136838537", "name": "محمد بن علي بن محمد الرهيش", "phone": "966504996616", "gradeCode": "1516", "section": "1"}, {"sid": "2264852860", "name": "محمد خالد - الجلاب", "phone": "966508962159", "gradeCode": "1516", "section": "1"}, {"sid": "2250281512", "name": "محمد شريف محمد شريف", "phone": "966590113786", "gradeCode": "1516", "section": "1"}, {"sid": "2250346851", "name": "محمد عبدالله عمر الكلدي", "phone": "966508991949", "gradeCode": "1516", "section": "1"}, {"sid": "2252850496", "name": "محمد عمر عبدالله عكاوي", "phone": "966531624809", "gradeCode": "1516", "section": "1"}, {"sid": "2253796938", "name": "محمود شهير - العثمان", "phone": "966508338211", "gradeCode": "1516", "section": "1"}, {"sid": "1143120945", "name": "مسفر بن محمد بن عائض ملهي الصيعري", "phone": "966556444083", "gradeCode": "1516", "section": "1"}, {"sid": "1142699030", "name": "مهدي بن عبدالرؤف بن محمد البشر", "phone": "966532846300", "gradeCode": "1516", "section": "1"}, {"sid": "1153302649", "name": "مهند حسين محمد حراج", "phone": "966533680802", "gradeCode": "1516", "section": "1"}, {"sid": "0160253179", "name": "نصر شوقي نصر الجماعي", "phone": "966507800117", "gradeCode": "1516", "section": "1"}, {"sid": "1147718314", "name": "وليد بن خالد بن سعيد احمدي المالكي", "phone": "966556339081", "gradeCode": "1516", "section": "1"}, {"sid": "004404988", "name": "يوسف محمد فادي الخطيب", "phone": "966543308770", "gradeCode": "1516", "section": "1"}, {"sid": "2260457045", "name": "احمد رامي - التلا", "phone": "966549900555", "gradeCode": "1516", "section": "2"}, {"sid": "2264452380", "name": "احمد صالح محمد محسن", "phone": "966509824977", "gradeCode": "1516", "section": "2"}, {"sid": "2255039634", "name": "البراء عبد الفتاح صادق عوده", "phone": "966505881276", "gradeCode": "1516", "section": "2"}, {"sid": "2260490087", "name": "انس محمد بشار - شروف", "phone": "966504139503", "gradeCode": "1516", "section": "2"}, {"sid": "2256253952", "name": "ايمن راتب - الرحال", "phone": "966539155409", "gradeCode": "1516", "section": "2"}, {"sid": "2256029097", "name": "تركي امين حسن هزاع", "phone": "966551515780", "gradeCode": "1516", "section": "2"}, {"sid": "2260389354", "name": "جواد بن ابراهيم - حيدر", "phone": "966583366990", "gradeCode": "1516", "section": "2"}, {"sid": "2285968786", "name": "حسن عماد حسن الشيوري", "phone": "966533581348", "gradeCode": "1516", "section": "2"}, {"sid": "2258213921", "name": "ريان يحي قايد العديني", "phone": "966530137800", "gradeCode": "1516", "section": "2"}, {"sid": "2250280977", "name": "زايد دارس محمد عبدالله", "phone": "966533355166", "gradeCode": "1516", "section": "2"}, {"sid": "2257803342", "name": "زياد طارق ابو علول -", "phone": "966502959255", "gradeCode": "1516", "section": "2"}, {"sid": "2263270700", "name": "زياد محمد - القابوني", "phone": "966552799006", "gradeCode": "1516", "section": "2"}, {"sid": "2263329290", "name": "زيد حسام عبدالرحيم حمد", "phone": "966582899702", "gradeCode": "1516", "section": "2"}, {"sid": "3028401290", "name": "زيد محمد عبدالحميد الشاعر", "phone": "966561350188", "gradeCode": "1516", "section": "2"}, {"sid": "2256897774", "name": "عبد الرحمن سعيد على رياض", "phone": "966546373163", "gradeCode": "1516", "section": "2"}, {"sid": "2261255513", "name": "عبدالحكيم زاهر عبدالحكيم خنجر", "phone": "966549494943", "gradeCode": "1516", "section": "2"}, {"sid": "2257671269", "name": "عبدالرحمن مختار عبدالرحمن مختار", "phone": "966501261505", "gradeCode": "1516", "section": "2"}, {"sid": "2264340429", "name": "عبدالصمد أمين عبدالله الرداعي", "phone": "966551759129", "gradeCode": "1516", "section": "2"}, {"sid": "2273561387", "name": "عبدالعزيز بندر احمد العمودي", "phone": "966505759682", "gradeCode": "1516", "section": "2"}, {"sid": "2261074336", "name": "عمر طارق سعيد حمايده", "phone": "966550139287", "gradeCode": "1516", "section": "2"}, {"sid": "2257117479", "name": "فارس خالـد محمد الخواجة", "phone": "966531494307", "gradeCode": "1516", "section": "2"}, {"sid": "2255783926", "name": "ليث جمال محمد حطاب", "phone": "966551946842", "gradeCode": "1516", "section": "2"}, {"sid": "2256884699", "name": "مبارك سالم مبروك بن نهيد", "phone": "966544809193", "gradeCode": "1516", "section": "2"}, {"sid": "1142689882", "name": "متعب بن سمير بن عبدالله الودعاني الدوسري", "phone": "966598675174", "gradeCode": "1516", "section": "2"}, {"sid": "2254299460", "name": "محمد احمد علي عسكري", "phone": "966559809906", "gradeCode": "1516", "section": "2"}, {"sid": "2253988071", "name": "محمد أحمد محمد عبد الغفار", "phone": "966506830533", "gradeCode": "1516", "section": "2"}, {"sid": "2263270361", "name": "محمود مهند محمود مليشو", "phone": "966569540890", "gradeCode": "1516", "section": "2"}, {"sid": "2257820114", "name": "مصطفى نادر رضا حمد", "phone": "966554308011", "gradeCode": "1516", "section": "2"}, {"sid": "2264029097", "name": "معتز خالد احمد باسويد", "phone": "966505810195", "gradeCode": "1516", "section": "2"}, {"sid": "2257370805", "name": "مهند محمد علي شعلان", "phone": "966506559022", "gradeCode": "1516", "section": "2"}, {"sid": "2263012045", "name": "مهند مراد سعيد نصر", "phone": "966551515993", "gradeCode": "1516", "section": "2"}, {"sid": "2264624228", "name": "هادي باسل - غملوش", "phone": "966500700988", "gradeCode": "1516", "section": "2"}, {"sid": "2261167536", "name": "هذال بن منيب - الحسو", "phone": "966552604914", "gradeCode": "1516", "section": "2"}, {"sid": "2254969443", "name": "وسيم احمد فوزي ابودقه", "phone": "966502638306", "gradeCode": "1516", "section": "2"}, {"sid": "2256971124", "name": "يحيى عمر مسعد قاسم", "phone": "966503834971", "gradeCode": "1516", "section": "2"}, {"sid": "2259890438", "name": "يزن ماجد كامل العطاونه", "phone": "966505197899", "gradeCode": "1516", "section": "2"}, {"sid": "2276954688", "name": "يوسف سعيد عبدالرحمن العمودي", "phone": "966564042008", "gradeCode": "1516", "section": "2"}, {"sid": "2254477819", "name": "احمد محمود عبدالرؤوف شحاده", "phone": "966530290049", "gradeCode": "1516", "section": "3"}, {"sid": "2257419529", "name": "أسامة سليم راتب شري", "phone": "966504828942", "gradeCode": "1516", "section": "3"}, {"sid": "2264778388", "name": "أشرف الصادق قسم السيد فضل المولى", "phone": "966502218531", "gradeCode": "1516", "section": "3"}, {"sid": "03312L041597", "name": "باسل عامر - الطباع", "phone": "966551556789", "gradeCode": "1516", "section": "3"}, {"sid": "2281969424", "name": "تيم وائل محمد يوسف علي", "phone": "966546996828", "gradeCode": "1516", "section": "3"}, {"sid": "2266020060", "name": "جابر حبيب - غويش", "phone": "966556328441", "gradeCode": "1516", "section": "3"}, {"sid": "2271216273", "name": "خضر مصطفى - دريعي", "phone": "966536368360", "gradeCode": "1516", "section": "3"}, {"sid": "2309795942", "name": "سعيد أحمد مبارك بن حويل", "phone": "966553410339", "gradeCode": "1516", "section": "3"}, {"sid": "2253890624", "name": "سعيد صالح سعيد باطاهر", "phone": "966501554367", "gradeCode": "1516", "section": "3"}, {"sid": "2265265146", "name": "سيف جهاد احمد الزرقان", "phone": "966503976466", "gradeCode": "1516", "section": "3"}, {"sid": "2266307871", "name": "صالح حسين احمد شلبي", "phone": "966535180803", "gradeCode": "1516", "section": "3"}, {"sid": "2276535586", "name": "صالح سعيد صالح الهميمي", "phone": "966507316078", "gradeCode": "1516", "section": "3"}, {"sid": "2267610281", "name": "صلاح الدين محمد حمدالله محمودعلي", "phone": "966536195508", "gradeCode": "1516", "section": "3"}, {"sid": "2266223565", "name": "عادل مهند توفيق عبد ربه", "phone": "966571642499", "gradeCode": "1516", "section": "3"}, {"sid": "2530375910", "name": "عبدالرازق عادل عبدون علي", "phone": "966502241191", "gradeCode": "1516", "section": "3"}, {"sid": "2273759148", "name": "عبدالرحمن ايمن عبدالرحمن بصله", "phone": "966541693991", "gradeCode": "1516", "section": "3"}, {"sid": "2271300705", "name": "عبدالرحمن وائل - البيجاوي", "phone": "966505840646", "gradeCode": "1516", "section": "3"}, {"sid": "1152253660", "name": "عبدالعزيز بن عبدالله بن عبدالعزيز الصانع", "phone": "966509998445", "gradeCode": "1516", "section": "3"}, {"sid": "2267688311", "name": "عبدالقادر علاء عبدالقادر السعيد", "phone": "966508401455", "gradeCode": "1516", "section": "3"}, {"sid": "2265266433", "name": "عبدالله عمر عبدالله بن شملان", "phone": "966500108698", "gradeCode": "1516", "section": "3"}, {"sid": "2275538128", "name": "عبدالله فارس عبدالله بادعام", "phone": "966530734340", "gradeCode": "1516", "section": "3"}, {"sid": "2269118598", "name": "عبدالله محمد عبدالله باحارثه", "phone": "966556183504", "gradeCode": "1516", "section": "3"}, {"sid": "2285179566", "name": "علي خالد علي الشوكاني", "phone": "966547978940", "gradeCode": "1516", "section": "3"}, {"sid": "2262500883", "name": "علي مقبل علي مرشد", "phone": "966567854303", "gradeCode": "1516", "section": "3"}, {"sid": "2288272343", "name": "عمر شايف مسعد الجملي", "phone": "966509562575", "gradeCode": "1516", "section": "3"}, {"sid": "1135151783", "name": "فهد بن خالد بن شافي القاسم", "phone": "966507569756", "gradeCode": "1516", "section": "3"}, {"sid": "2267801930", "name": "فيصل ابراهيم - قشير", "phone": "966594219917", "gradeCode": "1516", "section": "3"}, {"sid": "2289248649", "name": "قصي محمداياد احمد الزنبركجي", "phone": "966544148311", "gradeCode": "1516", "section": "3"}, {"sid": "2270632934", "name": "ليث اسماعيل - العلوه", "phone": "966508123556", "gradeCode": "1516", "section": "3"}, {"sid": "2265200960", "name": "مبارك حسن عثمان الحسن", "phone": "966504972721", "gradeCode": "1516", "section": "3"}, {"sid": "2267755862", "name": "منذر عبدالله محمد على", "phone": "966545040773", "gradeCode": "1516", "section": "3"}, {"sid": "2281843306", "name": "مهند عطاء علم الدين محمد", "phone": "966556124097", "gradeCode": "1516", "section": "3"}, {"sid": "2265108361", "name": "مهند محمد طه ابوعامر", "phone": "966566293426", "gradeCode": "1516", "section": "3"}, {"sid": "2271172179", "name": "نور الدين نورس حمادة -", "phone": "966531205402", "gradeCode": "1516", "section": "3"}, {"sid": "2299260931", "name": "وسام بشير صالح بن صويلح", "phone": "966563191459", "gradeCode": "1516", "section": "3"}, {"sid": "2268909773", "name": "يوسف مراد منصور توفيق حمام", "phone": "966506816056", "gradeCode": "1516", "section": "3"}, {"sid": "2265980934", "name": "يوسف نعمـه - قادريه", "phone": "966596913199", "gradeCode": "1516", "section": "3"}, {"sid": "1141975506", "name": "أحمد بن خالد بن أحمد المجدوعي الشهري", "phone": "966560687900", "gradeCode": "1516", "section": "4"}, {"sid": "1142520475", "name": "أحمد بن عادل بن أحمد المجدوعي الشهري", "phone": "966553001980", "gradeCode": "1516", "section": "4"}, {"sid": "2413416567", "name": "احمد بهاء الدين احمد هريدى", "phone": "966542460199", "gradeCode": "1516", "section": "4"}, {"sid": "2356103826", "name": "احمد عبدالله احمد علي", "phone": "966502072019", "gradeCode": "1516", "section": "4"}, {"sid": "2370328821", "name": "احمد عمار احمد", "phone": "966552324752", "gradeCode": "1516", "section": "4"}, {"sid": "2319087835", "name": "احمد مصطفى عطا الجبور", "phone": "966538890767", "gradeCode": "1516", "section": "4"}, {"sid": "2419719055", "name": "احمد نور الاسلام عبدالمنصف حماد", "phone": "966594177367", "gradeCode": "1516", "section": "4"}, {"sid": "4175612086", "name": "اكرم معاذ أحمد زيد", "phone": "966501427268", "gradeCode": "1516", "section": "4"}, {"sid": "6059210870", "name": "الليث تميم محمد الاصنج", "phone": "966565379649", "gradeCode": "1516", "section": "4"}, {"sid": "4594843015", "name": "أنس محمد سعيد العبادي", "phone": "966548364505", "gradeCode": "1516", "section": "4"}, {"sid": "2473694954", "name": "ايمن العوض عمر احمد", "phone": "966556778764", "gradeCode": "1516", "section": "4"}, {"sid": "2302921883", "name": "حسين وليد عبدالله باطرفي", "phone": "966548585222", "gradeCode": "1516", "section": "4"}, {"sid": "2358509145", "name": "سالم خالد سالم هلابي المري", "phone": "966541303783", "gradeCode": "1516", "section": "4"}, {"sid": "2533189052", "name": "سامى مصطفى سامى عثمان", "phone": "966508181905", "gradeCode": "1516", "section": "4"}, {"sid": "2322964681", "name": "شادى السيد محمد السيد عبد الحميد", "phone": "966590249402", "gradeCode": "1516", "section": "4"}, {"sid": "4131705198", "name": "صالح حسين علوي حسين", "phone": "966501656407", "gradeCode": "1516", "section": "4"}, {"sid": "4157899438", "name": "طلال صادق حميد الشيباني", "phone": "966504306465", "gradeCode": "1516", "section": "4"}, {"sid": "2332595122", "name": "عبدالرحمن فالح مصطفى الهندي", "phone": "966500655081", "gradeCode": "1516", "section": "4"}, {"sid": "1144010574", "name": "علي بن عبدالمحسن بن احمد الجويد", "phone": "966505855700", "gradeCode": "1516", "section": "4"}, {"sid": "N00735725", "name": "عمر احمد - الحبال", "phone": "966598772016", "gradeCode": "1516", "section": "4"}, {"sid": "N004380331", "name": "عمر نضال - اللبابيدي", "phone": "966545677595", "gradeCode": "1516", "section": "4"}, {"sid": "2506314679", "name": "عمر هيثم عبدالحميد جبر", "phone": "966594148700", "gradeCode": "1516", "section": "4"}, {"sid": "4726523741", "name": "عمرو وضاح عباد عوض", "phone": "966551696535", "gradeCode": "1516", "section": "4"}, {"sid": "2367437221", "name": "غالب ضياء غالب يعقوب", "phone": "966547929697", "gradeCode": "1516", "section": "4"}, {"sid": "4594842967", "name": "مالك محمد سعيد العبادي", "phone": "966548364505", "gradeCode": "1516", "section": "4"}, {"sid": "2320747757", "name": "مالك محمد مقبل عبدالله", "phone": "966550924548", "gradeCode": "1516", "section": "4"}, {"sid": "007147880", "name": "محمد أبي محمد كمال يحيى الشعراوي", "phone": "966537598996", "gradeCode": "1516", "section": "4"}, {"sid": "2329213116", "name": "محمد عبدالرحمن محمد سلام", "phone": "966562221981", "gradeCode": "1516", "section": "4"}, {"sid": "4677834535", "name": "محمد عبدالسلام صالح قايد الغيثي", "phone": "966508913140", "gradeCode": "1516", "section": "4"}, {"sid": "4853468405", "name": "محمد عمر احمد الخنبشي", "phone": "966504487033", "gradeCode": "1516", "section": "4"}, {"sid": "09685836", "name": "محمد محمد سعد القحازي", "phone": "966550657440", "gradeCode": "1516", "section": "4"}, {"sid": "2555671169", "name": "محمود محسن جمال الدين علي", "phone": "966500284832", "gradeCode": "1516", "section": "4"}, {"sid": "2265260295", "name": "معاذ خالد أحمد عثمان", "phone": "966506177794", "gradeCode": "1516", "section": "4"}, {"sid": "2389933801", "name": "مهند فيصل محمد صالح عبد الله", "phone": "966541355975", "gradeCode": "1516", "section": "4"}, {"sid": "2556070825", "name": "وليد طارق الحسن محمد", "phone": "966540008359", "gradeCode": "1516", "section": "4"}, {"sid": "2356549002", "name": "يوسف أحمد حافظ محمد", "phone": "966546176818", "gradeCode": "1516", "section": "4"}, {"sid": "2356228334", "name": "يوسف هيثم السيد السيد", "phone": "966568383249", "gradeCode": "1516", "section": "4"}, {"sid": "9683618478", "name": "ابراهيم سعيد محمد بامقابل", "phone": "966532106950", "gradeCode": "1516", "section": "5"}, {"sid": "2252299090", "name": "احمد القذافي محمد عبدالله", "phone": "966563246030", "gradeCode": "1516", "section": "5"}, {"sid": "2269543779", "name": "احمد محمد شعبان القادري", "phone": "966555811037", "gradeCode": "1516", "section": "5"}, {"sid": "2257423497", "name": "المؤيد عبدالناصر عبدالكريم النعيمي", "phone": "966599944604", "gradeCode": "1516", "section": "5"}, {"sid": "2254967066", "name": "تركـي عبدالله - ابوالحسن", "phone": "966501180302", "gradeCode": "1516", "section": "5"}, {"sid": "2305874568", "name": "حسام احمد توفيق مرعي", "phone": "966559674986", "gradeCode": "1516", "section": "5"}, {"sid": "2255508307", "name": "حسام حسن محمد عبده", "phone": "966500571781", "gradeCode": "1516", "section": "5"}, {"sid": "2262212497", "name": "حسن يوسف حسن أحمد", "phone": "966506034051", "gradeCode": "1516", "section": "5"}, {"sid": "2292258270", "name": "خالد فهد مبخوت الشبيبي", "phone": "966553332872", "gradeCode": "1516", "section": "5"}, {"sid": "1149849059", "name": "راكان بن سامي بن مبارك العتيق الدوسري", "phone": "966570964863", "gradeCode": "1516", "section": "5"}, {"sid": "004166605", "name": "رائد إيهاب لامع الخطيب", "phone": "966543309770", "gradeCode": "1516", "section": "5"}, {"sid": "0160472491", "name": "زهير شهاب عبدالقوي قاسم", "phone": "966530326241", "gradeCode": "1516", "section": "5"}, {"sid": "2253882423", "name": "زياد اشرف موسى محمود", "phone": "966504942293", "gradeCode": "1516", "section": "5"}, {"sid": "2286386491", "name": "سالم سليمان سالم صويلح", "phone": "966531810001", "gradeCode": "1516", "section": "5"}, {"sid": "2263571404", "name": "سامر مروان عبدالرحمن دحبور", "phone": "966541522828", "gradeCode": "1516", "section": "5"}, {"sid": "4721012807", "name": "سليمان خالد سليمان بن نهيد", "phone": "966501958928", "gradeCode": "1516", "section": "5"}, {"sid": "2265978847", "name": "صالح عاصم - الزعبي", "phone": "966532468066", "gradeCode": "1516", "section": "5"}, {"sid": "2302921891", "name": "عبدالعزيز وليد عبدالله باطرفي", "phone": "966548585222", "gradeCode": "1516", "section": "5"}, {"sid": "2256896347", "name": "عبدالله ثامر السيد سليم علي", "phone": "966597075886", "gradeCode": "1516", "section": "5"}, {"sid": "2411879493", "name": "عبدالمؤمن ولاء الدين عمر حسن", "phone": "966537602402", "gradeCode": "1516", "section": "5"}, {"sid": "0160223325", "name": "عز الدين مصطفى عبد الستار علي", "phone": "966503492008", "gradeCode": "1516", "section": "5"}, {"sid": "2259910673", "name": "علي حسن علي باصريح", "phone": "966554997791", "gradeCode": "1516", "section": "5"}, {"sid": "2256718475", "name": "علي عبد الحافظ منصور", "phone": "966503881921", "gradeCode": "1516", "section": "5"}, {"sid": "4714521970", "name": "عمرو خالد عبدالله مرشد قايد", "phone": "966552808856", "gradeCode": "1516", "section": "5"}, {"sid": "1145312052", "name": "فيصل بن احمد بن عبدالعزيز بوسوده", "phone": "966558699916", "gradeCode": "1516", "section": "5"}, {"sid": "0160258128", "name": "قاسم محمد قاسم عبيد", "phone": "966503200924", "gradeCode": "1516", "section": "5"}, {"sid": "2252607524", "name": "محمد ابراهيم سعيد الصدفي", "phone": "966504752302", "gradeCode": "1516", "section": "5"}, {"sid": "2263805703", "name": "محمد خالد - سيف", "phone": "966509424497", "gradeCode": "1516", "section": "5"}, {"sid": "2266003785", "name": "محمد صلاح محسن صالح", "phone": "966504997192", "gradeCode": "1516", "section": "5"}, {"sid": "2274966460", "name": "محمد عبدالعزيز حمد الفكي", "phone": "966538862829", "gradeCode": "1516", "section": "5"}, {"sid": "2274404124", "name": "محمد ياسر محمد علي", "phone": "966569400999", "gradeCode": "1516", "section": "5"}, {"sid": "1140892157", "name": "منير بن حيدر بن حسين السلطان", "phone": "966546682025", "gradeCode": "1516", "section": "5"}, {"sid": "2269927360", "name": "مهند طارق عوده الله سويلم", "phone": "966504859866", "gradeCode": "1516", "section": "5"}, {"sid": "2074039024", "name": "هارون محمد صفوان الرفاعي", "phone": "966559038880", "gradeCode": "1516", "section": "5"}, {"sid": "1086183959", "name": "ابراهيم صالح بن حامد الحربي", "phone": "554487285", "gradeCode": "1516", "section": "6"}, {"sid": "1096783343", "name": "حيدر بن سعيد بن علي السويلم", "phone": "966548053496", "gradeCode": "1516", "section": "6"}, {"sid": "1080827460", "name": "سلمان بن حسن بن سلمان الوحيمد", "phone": "966599188265", "gradeCode": "1516", "section": "6"}, {"sid": "1085912291", "name": "محمد علي علي جعفري", "phone": "966543478037", "gradeCode": "1516", "section": "6"}];

/* ========== ربط الصفوف ========== */
const GRADE_MAP = {
  "1314": { label: "أول ثانوي", regular: 7, elearning: 8 },
  "1416": { label: "ثاني ثانوي", regular: 5, elearning: 6 },
  "1516": { label: "ثالث ثانوي", regular: 5, elearning: 6 },
};

/* ========== قوائم جاهزة (يمكن تعديلها) ========== */
const ATTENDANCE_LATE = [
  "تأخر صباحي",
  "تكرر التأخر/الغياب",
  "تنبيه لزيارة المدرسة (مواظبة)",
  "انقطاع عن الحصص"
];
const ATTENDANCE_ABSENT = [
  "غياب (بدون عذر)",
  "غياب (بعذر)",
  "تكرر التأخر/الغياب",
  "تنبيه لزيارة المدرسة (مواظبة)"
];
const BEHAVIOR_LIST = [
  "مخالفة سلوكية (الدرجة الأولى)",
  "مخالفة سلوكية (الدرجة الثانية)",
  "مخالفة سلوكية (الدرجة الثالثة)",
  "مخالفة سلوكية (الدرجة الرابعة)",
  "مخالفة سلوكية (الدرجة الخامسة)",
  "تنبيه لزيارة المدرسة (سلوك)"
];
const PERMIT_LIST = [
  "إذن دخول الفصل",
  "إذن خروج من المدرسة",
  "إذن خروج للعيادة/التوجيه الطلابي",
  "إذن انتقال/مراجعة الإدارة",
  "دعوة ولي الأمر لزيارة المدرسة"
];


/* ===== دليل المعلمين (مضمّن) ===== */
const PRELOADED_TEACHERS = [
  {
    "name": "ابراهيم بن أحمد بن ابراهيم العجلان",
    "phone": "966559999808"
  },
  {
    "name": "ابراهيم بن محمد بن ابراهيم الربيع",
    "phone": "966548638056"
  },
  {
    "name": "ابراهيم حبيب عبدالغني الميمني",
    "phone": "966530163027"
  },
  {
    "name": "احمد عبدالرحيم عبدالحميد ابوعصيده",
    "phone": "966546623431"
  },
  {
    "name": "بشير بن أحمد بن عبدالله آل سليم",
    "phone": "966500126925"
  },
  {
    "name": "بندر عبدالعزيز محمد الغامدي",
    "phone": "966546135135"
  },
  {
    "name": "تقي عبد الهادي تقي العلي",
    "phone": "966543219321"
  },
  {
    "name": "جميل عبدالمجيد جواد العلي",
    "phone": "966566712113"
  },
  {
    "name": "حسن بن عامربن احمد الشهري",
    "phone": "966598893731"
  },
  {
    "name": "حسن عبدالله علي العبدالله",
    "phone": "966543705512"
  },
  {
    "name": "حسن علي حسن الشهري",
    "phone": "966500677015"
  },
  {
    "name": "حسن يوسف حسين الخليفة",
    "phone": "966506907431"
  },
  {
    "name": "حسين بن سعيد سلمان المدن",
    "phone": "966556336875"
  },
  {
    "name": "حسين بن محمد بن حسين الأحمد",
    "phone": "966563740777"
  },
  {
    "name": "حسين بن محمد بن فهد القحطاني",
    "phone": "966504988086"
  },
  {
    "name": "خالد أحمد محمد الشهري",
    "phone": "966560687900"
  },
  {
    "name": "خالد سعد راشد المرضي",
    "phone": "966505877238"
  },
  {
    "name": "زياد عواض ابن عيضه العمري",
    "phone": "966557530102"
  },
  {
    "name": "عادل بن علي بن سليمان السبعان",
    "phone": "966504836200"
  },
  {
    "name": "عادل بن علي بن ناصر البارقي",
    "phone": "966530667666"
  },
  {
    "name": "عبد الله حسن عمر الادريسي",
    "phone": "966533025505"
  },
  {
    "name": "عبدالرحمن عبدالجبار حمود العتيبي",
    "phone": "966555741488"
  },
  {
    "name": "عبدالله بن خلوفة بن عبدالله ال مرعي",
    "phone": "966533225515"
  },
  {
    "name": "عبدالله بن عبدالعزيز بن سيف السهلي",
    "phone": "966546221133"
  },
  {
    "name": "عبدالله فيصل بن فطيس الهذلي",
    "phone": "966591585407"
  },
  {
    "name": "عبدالمجيد عبدالرحمن عبدالله السالمي",
    "phone": "966558151033"
  },
  {
    "name": "عبدالمجيد عبدالله سالم آل حبشان",
    "phone": "966500223640"
  },
  {
    "name": "عدنان علي حسين الزريق",
    "phone": "966505808451"
  },
  {
    "name": "علي بن حسن بن علي آل قمبر",
    "phone": "966502085389"
  },
  {
    "name": "علي سعد سعيد الاصلعي الاحمري",
    "phone": "966590986464"
  },
  {
    "name": "عماد محمد جمعان الزهراني",
    "phone": "966542203039"
  },
  {
    "name": "فرج عبدالعلي يوسف ال سيف",
    "phone": "966504113707"
  },
  {
    "name": "فهد حامد علي الزهراني",
    "phone": "966504532489"
  },
  {
    "name": "فيصل فهد علي الزهراني",
    "phone": "966508448455"
  },
  {
    "name": "محمد حمد عبدالرحمن التويجري",
    "phone": "966541381105"
  },
  {
    "name": "منذر عامر حمود زميع",
    "phone": "966541188974"
  },
  {
    "name": "موسى صلبان عبده عسيري",
    "phone": "966507058931"
  },
  {
    "name": "ناصر علي ناصر الراشد",
    "phone": "966542933888"
  },
  {
    "name": "نبيل بن محسن محمد القلاف",
    "phone": "966562962766"
  },
  {
    "name": "ياسر عبدالله محمد النمر",
    "phone": "966543705512"
  },
  {
    "name": "يحيى بن محمد بن سعيد القحطاني",
    "phone": "966555751385"
  },
  {
    "name": "يوسف عيسى عيسى العيد",
    "phone": "966592038351"
  }
];

/* ===== كتالوج المخالفات حسب الدرجات (مضمّن) ===== */
const BEHAVIOR_CATALOG = {
  "1": {
    "level": "بسيطة",
    "deduct": 1,
    "repeatOnly": true,
    "examples": [
      "التأخر الصباحي",
      "النوم في الفصل",
      "عدم الالتزام بالزي",
      "العبث أثناء الاصطفاف"
    ]
  },
  "2": {
    "level": "متوسطة",
    "deduct": 2,
    "repeatOnly": false,
    "examples": [
      "الشجار",
      "إثارة الفوضى",
      "الكتابة على الجدران",
      "استخدام الجوال دون إذن",
      "التلفظ بكلمات نابية"
    ]
  },
  "3": {
    "level": "عالية الخطورة",
    "deduct": 3,
    "repeatOnly": false,
    "examples": [
      "الهروب من المدرسة",
      "حيازة أدوات حادة",
      "تصوير الآخرين",
      "إتلاف ممتلكات المدرسة عمداً"
    ]
  },
  "4": {
    "level": "جسيمة",
    "deduct": 10,
    "repeatOnly": false,
    "examples": [
      "التدخين",
      "التنمر",
      "العبث بوسائل الأمن (إطفاء الحريق)",
      "تهديد المعلمين",
      "التحرش"
    ]
  },
  "5": {
    "level": "فائقة الخطورة",
    "deduct": 15,
    "repeatOnly": false,
    "examples": [
      "الاعتداء الجسدي العنيف",
      "حيازة مخدرات",
      "إشعال نار",
      "قضايا أمنية أو فكرية",
      "ابتزاز إلكتروني"
    ]
  }
};
const BEHAVIOR_DEGREE_LABEL = {"1": "الأولى", "2": "الثانية", "3": "الثالثة", "4": "الرابعة", "5": "الخامسة"};


/* ========== التخزين المحلي ========== */
const KEYS = {
  students: "ms_students_v10",
  records: "ms_records_v10",
  settings: "ms_settings_v10",
  teachers: "ms_teachers_v10"
};
const store = {
  get(key, fallback) {
    try { const raw = localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }
    catch(e){ return fallback; }
  },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

/* ========== حالة التطبيق ========== */
const state = {
  students: [],
  records: [],
  teachers: [],
  settings: { schoolName: "ثانوية اليعقوبي الثانوية بالخبر" },
  stage: "", section: "", q: "",
  listVisible: false,
  selectedSids: new Set(),
  profileSid: "",
  scanType: "late",
  quickAction: "late" // late | absent | behavior | permit
};

function $(id){ return document.getElementById(id); }
function icon(name){
  const icons={
    dots:`<svg viewBox="0 0 24 24" fill="none"><path d="M6 12a1.6 1.6 0 1 1-3.2 0A1.6 1.6 0 0 1 6 12Zm7.6 0A1.6 1.6 0 1 1 10.4 12a1.6 1.6 0 0 1 3.2 0ZM21.2 12A1.6 1.6 0 1 1 18 12a1.6 1.6 0 0 1 3.2 0Z" fill="currentColor"/></svg>`,
    search:`<svg viewBox="0 0 24 24" fill="none"><path d="M10.5 18.2a7.7 7.7 0 1 1 0-15.4 7.7 7.7 0 0 1 0 15.4Zm6.7-1.1 4 4" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg>`,
    check:`<svg viewBox="0 0 24 24" fill="none"><path d="M20 7 10 17l-5-5" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    close:`<svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg>`
  };
  return icons[name]||"";
}

function toast(msg){
  const t=$("toast"); $("toastInner").textContent=msg;
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2400);
}

function safeText(s){ return String(s||"").replace(/\s+/g," ").trim(); }
function uid(prefix="X"){ return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16); }

function nowInfo(){
  const d=new Date();

  // تاريخ ميلادي ثابت بصيغة YYYY-MM-DD (مهم للفرز والتقارير)
  const date=d.toLocaleDateString('en-CA'); // 2026-02-16

  // اسم اليوم بالعربية
  const day=d.toLocaleDateString('ar-SA',{weekday:'long'});

  // الوقت بالعربية (أرقام عربية + ص/م)
  const time=d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit',hour12:true});

  // صيغة عرض موحّدة داخل السجلات: "الاثنين - 2026-02-16 - ٠٩:٣٠ ص"
  const full=`${day} - ${date} - ${time}`;

  return {day,date,iso:date,time,full};
}


function normalizePhone(raw){
  let p=String(raw||"").trim();
  p=p.replace(/[\s\-\(\)]/g,"").replace(/^00/,"");
  const map={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
  p=p.replace(/[٠-٩]/g,(d)=>map[d]||d);
  if(!p) return "";
  if(p.startsWith("+")) p=p.slice(1);
  if(p.startsWith("05") && p.length===10) p="966"+p.slice(1);
  if(p.startsWith("5") && p.length===9) p="966"+p;
  return p;
}

/* ===== دليل المعلمين: دمج + قائمة منسدلة ===== */
function seedTeachersFromPreloaded(){
  // دمج "المضمّن" مع المحفوظ محليًا (بدون تكرار)
  const byName = new Map((state.teachers||[]).map(t=>[safeText(t.name), t]));
  for(const t of (PRELOADED_TEACHERS||[])){
    const n=safeText(t.name);
    const p=normalizePhone(t.phone);
    if(!n || !p) continue;
    if(!byName.has(n)){
      const obj={id:uid('T'), name:n, phone:p};
      state.teachers.push(obj);
      byName.set(n,obj);
    }
  }
  // حفظ بعد الدمج حتى لا يحتاج المستخدم لإعادة دمج كل مرة
  store.set(KEYS.teachers, state.teachers);
}

function refreshTeacherSelect(){
  const sel=$("teacherSelect");
  if(!sel) return;
  const opts = ['<option value="">اختر المعلم…</option>']
    .concat((state.teachers||[]).slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'','ar'))
      .map(t=>`<option value="${safeText(t.name)}" data-phone="${safeText(t.phone||'')}">${safeText(t.name)}</option>`));
  sel.innerHTML = opts.join('');
}

function fillTeacherFromSelect(){
  const sel=$("teacherSelect");
  if(!sel) return;
  const name = safeText(sel.value);
  if(!name){ $("teacherName").value=''; $("teacherPhone").value=''; return; }
  const t = (state.teachers||[]).find(x=>safeText(x.name)===name);
  if(t){
    $("teacherName").value = t.name||'';
    $("teacherPhone").value = t.phone||'';
  } else {
    // fallback من data
    const opt = sel.options[sel.selectedIndex];
    $("teacherName").value = name;
    $("teacherPhone").value = normalizePhone(opt?.getAttribute('data-phone')||'');
  }
}

/* ===== السلوك: درجات + مخالفات منسدلة + حسم ===== */
function isBehaviorDegreeSubtype(subtype){
  return /^مخالفة سلوكية\s*\(الدرجة\s+(الأولى|الثانية|الثالثة|الرابعة|الخامسة)\)/.test(String(subtype||''));
}
function behaviorDegreeFromSubtype(subtype){
  const s=String(subtype||'');
  if(s.includes('الأولى')) return 1;
  if(s.includes('الثانية')) return 2;
  if(s.includes('الثالثة')) return 3;
  if(s.includes('الرابعة')) return 4;
  if(s.includes('الخامسة')) return 5;
  return 0;
}
function populateBehaviorDegree(){
  const degSel=$("behDegree");
  if(!degSel) return;
  degSel.innerHTML = [1,2,3,4,5].map(n=>`<option value="${n}">الدرجة ${BEHAVIOR_DEGREE_LABEL[String(n)]||n}</option>`).join('');
}
function populateBehaviorInfractions(deg){
  const infSel=$("behInfraction");
  if(!infSel) return;
  const cat = BEHAVIOR_CATALOG[String(deg)] || BEHAVIOR_CATALOG[deg] || null;
  const list = (cat?.examples||[]).map(x=>safeText(x)).filter(Boolean);
  infSel.innerHTML = list.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function updateBehaviorDeductUI(){
  const deg = Number($("behDegree")?.value||0);
  const cat = BEHAVIOR_CATALOG[String(deg)] || BEHAVIOR_CATALOG[deg] || null;
  const hint=$("behDeductHint");
  if(!cat || !hint) return;
  const level = safeText(cat.level);
  let deduct = Number(cat.deduct||0);
  const repeatOnly = !!cat.repeatOnly;
  const repeat = !!$("behRepeat")?.checked;
  const showRepeat = (deg===1 && repeatOnly);
  $("behRepeatBox").style.display = showRepeat ? 'block' : 'none';
  if(showRepeat && !repeat) deduct = 0; // الدرجة الأولى: الحسم عند التكرار فقط
  hint.textContent = (deduct>0)
    ? `(${deduct}) ${deduct===1?'درجة واحدة':'درجات'} — مستوى: ${level}`
    : `لا يوجد حسم (أول مرة) — مستوى: ${level}`;
}
function syncBehaviorDetailBox(){
  const kind=$("sheetKind")?.value||'';
  const subtype=$("typeSelect")?.value||'';
  const box=$("behaviorDetailBox");
  if(!box) return;

  if(kind!=='behavior' || !isBehaviorDegreeSubtype(subtype)){
    box.style.display='none';
    return;
  }

  box.style.display='block';
  populateBehaviorDegree();
  const deg = behaviorDegreeFromSubtype(subtype) || 1;
  $("behDegree").value = String(deg);
  populateBehaviorInfractions(deg);
  // تهيئة الافتراضي
  $("behRepeat").checked = false;
  updateBehaviorDeductUI();
}
function getBehaviorMeta(){
  const subtype=$("typeSelect")?.value||'';
  if(!isBehaviorDegreeSubtype(subtype)) return null;
  const deg = Number($("behDegree")?.value||behaviorDegreeFromSubtype(subtype)||0);
  const cat = BEHAVIOR_CATALOG[String(deg)] || BEHAVIOR_CATALOG[deg] || null;
  if(!cat) return null;
  const inf = safeText($("behInfraction")?.value||'');
  const repeat = !!$("behRepeat")?.checked;
  let deduct = Number(cat.deduct||0);
  if(deg===1 && cat.repeatOnly && !repeat) deduct = 0;
  return {
    degree: deg,
    level: safeText(cat.level),
    infraction: inf,
    deduct: deduct,
    repeat: repeat
  };
}
function behaviorSubtypeForRecord(meta){
  if(!meta) return $("typeSelect")?.value||'';
  const dLabel = BEHAVIOR_DEGREE_LABEL[String(meta.degree)] || meta.degree;
  const inf = meta.infraction ? ` — ${meta.infraction}` : '';
  return `مخالفة سلوكية (الدرجة ${dLabel}) — مستوى: ${meta.level}${inf}`;
}


function normalizeStudents(arr){
  const out=[]; const seen=new Set();
  for(const it of arr){
    const sid=safeText(it.sid||it["رقم الطالب"]||it.id||it.student_id);
    const name=safeText(it.name||it["اسم الطالب"]||it.fullName||it.studentName);
    if(!sid||!name) continue;
    if(seen.has(sid)) continue;
    seen.add(sid);
    const nid = safeText(it.nid||it.nationalId||it.national_id||it["رقم الهوية"]||it["الهوية"]||it["الهوية الوطنية"]||"");
    out.push({
      sid, name,
      phone:safeText(it.phone||it["الجوال"]||it["رقم الجوال"]||""),
      gradeCode:safeText(it.gradeCode||it["رقم الصف"]||it["الصف"]||""),
      section:safeText(it.section||it["الفصل"]||it["الشعبة"]||""),
      nid
    });
  }
  return out;
}

function stageLabel(code){
  const g=GRADE_MAP[String(code)];
  return g?g.label:String(code||"");
}

function describeStudent(st){
  const g=GRADE_MAP[String(st.gradeCode)]||{label:String(st.gradeCode||"")};
  const sec=String(st.section||"");
  const isEL=(g.elearning && sec===String(g.elearning));
  const track=isEL?"تعليم إلكتروني":"منتظم";
  const stage=g.label||"";
  const section=sec?("شعبة "+sec):"";
  return {stage,section,track,full:[stage,section,track].filter(Boolean).join(" - ")};
}

function profileRowHTML(st){
  const d=describeStudent(st);
  const code=String(st.gradeCode||'');
  const cls = (code==='1314')?'stage-1314':(code==='1416')?'stage-1416':(code==='1516')?'stage-1516':'';
  const stagePill = `<span class="stagePill ${cls}">${safeText(d.stage||'—')}</span>`;
  const section = safeText(d.section||'—');
  const phone = safeText(st.phone||'—');
  const nid = safeText(barcodeValue(st)||'—');
  return `
    <div class="profileRow">
      <div class="cell"><strong>الطالب:</strong> ${safeText(st.name||'—')}</div>
      <div class="cell"><strong>الهوية:</strong> ${nid}</div>
      <div class="cell"><strong>الصف:</strong> ${stagePill} <span class="muted">${section}</span></div>
      <div class="cell"><strong>ولي الأمر:</strong> ${phone}</div>
    </div>
  `;
}


function barcodeValue(st){
  const v = safeText(st.nid||"") || safeText(st.sid||"");
  return v;
}

function getSectionsForStage(stageCode){
  const secs=new Set();
  for(const s of state.students){
    if(String(s.gradeCode)===String(stageCode) && safeText(s.section)) secs.add(String(s.section));
  }
  return Array.from(secs).sort((a,b)=>Number(a)-Number(b));
}

function ensureReady(){
  const haveStudents = Array.isArray(state.students) && state.students.length>0;
  $("q").disabled = !haveStudents;
  $("toggleListBtn").disabled = !haveStudents;
  $("selectAllBtn").disabled = !(haveStudents && safeText(state.q).length>=2);
  $("clearSelBtn").disabled = state.selectedSids.size===0;
  $("sheetA4Btn").disabled = !(haveStudents && state.stage && state.section);
  $("scanBtn").disabled = !(haveStudents && state.stage && state.section);
}

function setListVisible(v){
  state.listVisible=v;
  $("listWrap").style.display = v?"block":"none";
  if(v) renderList();
}

/* ===== بحث متقدم بسيط (ترتيب النتائج) ===== */
function tokenize(q){
  return safeText(q).toLowerCase().split(/\s+/).filter(Boolean);
}

function scoreStudent(st, q){
  const qq=safeText(q).toLowerCase();
  if(!qq) return 0;
  const name=(st.name||"").toLowerCase();
  const sid=String(st.sid||"");
  const nid=String(st.nid||"");
  const phone=String(st.phone||"");

  let s=0;
  if(name.startsWith(qq)) s+=120;
  if(name.includes(qq)) s+=60;
  if(sid.startsWith(qq)) s+=120;
  if(sid.includes(qq)) s+=80;
  if(nid.startsWith(qq)) s+=120;
  if(nid.includes(qq)) s+=80;
  if(phone.includes(qq)) s+=40;

  const toks=tokenize(qq);
  for(const t of toks){
    if(t.length<2) continue;
    if(name.includes(t)) s+=18;
    if(sid.includes(t) || nid.includes(t)) s+=24;
  }
  return s;
}

function filteredStudents(){
  const q = safeText(state.q);
  if(q.length<2) return [];
  let arr = state.students.slice();
  if(state.stage) arr = arr.filter(s=>String(s.gradeCode)===String(state.stage));
  if(state.section) arr = arr.filter(s=>String(s.section)===String(state.section));

  const scored = arr.map(st=>({st, sc: scoreStudent(st, q)})).filter(x=>x.sc>0);
  scored.sort((a,b)=>b.sc-a.sc);
  return scored.map(x=>x.st);
}

function updateSelectionUI(){
  const c=state.selectedSids.size;
  $("countPill").textContent = "محدد: "+c;
  $("selPill").textContent = String(c);
  if(c>0){
    const f = [];
    if(state.stage) f.push(stageLabel(state.stage));
    if(state.section) f.push("شعبة "+state.section);
    $("selTitle").textContent = f.length?f.join(" — "):"تحديد من نتائج البحث";
    $("selSub").textContent = "إرسال متتابع + أرشفة تلقائية";
    $("actionbar").style.display="block";
  } else {
    $("actionbar").style.display="none";
  }
  ensureReady();
}

function renderQuickSeg(){
  const wrap=$("quickSeg");
  const opts=[
    ["late","تأخر"],
    ["absent","غياب"],
    ["behavior","مخالفة"],
    ["permit","إذن"],
  ];
  wrap.innerHTML = opts.map(([k,l])=>`<button type="button" class="${state.quickAction===k?'active':''}" data-qk="${k}">${l}</button>`).join("");
  wrap.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
    state.quickAction=b.getAttribute('data-qk');
    renderQuickSeg();
    toast("تم اختيار: " + b.textContent);
    if(state.listVisible) renderList();
  }));
}

function renderStageSeg(){
  const wrap=$("stageSeg");
  const stages=[["1314","أول ثانوي"],["1416","ثاني ثانوي"],["1516","ثالث ثانوي"]];
  wrap.innerHTML = stages.map(([code,label])=>
    `<button class="${state.stage===code?'active':''}" data-stage="${code}" type="button">${label}</button>`
  ).join("");
  wrap.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{
    state.stage = btn.getAttribute('data-stage');
    const secs = getSectionsForStage(state.stage);
    const sel=$("sectionSelect");
    sel.disabled=false;
    sel.innerHTML = `<option value="">اختر الشعبة…</option>` + secs.map(s=>`<option value="${s}">شعبة ${s}</option>`).join("");
    sel.value="";
    state.section="";
    toast("اختر الشعبة لاستخدام كشف الشعبة/الباركود. البحث يظل متاحًا.");
    ensureReady();
    if(state.listVisible) renderList();
  }));
}

function renderList(){
  const list=$("list");
  const arr=filteredStudents();
  const q=safeText(state.q);
  const pills=[];
  pills.push("بحث: "+q);
  if(state.stage) pills.push(stageLabel(state.stage));
  if(state.section) pills.push("شعبة "+state.section);
  $("listPill").textContent = pills.join(" • ");

  if(!arr.length){
    list.innerHTML = `<div class="empty">لا توجد نتائج. اكتب حرفين فأكثر أو جرّب رقم الهوية/الرقم.</div>`;
    return;
  }

  const max=220;
  const show=arr.slice(0,max);
  list.innerHTML = show.map(st=>{
    const d=describeStudent(st);
    const checked = state.selectedSids.has(st.sid);
    const idText = barcodeValue(st);
    return `
      <div class="item" data-sid="${st.sid}">
        <button class="ckbtn ${checked?'checked':''}" type="button" data-ck="1" aria-label="تحديد">${checked?icon('check'):''}</button>
        <div class="main" data-open="1" title="فتح رصد سريع">
          <div class="name">${st.name}</div>
          <div class="meta">
            <span>${d.stage || '—'}</span>
            <span>${d.section || '—'}</span>
            <span>${d.track || '—'}</span>
            <span>هوية/رقم: ${idText}</span>
          </div>
        </div>
        <div class="mini">
          <button class="btn ghost" type="button" data-arc="1">الأرشيف</button>
        </div>
      </div>`;
  }).join("") + (arr.length>max?`<div class="empty">تم عرض ${max} من ${arr.length}. ضيّق البحث للحصول على نتائج أدق.</div>`:"");

  list.querySelectorAll('.item').forEach(row=>{
    const sid=row.getAttribute('data-sid');
    row.addEventListener('click',(e)=>{
      const t=e.target;
      if(t && t.getAttribute){
        if(t.getAttribute('data-ck')==='1'){
          e.preventDefault();
          if(state.selectedSids.has(sid)) state.selectedSids.delete(sid);
          else state.selectedSids.add(sid);
          updateSelectionUI();
          renderList();
          return;
        }
        if(t.getAttribute('data-arc')==='1'){
          e.preventDefault();
          openProfile(sid);
          return;
        }
      }
      // فتح الرصد السريع
      openQuickForStudent(sid);
    }, {passive:false});
  });
}

function selectAllCurrent(){
  const arr=filteredStudents();
  if(!arr.length) return toast('لا توجد نتائج للتحديد.');
  arr.forEach(s=>state.selectedSids.add(s.sid));
  updateSelectionUI();
  if(state.listVisible) renderList();
  toast('تم تحديد '+arr.length+' طالب/طلاب حسب النتائج.');
}

function clearSelection(){
  state.selectedSids = new Set();
  updateSelectionUI();
  if(state.listVisible) renderList();
}

/* ===== Code39 SVG generator (barcode) ===== */
const CODE39 = {
  "0":"nnnwwnwnn","1":"wnnwnnnnw","2":"nnwwnnnnw","3":"wnwwnnnnn","4":"nnnwwnnnw","5":"wnnwwnnnn","6":"nnwwwnnnn","7":"nnnwnnwnw","8":"wnnwnnwnn","9":"nnwwnnwnn",
  "A":"wnnnnwnnw","B":"nnwnnwnnw","C":"wnwnnwnnn","D":"nnnnwwnnw","E":"wnnnwwnnn","F":"nnwnwwnnn","G":"nnnnnwwnw","H":"wnnnnwwnn","I":"nnwnnwwnn","J":"nnnnwwwnn",
  "K":"wnnnnnnww","L":"nnwnnnnww","M":"wnwnnnnwn","N":"nnnnwnnww","O":"wnnnwnnwn","P":"nnwnwnnwn","Q":"nnnnnnwww","R":"wnnnnnwwn","S":"nnwnnnwwn","T":"nnnnwnwwn",
  "U":"wwnnnnnnw","V":"nwwnnnnnw","W":"wwwnnnnnn","X":"nwnnwnnnw","Y":"wwnnwnnnn","Z":"nwwnwnnnn",
  "-":"nwnnnnwnw",".":"wwnnnnwnn"," ":"nwwnnnwnn","$":"nwnwnwnnn","/":"nwnwnnnwn","+":"nwnnnwnwn","%":"nnnwnwnwn","*":"nwnnwnwnn"
};

function toCode39Text(val){
  let t=safeText(val).toUpperCase();
  t=t.replace(/[^0-9A-Z\-\.\ \$\/\+\%]/g,"");
  if(!t) t='0';
  return '*'+t+'*';
}

function code39SVG(val, height=40){
  const txt = toCode39Text(val);
  const narrow=1, wide=3, gap=1;
  let x=5; let bars=[];
  for(let i=0;i<txt.length;i++){
    const ch=txt[i];
    const pattern=CODE39[ch]||CODE39['0'];
    for(let j=0;j<9;j++){
      const isBar=(j%2===0);
      const bw=(pattern[j]==='w'?wide:narrow)*2;
      if(isBar) bars.push(`<rect x="${x}" y="0" width="${bw}" height="${height}" fill="#000"/>`);
      x += bw + (gap*2);
    }
    x += 2;
  }
  const w=x+5;
  return `<svg class="barSvg" viewBox="0 0 ${w} ${height}" xmlns="http://www.w3.org/2000/svg">${bars.join('')}</svg>`;
}

/* ===== إجراءات مقترحة (استرشادية) ===== */
function suggestAction(kind, subtype){
  const s = safeText(subtype);
  if(kind==='attendance'){
    if(s.includes('تأخر')) return 'إشعار ولي الأمر + توثيق التأخر + متابعة التكرار وإحالة للتوجيه الطلابي عند الحاجة.';
    if(s.includes('غياب')) return 'إشعار ولي الأمر + توثيق الغياب + تطبيق إجراءات الدليل عند التكرر.';
    if(s.includes('انقطاع')) return 'تنبيه الطالب + إشعار ولي الأمر + توثيق ومتابعة الانقطاع.';
    return 'توثيق الحالة + إشعار ولي الأمر عند الحاجة.';
  }
  if(kind==='behavior'){
    const low = [
      "التنبيه الشفهي",
      "تحويل الطالب إلى إدارة المدرسة",
      "تدوين محضر بالواقعة",
      "كتابة تعهد خطي على الطالب",
      "إحالة الطالب للتوجيه الطلابي لمتابعة الحالة",
      "إشعار ولي الأمر عند الحاجة",
      "الحسم من درجات السلوك",
      "نقل الطالب إلى فصل آخر عند الحاجة"
    ];
    const high = [
      "التحويل إلى إدارة المدرسة",
      "تدوين محضر بالواقعة",
      "دعوة ولي الأمر",
      "كتابة تعهد خطي على الطالب أو إقرار من ولي أمره",
      "إحالة الطالب إلى لجنة التوجيه الطلابي لمتابعة المشكلة السلوكية",
      "نقل الطالب إلى فصل آخر (عند الحاجة)",
      "الحسم من درجات السلوك",
      "إحالة مشكلة الطالب إلى إدارة التعليم (التوجيه الطلابي) عند الحاجة",
      "نقل الطالب إلى مدرسة أخرى بقرار إدارة التعليم عند الحاجة",
      "تحويل المشكلة للجهات الأمنية إذا استدعت الحالة ذلك"
    ];
    if(s.includes('زيارة المدرسة')) return "دعوة ولي الأمر لزيارة المدرسة لمناقشة الحالة واتخاذ الإجراء المناسب وفق الدليل.";
    if(s.includes('الدرجة الأولى') || s.includes('الدرجة الثانية')) return "إجراءات مقترحة: " + low.join("، ") + ".";
    if(s.includes('الدرجة الثالثة') || s.includes('الدرجة الرابعة') || s.includes('الدرجة الخامسة')) return "إجراءات مقترحة: " + high.join("، ") + ".";
    return "توثيق الواقعة + اتخاذ الإجراء المناسب وفق الدليل المعتمد.";
  }
  if(kind==='permit'){
    if(s.includes('زيارة')||s.includes('دعوة')) return 'تحديد موعد مناسب + توثيق سبب الدعوة + إشعار ولي الأمر.';
    return 'توثيق الإذن وتحديد الجهة المعنية (معلم/ولي أمر) عند الحاجة.';
  }
  return '';
}

/* ===== رسائل ===== */
function buildMessageParent(st, kind, subtype, when, note, meta){
  const d=describeStudent(st);

  if(kind==='attendance'){
    const hdr='السلام عليكم ورحمة الله وبركاته،';
const body = `نفيدكم بأنه تم تسجيل (${subtype}) للطالب/ ${st.name} (${d.full}).`;
    const t = when?`الوقت: ${when}.`:'';
    const n = note?`ملاحظة: ${note}.`:'';
    const end='شاكرين تعاونكم، مع خالص التقدير.';
    return [hdr, body, t, n, end].filter(Boolean).join('\n');
  }

  // تحديث تفاصيل السلوك بعد التهيئة/الاختيار المسبق
  syncBehaviorDetailBox();

  if(kind==='permit'){
    const hdr='السلام عليكم ورحمة الله وبركاته،';
    const body = `إشعار بخصوص الطالب/ ${st.name} (${d.full}): ${subtype}.`;
    const t = when?`الوقت: ${when}.`:'';
    const n = note?`ملاحظة: ${note}.`:'';
    const end='شاكرين تعاونكم، مع خالص التقدير.';
    return [hdr, body, t, n, end].filter(Boolean).join('\n');
  }

  // behavior
  const hdr='السلام عليكم ورحمة الله وبركاته،';
  const inf = meta?.infraction ? `المخالفة: ${meta.infraction}.` : `المخالفة: ${subtype}.`;
  const degLabel = meta?.degree ? (BEHAVIOR_DEGREE_LABEL[String(meta.degree)]||meta.degree) : '';
  const lvl = meta?.level ? `المستوى: ${meta.level}${degLabel?` (الدرجة ${degLabel})`:''}.` : '';
  const deduct = (meta && typeof meta.deduct==='number')
    ? (meta.deduct>0 ? `الحسم المقدر من درجات السلوك: (${meta.deduct}).` : `الحسم: لا يوجد (أول مرة/بدون تكرار).`)
    : '';
  const t = when?`الوقت: ${when}.`:'';
  const n = note?`ملاحظة: ${note}.`:'';
  const end='نأمل التعاون والمتابعة، مع خالص التقدير.';
  return [hdr, `تم رصد مخالفة سلوكية على الطالب/ ${st.name} (${d.full}).`, inf, lvl, deduct, t, n, end].filter(Boolean).join('\n');
}



function buildMessageTeacher(st, subtype, when, note){
  const d=describeStudent(st);
  const lines=[];
  lines.push('السلام عليكم ورحمة الله وبركاته،');
  lines.push('');
  if(subtype.includes('دخول')) lines.push('يرجى التكرم بالسماح للطالب/ ' + st.name + ' بالدخول إلى الفصل.');
  else if(subtype.includes('خروج')) lines.push('يرجى التكرم بالسماح للطالب/ ' + st.name + ' بالخروج وفق الإذن.');
  else lines.push('تنبيه بخصوص الطالب/ ' + st.name + ' (إذن).');
  lines.push('الصف/ ' + (d.stage||'—') + ' – ' + (d.section||'—') + ' (' + (d.track||'—') + ')');
  if(note) lines.push('ملاحظة: ' + note);
  lines.push('الوقت: ' + when);
  lines.push('');
  lines.push('شكرًا لتعاونكم.');
  lines.push('— ' + state.settings.schoolName);
  return lines.join('\n');
}

function openWhatsApp(phone, text){
  const p=normalizePhone(phone);
  const msg=encodeURIComponent(text);
  const url=p?('https://wa.me/'+p+'?text='+msg):('https://wa.me/?text='+msg);
  window.open(url,'_blank','noopener,noreferrer');
}

function copyText(text){
  navigator.clipboard.writeText(text).then(()=>toast('تم النسخ.')).catch(()=>toast('تعذر النسخ تلقائيًا.'));
}

function makeEntry(st, kind, subtype, when, note, to, toName, toPhone, msg, meta){
  const info=nowInfo();
  const whenText=(when && String(when).trim()) ? String(when).trim() : info.full;

  // استخراج تاريخ ISO من نص "when" (للتقارير والفرز)
  const m=whenText.match(/(\d{4}-\d{2}-\d{2})/);
  const dateISO=m ? m[1] : info.iso;

  const entry={
    id:uid('R'),
    sid:String(st.sid),
    kind,
    subtype,
    when: whenText,
    dateISO,
    note: note || '',
    to,
    toName: toName || '',
    toPhone: toPhone || '',
    msg: msg || '',
    meta: meta || null
  };
  state.records.unshift(entry);
  return entry;
}




/* ===== Sheet logic ===== */
function closeSheet(){ $("backdrop").classList.remove('show'); }

function openSheet(kind, mode='profile', sid='', presetSubtype=''){
  $("sheetKind").value = kind;
  $("sheetMode").value = mode;
  $("defaultSubtype").value = presetSubtype || '';
  state.profileSid = sid || '';

  $("scanBox").style.display='none';
  $("reportBox").style.display='none';
  $("afterSave").style.display='none';
  $("archiveBox").style.display='none';
  $("saveBtn").style.display='block';
  $("typeBox").style.display='block';
  $("whenRow").style.display='grid';
  $("noteBox").style.display='block';
  $("chipsBox").style.display='block';
  $("recipientsBox").style.display='none';
  $("teacherBox").style.display='none';
  $("editStudentBox").style.display='none';
  $("profileBox").style.display = (mode==='profile')?'block':'none';
  $("openArchiveBtn").style.display = (mode==='profile')?'block':'none';

  const info=nowInfo();
  $("when").value = info.day + ' - ' + info.date + ' - ' + info.time;
  $("note").value='';
  $("phone").value='';
  $("teacherName").value='';
  $("teacherPhone").value='';

  let items=[];
  if(kind==='attendance'){
    items = (presetSubtype && presetSubtype.includes('غياب')) ? ATTENDANCE_ABSENT : ATTENDANCE_LATE;
  } else if(kind==='behavior') items = BEHAVIOR_LIST;
  else items = PERMIT_LIST;

  const title = (kind==='attendance')?"مواظبة":(kind==='behavior'?"سلوك":"إذن");
  $("sheetTitle").textContent = (mode==='profile'?'رصد سريع':'إرسال متتابع للمحددين') + ' — ' + title;

  $("typeSelect").innerHTML = items.map(x=>`<option value="${x}">${x}</option>`).join('');
  $("chips").innerHTML = items.slice(0,6).map(x=>`<button class="chip" type="button" data-v="${x}">${x}</button>`).join('');
  $("chips").querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',()=>{
    $("chips").querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    $("typeSelect").value = ch.getAttribute('data-v');
    syncBehaviorDetailBox();
  }));


  $("typeSelect").onchange = ()=>{
    // مزامنة شارة الاختيار السريع
    $("chips").querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    $("chips").querySelectorAll('.chip').forEach(ch=>{
      if(ch.getAttribute('data-v')===$("typeSelect").value) ch.classList.add('active');
    });
    syncBehaviorDetailBox();
  };

  // ربط حقول المخالفة (إن وجدت)
  if($("behDegree")){
    $("behDegree").onchange = ()=>{
      const deg=Number($("behDegree").value||1);
      populateBehaviorInfractions(deg);
      $("behRepeat").checked=false;
      updateBehaviorDeductUI();
    };
    $("behInfraction").onchange = updateBehaviorDeductUI;
    $("behRepeat").onchange = updateBehaviorDeductUI;
  }

  // تهيئة صندوق المخالفة حسب النوع المختار
  syncBehaviorDetailBox();

    // preset
  if(presetSubtype){
    $("typeSelect").value = presetSubtype;
    // highlight if exists
    $("chips").querySelectorAll('.chip').forEach(ch=>{
      if(ch.getAttribute('data-v')===presetSubtype) ch.classList.add('active');
    });
  }

  if(kind==='permit'){
    $("recipientsBox").style.display='block';
    const chips=$("recipientChips");
    chips.innerHTML = `
      <button class="chip active" type="button" data-v="parent">ولي الأمر</button>
      <button class="chip" type="button" data-v="teacher">المعلم</button>
      <button class="chip" type="button" data-v="both">كلاهما</button>
    `;
    const setR=(val)=>{
      chips.setAttribute('data-recips', val);
      const showTeacher = (val==='teacher'||val==='both');
      $("teacherBox").style.display = showTeacher?'block':'none';
      $("phoneBox").style.display = (val==='teacher')?'none':'block';
      if(showTeacher){ refreshTeacherSelect(); fillTeacherFromSelect(); }
    };
    chips.querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',()=>{
      chips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      setR(ch.getAttribute('data-v'));
    }));
    setR('parent');
  }

  if(mode==='profile'){
    const st=state.students.find(x=>x.sid===sid);
    if(st){
      const d=describeStudent(st);
      $("profileInfo").innerHTML = profileRowHTML(st);
      $("editStudentBox").style.display='block';
      $("stPhone").value = st.phone||'';
      $("stId").value = barcodeValue(st);
      $("saveStudentBtn").onclick = ()=>{
        st.phone = safeText($("stPhone").value);
        st.nid = safeText($("stId").value);
        store.set(KEYS.students, state.students);
        toast('تم حفظ التعديل.');
        $("profileInfo").innerHTML = profileRowHTML(st);
        if(state.listVisible) renderList();
      };
    }
  }

  $("backdrop").classList.add('show');
}

function openProfile(sid){
  // فتح كمواظبة افتراضيًا مع الأرشيف
  openSheet('attendance','profile',sid, '');
  $("openArchiveBtn").onclick = ()=>showArchive(sid);
  setTimeout(()=>showArchive(sid), 0);
}

function openQuickForStudent(sid){
  const st=state.students.find(x=>x.sid===sid);
  if(!st) return;
  if(state.quickAction==='late') openSheet('attendance','profile',sid,'تأخر صباحي');
  else if(state.quickAction==='absent') openSheet('attendance','profile',sid,'غياب (بدون عذر)');
  else if(state.quickAction==='behavior') openSheet('behavior','profile',sid,'تنبيه سلوكي داخل الحصة');
  else openSheet('permit','profile',sid,'إذن دخول الفصل');

  $("openArchiveBtn").onclick = ()=>showArchive(sid);
  setTimeout(()=>showArchive(sid), 0);
}

function saveRecordsAndPreview(){
  const kind=$("sheetKind").value;
  const mode=$("sheetMode").value;
  const when=$("when").value;
  const note=safeText($("note").value);

  const subtypeRaw=$("typeSelect").value;
  let subtype=subtypeRaw;
  let meta=null;

  // السلوك: تفعيل الدرجة + المخالفة + الحسم
  if(kind==='behavior'){
    syncBehaviorDetailBox();
    meta = getBehaviorMeta();
    if(meta) subtype = behaviorSubtypeForRecord(meta);
  }

  let recips='parent';
  if(kind==='permit') recips = $("recipientChips").getAttribute('data-recips') || 'parent';

  const commonParentPhone = safeText($("phone").value);
  const tName=safeText($("teacherName").value);
  const tPhone=safeText($("teacherPhone").value);

  let targets=[];
  if(mode==='profile'){
    const st = state.students.find(x=>x.sid===state.profileSid);
    if(st) targets=[st];
  } else {
    targets = state.students.filter(s=>state.selectedSids.has(s.sid));
  }
  if(!targets.length) return toast('لا يوجد طلاب محددون.');

  const saved=[];
  const previews=[];

  for(const st of targets){
    if(kind!=='permit' || recips==='parent' || recips==='both'){
      const msgP = buildMessageParent(st, kind, subtype, when, note, meta);
      const phoneP = normalizePhone(commonParentPhone || st.phone || '');
      saved.push({toPhone:phoneP, msg:msgP});
      makeEntry(st, kind, subtype, when, note, 'parent','ولي الأمر', phoneP, msgP, meta);
      previews.push('— — —\n'+msgP);
    }
    if(kind==='permit' && (recips==='teacher' || recips==='both')){
      const msgT = buildMessageTeacher(st, subtype, when, note);
      const phoneT = normalizePhone(tPhone);
      saved.push({toPhone:phoneT, msg:msgT});
      makeEntry(st, kind, subtype, when, note, 'teacher', (tName||'المعلم'), phoneT, msgT, null);
      previews.push('— — —\n'+msgT);
    }
  }

  store.set(KEYS.records, state.records);

  $("preview").textContent = previews.join('\n');
  $("afterSave").style.display='block';
  $("saveBtn").style.display='none';

  // أزرار طباعة المخالفة (فقط عند رصد طالب واحد)
  const canPrintBehavior = (kind==='behavior' && mode==='profile' && targets.length===1 && !!meta);
  $("behaviorPrintBox").style.display = canPrintBehavior ? 'grid' : 'none';
  // طباعة المخالفة
  if(canPrintBehavior){
    const st=targets[0];
    $("printSlipBtn").onclick = ()=>printBehaviorSlip(st, when, note, meta);
    $("printBehaviorA4Btn").onclick = ()=>printBehaviorA4(st, when, note, meta);
  }

  // فتح الأرشيف (لطالب واحد)
  const canOpenArchive = (mode==='profile' && targets.length===1);
  $("openArchiveBtn").style.display = canOpenArchive ? 'block' : 'none';
  if(canOpenArchive){
    const st=targets[0];
    $("openArchiveBtn").onclick = ()=>showArchive(st.sid);
  }

  let idx=0;
  $("waBtn").onclick = ()=>{
    const item=saved[idx];
    if(!item) return toast('انتهى الإرسال المتتابع.');
    openWhatsApp(item.toPhone||'', item.msg);
    idx++;
    toast(idx<saved.length?'التالي...':'تم فتح آخر رسالة.');
  };
  $("copyBtn").onclick = ()=>copyText(previews.join('\n\n'));
  toast('تم الحفظ في الأرشيف ('+saved.length+').');
}



function showArchive(sid){
  const st=state.students.find(x=>x.sid===sid);
  if(!st) return;
const rows=state.records.filter(r=>String(r.sid)===String(sid)).slice(0,200);
  const d=describeStudent(st);
  const info=nowInfo();

  // واجهة الأرشيف داخل النافذة
  const code=String(st.gradeCode||'');
  const cls = (code==='1314')?'stage-1314':(code==='1416')?'stage-1416':(code==='1516')?'stage-1516':'';
  const head = `
    <div class="archiveHead">
      <div>
        <div class="title">أرشيف الطالب — ${safeText(st.name||'—')}</div>
        <div class="meta">${safeText(d.full||'')} • الهوية: ${safeText(barcodeValue(st)||'—')} • ولي الأمر: ${safeText(st.phone||'—')}</div>
      </div>
      <div class="meta">${info.day} • ${info.date} • ${info.time}</div>
    </div>
  `;
  let body='';
  if(!rows.length){
    body = `<tr><td colspan="6">لا يوجد سجلات بعد.</td></tr>`;
  } else {
    body = rows.map((r,i)=>{
      const tag = (r.kind==='attendance'?'مواظبة':(r.kind==='behavior'?'سلوك':'إذن'));
      const to = (r.to==='teacher'?'معلم':'ولي أمر');
      const deduct = (r.meta && typeof r.meta.deduct==='number' && r.kind==='behavior') ? (r.meta.deduct||0) : '';
      return `
        <tr>
          <td>${i+1}</td>
          <td>${safeText(r.when||'')}</td>
          <td>${tag}</td>
          <td>${safeText(r.subtype||'')}</td>
          <td>${to}</td>
          <td>${deduct!=='' ? ('('+deduct+')') : '—'}</td>
        </tr>
      `;
    }).join('');
  }

  const tbl = `
    <div class="archiveWrap">
      ${head}
      <table>
        <thead>
          <tr>
            <th style="width:54px">#</th>
            <th style="width:220px">التاريخ/الوقت</th>
            <th style="width:110px">التصنيف</th>
            <th>التفصيل</th>
            <th style="width:90px">الجهة</th>
            <th style="width:110px">الحسم</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
  $("archiveList").innerHTML = tbl;
  $("archiveBox").style.display='block';

  // أزرار الأرشيف
  $("printArchiveBtn").onclick = ()=>printArchiveA4(st, rows);
  $("copyArchiveBtn").onclick = ()=>{
    const lines=[];
    lines.push('أرشيف الطالب: '+safeText(st.name||'—'));
    lines.push(safeText(d.full||''));
    lines.push('هوية: '+safeText(barcodeValue(st)||'—')+' | ولي الأمر: '+safeText(st.phone||'—'));
    lines.push('—');
    rows.forEach((r,i)=>{
      const tag = (r.kind==='attendance'?'مواظبة':(r.kind==='behavior'?'سلوك':'إذن'));
      const to = (r.to==='teacher'?'معلم':'ولي أمر');
      const deduct = (r.meta && typeof r.meta.deduct==='number' && r.kind==='behavior') ? (r.meta.deduct||0) : '';
      lines.push(`${i+1}) ${tag} — ${safeText(r.subtype||'')} — (${to}) — ${safeText(r.when||'')}` + (deduct!==''?` — حسم: (${deduct})`:''));
    });
    copyText(lines.join('\n'));
  };
}


function openScanSession(){
  if(!state.stage || !state.section) return toast('اختر المرحلة والشعبة أولاً.');
  $("sheetTitle").textContent='جلسة باركود — تأخر/غياب';

  $("scanBox").style.display='block';
  $("reportBox").style.display='none';
  $("afterSave").style.display='none';
  $("archiveBox").style.display='none';
  $("saveBtn").style.display='none';
  $("typeBox").style.display='none';
  $("whenRow").style.display='none';
  $("noteBox").style.display='none';
  $("chipsBox").style.display='none';
  $("profileBox").style.display='none';
  $("editStudentBox").style.display='none';
  $("recipientsBox").style.display='none';
  $("teacherBox").style.display='none';

  const chips=$("scanTypeChips");
  chips.innerHTML = `
    <button class="chip ${state.scanType==='late'?'active':''}" type="button" data-v="late">تأخر</button>
    <button class="chip ${state.scanType==='absent'?'active':''}" type="button" data-v="absent">غياب</button>
  `;
  chips.querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',()=>{
    chips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    state.scanType = ch.getAttribute('data-v');
    toast('نوع الجلسة: '+(state.scanType==='absent'?'غياب':'تأخر'));
    focusScan();
  }));

  $("scanLast").textContent='—';
  $("scanStopBtn").onclick = ()=>closeSheet();
  $("scanFocusBtn").onclick = ()=>focusScan();

  const inp=$("scanInput");
  inp.value='';
  inp.onkeydown = (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const raw=safeText(inp.value);
      inp.value='';
      if(!raw) return;
      handleScan(raw);
    }
  };

  $("backdrop").classList.add('show');
  setTimeout(()=>focusScan(), 150);
}

function focusScan(){ $("scanInput").focus(); }

function findStudentByBarcode(code){
  let c=safeText(code).replace(/\*/g,'');
  const map={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
  c=c.replace(/[٠-٩]/g,(d)=>map[d]||d);
  return state.students.find(s => safeText(s.nid)===c || safeText(s.sid)===c);
}

function handleScan(code){
  const st=findStudentByBarcode(code);
  const info=nowInfo();
  if(!st){
    $("scanLast").textContent='لم يتم العثور على الطالب: '+code;
    return toast('باركود غير مطابق.');
  }
  const subtype = (state.scanType==='absent') ? 'غياب (تسجيل بالباركود)' : 'تأخر صباحي (تسجيل بالباركود)';
  const when = info.day + ' - ' + info.date + ' - ' + info.time;
  const msg = buildMessageParent(st, 'attendance', subtype, when, '');
  makeEntry(st, 'attendance', subtype, when, '', 'parent', 'ولي الأمر', st.phone||'', msg);
  store.set(KEYS.records, state.records);

  $("scanLast").textContent = `${st.name}\n${describeStudent(st).full}\nتم تسجيل: ${state.scanType==='absent'?'غياب':'تأخر'}\n${info.time}`;
  toast('تم التسجيل: '+st.name);
}

/* ===== Reports + Print ===== */
function uniqBySid(records){
  const seen=new Set();
  const out=[];
  for(const r of records){
    if(seen.has(r.sid)) continue;
    seen.add(r.sid);
    out.push(r);
  }
  return out;
}

function todayRecords(){
  const iso=nowInfo().iso;

  // يدعم أكثر من صيغة للتاريخ داخل الحقل (بسبب اختلاف طرق الإدخال)
  return state.records.filter(r=>{
    const whenStr=String(r.when||r.dateTime||'').trim();

    // 1) تاريخ بصيغة ISO داخل النص بأي مكان: YYYY-MM-DD
    const m=whenStr.match(/(\d{4}-\d{2}-\d{2})/);
    if(m) return m[1]===iso;

    // 2) صيغة قديمة: YYYY/MM/DD
    const m2=whenStr.match(/(\d{4})\/(\d{2})\/(\d{2})/);
    if(m2) return (`${m2[1]}-${m2[2]}-${m2[3]}`)===iso;

    // 3) حقول منفصلة إن وُجدت
    if(r.dayISO) return String(r.dayISO)===iso;
    if(r.dateISO) return String(r.dateISO)===iso;

    return false;
  });
}



function buildTodayReportText(){
  const info=nowInfo();
  const rows=todayRecords();
  const late = uniqBySid(rows.filter(r=>r.kind==='attendance' && (r.subtype||'').includes('تأخر')));
  const absent = uniqBySid(rows.filter(r=>r.kind==='attendance' && (r.subtype||'').includes('غياب')));
  const behavior = rows.filter(r=>r.kind==='behavior');
  const permit = rows.filter(r=>r.kind==='permit');

  const fmt=(arr,label)=>{
    if(!arr.length) return `${label}: لا يوجد`;
    const names = arr.map(r=>{
      const st=state.students.find(s=>s.sid===r.sid);
      return st?st.name:r.sid;
    });
    const uniq=Array.from(new Set(names));
    return `${label} (${uniq.length}):\n- `+uniq.join('\n- ');
  };

  const lines=[];
  lines.push('تقارير اليوم: '+info.day+' - '+info.date);
  lines.push('—');
  lines.push(fmt(absent,'الغياب'));
  lines.push('—');
  lines.push(fmt(late,'التأخر'));
  lines.push('—');
  lines.push(fmt(behavior,'مخالفات/تنبيهات سلوكية'));
  lines.push('—');
  lines.push(fmt(permit,'أذونات'));
  return lines.join('\n');
}

function openTodayReportSheet(){
  $("sheetTitle").textContent='تقارير اليوم (A4)';

  $("scanBox").style.display='none';
  $("profileBox").style.display='none';
  $("editStudentBox").style.display='none';
  $("recipientsBox").style.display='none';
  $("teacherBox").style.display='none';
  $("chipsBox").style.display='none';
  $("typeBox").style.display='none';
  $("whenRow").style.display='none';
  $("noteBox").style.display='none';
  $("afterSave").style.display='none';
  $("archiveBox").style.display='none';
  $("saveBtn").style.display='none';

  $("reportText").textContent = buildTodayReportText();
  $("reportBox").style.display='block';

  $("reportCopyBtn").onclick = ()=>copyText($("reportText").textContent||'');

  const items = todayRecords().filter(r=>r.to==='parent').slice().reverse();
  let i=0;
  $("reportWaBtn").onclick = ()=>{
    const it=items[i];
    if(!it) return toast('لا توجد رسائل اليوم للإرسال.');
    openWhatsApp(it.toPhone||'', it.msg);
    i++;
    toast(i<items.length?'التالي...':'تم فتح آخر رسالة.');
  };

  $("printLateBtn").onclick = ()=>printDaily('late');
  $("printAbsentBtn").onclick = ()=>printDaily('absent');
  $("printBehaviorBtn").onclick = ()=>printDaily('behavior');

  $("backdrop").classList.add('show');
}

function chunks(arr, size){
  const out=[];
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

function printDaily(kind){
  const info=nowInfo();
  const rows=todayRecords();

  let data=[];
  let title='';
  if(kind==='late'){
    title='كشف المتأخرين اليوم';
    data = uniqBySid(rows.filter(r=>r.kind==='attendance' && (r.subtype||'').includes('تأخر')));
  } else if(kind==='absent'){
    title='كشف الغياب اليوم';
    data = uniqBySid(rows.filter(r=>r.kind==='attendance' && (r.subtype||'').includes('غياب')));
  } else {
    title='كشف المخالفات اليومية';
    data = rows.filter(r=>r.kind==='behavior');
  }

  const pages = chunks(data, 32); // مناسب لـ A4
  const htmlPages = pages.map((page, pi)=>{
    const bodyRows = page.map((r, idx)=>{
      const st = state.students.find(s=>s.sid===r.sid) || {name:r.sid, sid:r.sid, gradeCode:r.stage, section:r.section, nid:''};
      const d = describeStudent(st);
      const bc = code39SVG(barcodeValue(st));
      const k = (r.kind==='attendance'?'مواظبة':(r.kind==='behavior'?'سلوك':'إذن'));
      const subtype = r.subtype || '';
      const act = r.suggested || suggestAction(r.kind, subtype);
      return `
        <tr>
          <td class="colNum">${(pi*32)+idx+1}</td>
          <td class="colName">${st.name}</td>
          <td class="colSec">${d.section||'—'}</td>
          <td class="colKind">${kind==='behavior'?subtype:k+' - '+subtype}</td>
          <td class="colAct">${act}</td>
          <td class="colBar">${bc}</td>
        </tr>`;
    }).join('') || `<tr><td colspan="6" style="text-align:center">لا يوجد بيانات</td></tr>`;

    return `
    <div class="printWrap">
      <div class="printTitle">${title}</div>
      <div class="printMeta">${state.settings.schoolName} • ${info.day} • ${info.date}</div>
      <table class="printTable">
        <thead>
          <tr>
            <th class="colNum">م</th>
            <th class="colName">اسم الطالب</th>
            <th class="colSec">الشعبة</th>
            <th class="colKind">الحالة</th>
            <th class="colAct">إجراء مقترح</th>
            <th class="colBar">الباركود</th>
          </tr>
        </thead>
        <tbody>${bodyRows}</tbody>
      </table>
    </div>
    ${pi<pages.length-1?'<div class="pageBreak"></div>':''}`;
  }).join('');

  $("printArea").innerHTML = htmlPages;
  window.print();
}

/* ===== A4 class sheet for section (single page, days + barcode) ===== */
function buildA4SectionSheet(mode){
  const days=["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس"];
  const info=nowInfo();

  const stgRaw = stageLabel(state.stage);
  const stgTitle = (()=>{
    const t=safeText(stgRaw);
    if(t.startsWith('أول')) return 'الأول ثانوي';
    if(t.startsWith('ثاني')) return 'الثاني ثانوي';
    if(t.startsWith('ثالث')) return 'الثالث ثانوي';
    return t || '—';
  })();

  const secVal = safeText(state.section) || '—';

  // track (regular / e-learning)
  const g=GRADE_MAP[String(state.stage)]||{};
  const isEL = (g.elearning && String(secVal)===String(g.elearning));
  const track = isEL ? 'تعليم إلكتروني' : 'منتظم';

  const tWord = (mode==='absent')?'الغياب':'التأخر';
  const title = `كشف متابعة ${tWord} للمرحلة الثانوية – الصف ${stgTitle} – شعبة ${secVal} – ${track}`;

  // students of selected stage + section
  let arr = state.students.filter(s=>String(s.gradeCode)===String(state.stage) && String(s.section)===String(state.section));
  arr.sort((a,b)=>(a.name||'').localeCompare((b.name||''),'ar'));

  const n = arr.length;

  // ===== compact print tuning (single page) =====
  let fs=11.2, pad=3.6, padX=5.2, bcH=38, dayW=40;
  if(n>45){ fs=9.6;  pad=2.6; padX=4.4; bcH=30; dayW=34; }
  if(n>60){ fs=8.4;  pad=2.0; padX=3.8; bcH=26; dayW=30; }
  if(n>80){ fs=7.2;  pad=1.6; padX=3.2; bcH=22; dayW=26; }
  if(n>100){fs=6.4;  pad=1.2; padX=2.8; bcH=18; dayW=22; }
  if(n>120){fs=5.8;  pad=1.0; padX=2.4; bcH=16; dayW=20; }
  bcH = Math.max(16, Math.min(40, bcH));

  const rows = (arr.map((st,i)=>{
    const bc=code39SVG(barcodeValue(st), bcH);
    const tdsDays = days.map(()=>`<td class="dayCell"></td>`).join('');
    return `<tr>
      <td class="colNum">${i+1}</td>
      <td class="colName">${st.name}</td>
      ${tdsDays}
      <td class="colBar">
        ${bc}
        <div style="font-size:calc(var(--fs,11px) - 1.2px);letter-spacing:.6px;margin-top:2px;text-align:center">${barcodeValue(st)}</div>
      </td>
    </tr>`;
  }).join('')) || `<tr><td colspan="8" style="text-align:center">لا يوجد طلاب ضمن هذه الشعبة</td></tr>`;

  const html = `
  <div class="printWrap sectionSheet" style="--fs:${fs}px;--pad:${pad}px;--padX:${padX}px;--bcH:${bcH}px;--dayW:${dayW}px">
    <div class="printTitle">${title}</div>
    <div class="printMeta"><b>التاريخ: ${info.date}</b> • ${info.day} • الوقت: ${info.time} • من الأحد إلى الخميس</div>

    <table class="printTable">
      <thead>
        <tr>
          <th class="colNum">م</th>
          <th class="colName">اسم الطالب</th>
          ${days.map(d=>`<th class="dayHead" style="width:var(--dayW);text-align:center">${d}</th>`).join('')}
          <th class="colBar">الباركود</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;

  $("printArea").innerHTML = html;
  window.print();
}

/* ===== Import / Export ===== */
async function readTextFile(file){ return await file.text(); }
async function readJSONFile(file){ return JSON.parse(await readTextFile(file)); }

async function readCSVStudents(file){
  const txt = await readTextFile(file);
  const lines = txt.split(/\r?\n/).filter(l=>l.trim().length);
  if(!lines.length) return [];
  const sample=lines[0];
  const delim = (sample.split(';').length > sample.split(',').length) ? ';' : (sample.split('\t').length > sample.split(',').length ? '\t' : ',');

  const parseLine=(line)=>{
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch=='"'){ if(q && line[i+1]=='"'){cur+='"';i++;continue;} q=!q; continue; }
      if(!q && ch===delim){ out.push(cur); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out.map(s=>safeText(s));
  };

  const hdr=parseLine(lines[0]).map(h=>h.replace(/\s+/g,' ').trim());
  const idx=(names)=>{ for(const n of names){ const i=hdr.findIndex(h=>h===n); if(i>=0) return i; } return -1; };
  const iName=idx(['اسم الطالب','الاسم','اسم']);
  const iSid=idx(['رقم الطالب','StudentID','id']);
  const iNid=idx(['رقم الهوية','الهوية','الهوية الوطنية','nid','nationalId']);
  const iPhone=idx(['الجوال','رقم الجوال','phone']);
  const iGrade=idx(['رقم الصف','الصف','gradeCode']);
  const iSec=idx(['الفصل','الشعبة','section']);
  if(iName<0 || iSid<0) throw new Error('CSV لا يحتوي أعمدة (اسم الطالب) و(رقم الطالب).');

  const out=[];
  for(let li=1; li<lines.length; li++){
    const cells=parseLine(lines[li]);
    const st={
      sid:safeText(cells[iSid]),
      name:safeText(cells[iName]),
      nid:safeText(iNid>=0?cells[iNid]:''),
      phone:safeText(iPhone>=0?cells[iPhone]:''),
      gradeCode:safeText(iGrade>=0?cells[iGrade]:''),
      section:safeText(iSec>=0?cells[iSec]:'')
    };
    if(st.sid && st.name) out.push(st);
  }
  return out;
}

function importStudents(){
  const inp=document.createElement('input');
  inp.type='file';
  inp.accept='.csv,.json,text/csv,application/json';
  inp.onchange = async ()=>{
    try{
      const f=inp.files && inp.files[0];
      if(!f) return;
      let imported=[];
      if(String(f.name||'').toLowerCase().endsWith('.csv')) imported = await readCSVStudents(f);
      else {
        const obj = await readJSONFile(f);
        imported = Array.isArray(obj) ? obj : (obj.students || obj.data || []);
      }
      if(!Array.isArray(imported) || !imported.length) throw new Error('لا توجد بيانات صالحة.');
      state.students = normalizeStudents(imported);
      store.set(KEYS.students, state.students);
      $("firstRun").style.display='none';
      toast('تم الاستيراد: '+state.students.length);
      ensureReady();
    }catch(e){ toast('تعذر الاستيراد: '+(e&&e.message?e.message:e)); }
  };
  inp.click();
}

function exportBackup(){
  const pack={ exportedAt:new Date().toISOString(), students:state.students, records:state.records, teachers:state.teachers, settings:state.settings };
  const stamp=new Date().toISOString().slice(0,10);
  const blob=new Blob([JSON.stringify(pack,null,2)],{type:'application/json;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='نسخة-احتياطية-المواظبة-والسلوك-'+stamp+'.json';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },400);
  toast('تم تنزيل نسخة احتياطية.');
}

function shareBackup(){
  const pack={ exportedAt:new Date().toISOString(), students:state.students, records:state.records, teachers:state.teachers, settings:state.settings };
  const stamp=new Date().toISOString().slice(0,10);
  const blob=new Blob([JSON.stringify(pack,null,2)],{type:'application/json;charset=utf-8'});
  const file = new File([blob], 'نسخة-احتياطية-المواظبة-والسلوك-'+stamp+'.json', {type:'application/json'});
  if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
    navigator.share({ title:'نسخة احتياطية - المواظبة والسلوك', files:[file] }).then(()=>toast('تمت المشاركة.')).catch(()=>toast('تم الإلغاء.'));
  } else {
    exportBackup();
  }
}

function restoreBackup(){
  const inp=document.createElement('input');
  inp.type='file';
  inp.accept='.json,application/json';
  inp.onchange = async ()=>{
    try{
      const f=inp.files && inp.files[0];
      if(!f) return;
      const obj = await readJSONFile(f);
      if(obj.students) state.students = normalizeStudents(obj.students);
      if(obj.records) state.records = Array.isArray(obj.records)?obj.records:state.records;
      if(obj.teachers) state.teachers = Array.isArray(obj.teachers)?obj.teachers:state.teachers;
      if(obj.settings) state.settings = obj.settings;
      store.set(KEYS.students, state.students);
      store.set(KEYS.records, state.records);
      store.set(KEYS.teachers, state.teachers);
      store.set(KEYS.settings, state.settings);
      $("firstRun").style.display='none';
      toast('تم استيراد النسخة الاحتياطية.');
      ensureReady();
    }catch(e){ toast('تعذر استيراد النسخة: '+(e&&e.message?e.message:e)); }
  };
  inp.click();
}

function pickTeacher(){
  const q=safeText($("teacherName").value).toLowerCase();
  if(!q) return toast('اكتب جزءًا من اسم المعلم للبحث.');
  const c=state.teachers.filter(t=>(t.name||'').toLowerCase().includes(q));
  if(!c.length) return toast('لا يوجد معلم مطابق. يمكنك حفظه.');
  $("teacherName").value = c[0].name || '';
  $("teacherPhone").value = c[0].phone || '';
  refreshTeacherSelect();
  $("teacherSelect").value = c[0].name || '';
  toast('تم اختيار: '+(c[0].name||''));
}

function saveTeacher(){
  const name=safeText($("teacherName").value);
  const phone=normalizePhone($("teacherPhone").value);
  if(!name || !phone) return toast('أدخل اسم المعلم ورقم واتساب صحيح.');
  const ex=state.teachers.find(t=>(t.name||'').trim()===name);
  if(ex) ex.phone=phone; else state.teachers.push({id:uid('T'), name, phone});
  store.set(KEYS.teachers, state.teachers);
  refreshTeacherSelect();
  $("teacherSelect").value = name;
  toast('تم حفظ المعلم.');
}

/* ===== Menu sheet ===== */
function openMenuSheet(){
  $("sheetTitle").textContent='القائمة';

  $("scanBox").style.display='none';
  $("reportBox").style.display='none';
  $("afterSave").style.display='none';
  $("archiveBox").style.display='none';
  $("saveBtn").style.display='none';
  $("typeBox").style.display='none';
  $("whenRow").style.display='none';
  $("noteBox").style.display='none';
  $("profileBox").style.display='none';
  $("editStudentBox").style.display='none';
  $("recipientsBox").style.display='none';
  $("teacherBox").style.display='none';

  $("chipsBox").style.display='block';
  $("chipsLabel").textContent='خيارات';
  $("chips").innerHTML = `
    <button class="chip" type="button" id="mLoad">تحميل بيانات الطلاب</button>
    <button class="chip" type="button" id="mImport">استيراد بيانات</button>
    <button class="chip" type="button" id="mBackup">تنزيل نسخة احتياطية</button>
    <button class="chip" type="button" id="mShare">مشاركة النسخة الاحتياطية</button>
    <button class="chip" type="button" id="mRestore">استيراد نسخة احتياطية</button>
  `;
  $("backdrop").classList.add('show');

  $("mLoad").onclick = ()=>{
    state.students = normalizeStudents(EMBEDDED_STUDENTS);
    store.set(KEYS.students, state.students);
    $("firstRun").style.display='none';
    toast('تم تحميل البيانات: '+state.students.length);
    ensureReady();
    closeSheet();
  };
  $("mImport").onclick = ()=>importStudents();
  $("mBackup").onclick = ()=>exportBackup();
  $("mShare").onclick = ()=>shareBackup();
  $("mRestore").onclick = ()=>restoreBackup();
}

/* ===== Wire ===== */
function wire(){
  $("menuBtn").innerHTML = icon('dots');
  $("searchIcon").innerHTML = icon('search');
  $("closeBtn").innerHTML = icon('close');

  $("menuBtn").onclick = openMenuSheet;
  $("closeBtn").onclick = closeSheet;
  $("backdrop").addEventListener('click',(e)=>{ if(e.target.id==='backdrop') closeSheet(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeSheet(); });

  $("q").addEventListener('input',(e)=>{
    state.q = e.target.value;
    if(safeText(state.q).length>=2){
      setListVisible(true);
      renderList();
    } else {
      setListVisible(false);
      state.selectedSids=new Set();
      updateSelectionUI();
    }
    ensureReady();
  });

  $("toggleListBtn").onclick = ()=>{
    if(safeText(state.q).length<2) return toast('اكتب حرفين فأكثر لعرض النتائج.');
    setListVisible(!state.listVisible);
  };
  $("hideListBtn").onclick = ()=>setListVisible(false);

  $("selectAllBtn").onclick = ()=>selectAllCurrent();
  $("clearSelBtn").onclick = ()=>clearSelection();

$("reportBtn").onclick = ()=>{
  const choice = confirm('طباعة تقرير التأخر لليوم؟ اضغط (موافق) للتأخر، أو (إلغاء) للغياب.');
  printDaily(choice ? "late" : "absent");
};

  // stage/section optional
  $("sectionSelect").addEventListener('change',(e)=>{
    state.section = e.target.value || '';
    if(state.listVisible) renderList();
    ensureReady();
  });

  $("sheetA4Btn").onclick = ()=>{
    const choice = confirm('طباعة كشف الغياب؟ اضغط (موافق) للغياب، أو (إلغاء) لكشف التأخر.');
    buildA4SectionSheet(choice?'absent':'late');
  };

  $("scanBtn").onclick = ()=>openScanSession();

  // bulk actionbar
  $("bulkLate").onclick = ()=>openBulkAction('late');
  $("bulkAbsent").onclick = ()=>openBulkAction('absent');
  $("bulkBehavior").onclick = ()=>openBulkAction('behavior');
  $("bulkPermit").onclick = ()=>openBulkAction('permit');

  // save in sheet
  $("saveBtn").onclick = ()=>saveRecordsAndPreview();
  $("pickTeacherBtn").onclick = ()=>pickTeacher();
  $("saveTeacherBtn").onclick = ()=>saveTeacher();

    const _ts=$("teacherSelect"); if(_ts) _ts.onchange = ()=>fillTeacherFromSelect();
  refreshTeacherSelect();

  // first run buttons
  $("loadEmbeddedBtn").onclick = ()=>{
    state.students = normalizeStudents(EMBEDDED_STUDENTS);
    store.set(KEYS.students, state.students);
    $("firstRun").style.display='none';
    toast('تم تحميل البيانات: '+state.students.length);
    ensureReady();
  };
  $("importBtn").onclick = ()=>importStudents();

  renderQuickSeg();
  renderStageSeg();
}

function openBulkAction(kind){
  if(state.selectedSids.size===0) return toast('اختر طلابًا أولاً.');
  // فتح sheet في وضع bulk
  let k='attendance', preset='';
  if(kind==='late'){ k='attendance'; preset='تأخر صباحي'; }
  else if(kind==='absent'){ k='attendance'; preset='غياب (بدون عذر)'; }
  else if(kind==='behavior'){ k='behavior'; preset='تنبيه سلوكي داخل الحصة'; }
  else { k='permit'; preset='إذن دخول الفصل'; }

  $("sheetKind").value='';
  state.profileSid='';
  // bulk mode
  openSheet(k, 'bulk', '', preset);
}

/* ===== طباعة المخالفة: ورقة طالب صغيرة + نموذج رسمي (A4) ===== */
function printBehaviorSlip(st, when, note, meta){
  const d=describeStudent(st);
  const info=nowInfo();
  const school=safeText(state.settings?.schoolName||'');
  const deg = meta?.degree ? (BEHAVIOR_DEGREE_LABEL[String(meta.degree)]||meta.degree) : '';
  const deductTxt = (meta && typeof meta.deduct==='number') ? (meta.deduct>0?`(${meta.deduct})`:'—') : '—';

  const html = `
    <style>
      @page{size:80mm 140mm; margin:4mm;}
      .slip{font-family:Tajawal,system-ui; font-size:12px; line-height:1.55; direction:rtl}
      .slip .h{font-weight:900; text-align:center; margin-bottom:6px}
      .slip .sub{opacity:.85; text-align:center; margin-bottom:10px}
      .slip .row{display:flex; justify-content:space-between; gap:8px; margin:4px 0}
      .slip .k{opacity:.8}
      .slip .box{border:1px solid #e6f1ee; border-radius:10px; padding:8px; margin-top:8px}
      .slip .foot{margin-top:10px; font-size:11px; opacity:.85}
    </style>
    <div class="slip">
      <div class="h">${school}</div>
      <div class="sub">ورقة إشعار مخالفة سلوكية (للإطلاع)</div>

      <div class="row"><span class="k">الطالب</span><span><b>${safeText(st.name||'—')}</b></span></div>
      <div class="row"><span class="k">الصف/الشعبة</span><span>${safeText(d.full||'—')}</span></div>
      <div class="row"><span class="k">الهوية</span><span>${safeText(barcodeValue(st)||'—')}</span></div>

      <div class="box">
        <div class="row"><span class="k">الدرجة</span><span>${deg||'—'} (${safeText(meta?.level||'—')})</span></div>
        <div class="row"><span class="k">المخالفة</span><span>${safeText(meta?.infraction||'—')}</span></div>
        <div class="row"><span class="k">الحسم</span><span><b>${deductTxt}</b></span></div>
      </div>

      <div class="foot">
        <div>الوقت: ${safeText(when||info.date+' '+info.time)}</div>
        ${note?`<div>ملاحظة: ${safeText(note)}</div>`:''}
        <div style="margin-top:6px">ولي الأمر: ${safeText(st.phone||'—')}</div>
      </div>
    </div>
  `;
  $("printArea").innerHTML = html;
  setTimeout(()=>window.print(), 80);
}

function printBehaviorA4(st, when, note, meta){
  const d=describeStudent(st);
  const info=nowInfo();
  const school=safeText(state.settings?.schoolName||'');
  const deg = meta?.degree ? (BEHAVIOR_DEGREE_LABEL[String(meta.degree)]||meta.degree) : '';
  const deductTxt = (meta && typeof meta.deduct==='number')
    ? (meta.deduct>0?`(${meta.deduct})`:'لا يوجد (أول مرة/بدون تكرار)')
    : '—';

  const html = `
    <style>
      @page{size:A4; margin:12mm;}
      .a4{font-family:Tajawal,system-ui; direction:rtl; font-size:14px; line-height:1.7}
      .a4 .h{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px}
      .a4 .h .school{font-weight:900; font-size:16px}
      .a4 .h .meta{opacity:.85; font-size:12px; text-align:left}
      .a4 .title{font-weight:900; text-align:center; font-size:16px; margin:8px 0 12px}
      .a4 table{width:100%; border-collapse:collapse}
      .a4 td,.a4 th{border:1px solid #e6f1ee; padding:10px; vertical-align:top}
      .a4 th{background:#f5fbf9; font-weight:900; white-space:nowrap; width:190px}
      .a4 .sign{display:flex; justify-content:space-between; gap:20px; margin-top:18px}
      .a4 .sign .box{border:1px solid #e6f1ee; border-radius:12px; padding:12px; width:48%}
      .a4 .sign .lbl{font-weight:900; margin-bottom:22px}
      .a4 .small{opacity:.85; font-size:12px}
    </style>
    <div class="a4">
      <div class="h">
        <div class="school">${school}</div>
        <div class="meta">${info.day} • ${info.date} • ${info.time}</div>
      </div>

      <div class="title">نموذج رصد مخالفة سلوكية</div>

      <table>
        <tr><th>اسم الطالب</th><td><b>${safeText(st.name||'—')}</b></td></tr>
        <tr><th>الصف/الشعبة</th><td>${safeText(d.full||'—')}</td></tr>
        <tr><th>رقم الهوية</th><td>${safeText(barcodeValue(st)||'—')}</td></tr>
        <tr><th>رقم جوال ولي الأمر</th><td>${safeText(st.phone||'—')}</td></tr>
        <tr><th>الدرجة/المستوى</th><td>الدرجة ${deg||'—'} — ${safeText(meta?.level||'—')}</td></tr>
        <tr><th>المخالفة</th><td>${safeText(meta?.infraction||'—')}</td></tr>
        <tr><th>مقدار الحسم</th><td><b>${deductTxt}</b></td></tr>
        <tr><th>الوقت</th><td>${safeText(when||info.date+' '+info.time)}</td></tr>
        ${note?`<tr><th>ملاحظة</th><td>${safeText(note)}</td></tr>`:''}
      </table>

      <div class="sign">
        <div class="box">
          <div class="lbl">ولي الأمر</div>
          <div class="small">الاسم/التوقيع:</div>
        </div>
        <div class="box">
          <div class="lbl">إدارة المدرسة</div>
          <div class="small">الاسم/التوقيع:</div>
        </div>
      </div>
    </div>
  `;
  $("printArea").innerHTML = html;
  setTimeout(()=>window.print(), 80);
}

function printArchiveA4(st, rows){
  const d=describeStudent(st);
  const info=nowInfo();
  const school=safeText(state.settings?.schoolName||'');
  const head = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:10px">
      <div style="font-weight:900;font-size:16px">${school}</div>
      <div style="opacity:.85;font-size:12px">${info.day} • ${info.date} • ${info.time}</div>
    </div>
    <div style="font-weight:900;text-align:center;font-size:16px;margin:6px 0 14px">أرشيف الطالب</div>
    <div style="opacity:.9;margin-bottom:12px">
      <b>${safeText(st.name||'—')}</b> — ${safeText(d.full||'')} • الهوية: ${safeText(barcodeValue(st)||'—')} • ولي الأمر: ${safeText(st.phone||'—')}
    </div>
  `;

  const body = (rows||[]).length ? rows.map((r,i)=>{
    const tag = (r.kind==='attendance'?'مواظبة':(r.kind==='behavior'?'سلوك':'إذن'));
    const to = (r.to==='teacher'?'معلم':'ولي أمر');
    const deduct = (r.meta && typeof r.meta.deduct==='number' && r.kind==='behavior') ? (r.meta.deduct||0) : '';
    return `
      <tr>
        <td>${i+1}</td>
        <td>${safeText(r.when||'')}</td>
        <td>${tag}</td>
        <td>${safeText(r.subtype||'')}</td>
        <td>${to}</td>
        <td>${deduct!=='' ? ('('+deduct+')') : '—'}</td>
      </tr>
    `;
  }).join('') : `<tr><td colspan="6">لا يوجد سجلات بعد.</td></tr>`;

  const html = `
    <style>
      @page{size:A4; margin:12mm;}
      .a4{font-family:Tajawal,system-ui; direction:rtl; font-size:13px; line-height:1.7}
      table{width:100%; border-collapse:collapse}
      th,td{border:1px solid #e6f1ee; padding:8px 10px; vertical-align:top; text-align:right}
      th{background:#f5fbf9; font-weight:900; white-space:nowrap}
    </style>
    <div class="a4">
      ${head}
      <table>
        <thead>
          <tr>
            <th style="width:50px">#</th>
            <th style="width:210px">التاريخ/الوقت</th>
            <th style="width:100px">التصنيف</th>
            <th>التفصيل</th>
            <th style="width:90px">الجهة</th>
            <th style="width:90px">الحسم</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;
  $("printArea").innerHTML = html;
  setTimeout(()=>window.print(), 80);
}

function init(){
  state.students = store.get(KEYS.students, []);
  if(!Array.isArray(state.students)) state.students = [];
  state.records  = store.get(KEYS.records, []);
  if(!Array.isArray(state.records)) state.records = [];
  state.teachers = store.get(KEYS.teachers, []);
  if(!Array.isArray(state.teachers)) state.teachers = [];
  seedTeachersFromPreloaded();
  refreshTeacherSelect();
  state.settings = store.get(KEYS.settings, state.settings);
  const info=nowInfo();
  $("todayPill").textContent = info.day + ' • ' + info.date;

  const have = Array.isArray(state.students) && state.students.length>0;
  $("firstRun").style.display = have? 'none':'block';

  ensureReady();
  updateSelectionUI();

}

document.addEventListener('DOMContentLoaded',()=>{ wire(); init(); });
</script>
</body>
</html>
