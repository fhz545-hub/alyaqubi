# اليعقوبي – تطبيق شؤون الطلاب (PWA)

تطبيق ويب يعمل **بدون إنترنت** لمتابعة **المواظبة والسلوك** للطلاب، مع:
- بحث سريع بالاسم/الهوية
- كشف شعبة كامل في صفحة واحدة (A4 أفقي) + **باركود الهوية (Code39)**
- طباعة كرت دخول/خروج وكرت مخالفة سلوكية (مناسب للطابعات الحرارية)
- SMS عبر وسيط Cloudflare Worker (اختياري)
- **مزامنة سحابية** (اختياري) لتوحيد السجلات بين المستخدمين المصرّح لهم، عبر Tokens

---

## 1) التشغيل محليًا
افتح `index.html` من أي سيرفر ثابت (أفضل) أو GitHub Pages.

> ملاحظة: بعض المتصفحات تمنع بعض ميزات PWA إن فُتح الملف مباشرة من القرص. استخدم GitHub Pages أو أي سيرفر محلي.

---

## 2) التثبيت كتطبيق (PWA)
- على iPhone: Safari → مشاركة → **إضافة إلى الشاشة الرئيسية**
- على Chrome (كمبيوتر/أندرويد): من شريط العنوان → **Install**

---

## 3) استيراد الطلاب
من الإعدادات → **استيراد CSV**.
الحقول المطلوبة في CSV:
- `اسم الطالب`
- `رقم الطالب` (الهوية)
- `الجوال` (اختياري)
- `رقم الصف`
- `الفصل` (الشعبة)

---

## 4) SMS (اختياري) عبر Cloudflare Worker
### الفكرة
لا تضع توكن مزود الرسائل داخل GitHub أو داخل التطبيق. نستخدم وسيط Worker يحمي التوكن.

### الخطوات
1. أنشئ Cloudflare Worker وضع كود `cloudflare-worker.js`.
2. ضع متغيرات Secrets داخل Cloudflare (مثال):
   - `SMS_BASE_URL` = `https://app.mobile.net.sa/api/v1`
   - `SMS_BEARER_TOKEN` = (توكن Mobile.net.sa)
   - `PROXY_KEY` = مفتاح حماية تختاره
3. في التطبيق (الإعدادات → SMS):
   - Proxy URL: رابط الـ Worker
   - Proxy Key: نفس `PROXY_KEY`
   - Sender Name: مثل `Mobile.SA`

---

## 5) المزامنة السحابية (Cloud Sync) عبر Cloudflare Worker + D1
### لماذا؟
حتى أي تسجيل (تأخر/غياب/سلوك/تعديل بيانات) يظهر لدى جميع المستخدمين المصرّح لهم.

### الإعداد مرة واحدة (على Cloudflare)
1. أنشئ D1 Database.
2. نفّذ ملف `schema.sql` داخل D1.
3. أنشئ Worker جديد وضع كود `cloudflare-sync-worker.js`.
4. اربط الـ Worker بقاعدة D1 على Binding اسمها: `DB`.
5. (اختياري) حدّد `ALLOWED_ORIGINS` مثل:
   - `https://<username>.github.io`

### إنشاء المستخدمين (Tokens)
- سجّل دخول كـ **Admin** (توكن أدمن) ثم من الإعدادات → **إدارة المستخدمين** → أنشئ Token لكل مستخدم.
- كل مستخدم يضع:
  - Cloud URL: رابط Worker
  - Token: التوكن المخصص له

> ملاحظة: التوكن يظهر مرة واحدة عند الإنشاء – احفظه في مكان آمن.

---

## 6) النسخ الاحتياطي
من الإعدادات:
- تصدير نسخة احتياطية (JSON)
- استيراد نسخة احتياطية

---

## ملاحظات تربوية
استخدم التطبيق كأداة توثيق داخلية، وراعِ تطبيق الإجراءات المتدرجة حسب **قواعد السلوك والمواظبة** المعتمدة.

